<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Müşteri Listesi - IHSAN AI</title>
  <link rel="stylesheet" href="../../assets/css/main.css">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
  <div class="gradient-mesh"></div>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar"></aside>

    <!-- Main Content -->
    <main class="main-content">
      <nav class="navbar">
        <div class="navbar-left">
          <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Menü">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </button>
          <div class="navbar-breadcrumb">
            <span class="breadcrumb-item">Yönetim</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Müşteri Listesi</span>
          </div>
          <div class="navbar-search">
            <svg class="navbar-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" placeholder="Müşteri ara (TC, ad, telefon)...">
          </div>
        </div>
        <div class="navbar-right">
          <button class="navbar-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 01-3.46 0"/>
            </svg>
            <span class="badge">3</span>
          </button>
          <div class="navbar-divider"></div>
          <div class="navbar-user">
            <div class="navbar-avatar"></div>
            <div class="navbar-user-info">
              <div class="navbar-user-name">Yükleniyor...</div>
              <div class="navbar-user-role"></div>
            </div>
          </div>
        </div>
      </nav>

      <!-- Page Wrapper -->
      <div class="page-wrapper">
        <div class="page-content">
        <div class="page-header">
          <div>
            <h1 class="page-title">Müşterilerimiz</h1>
            <p class="page-subtitle">Tüm müşteri kayıtlarını görüntüleyin ve yönetin</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Excel İndir
            </button>
            <button class="btn btn-primary" onclick="openAddModal()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
              </svg>
              Yeni Müşteri
            </button>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card stat-cyan">
            <div class="stat-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                <path d="M16 3.13a4 4 0 010 7.75"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value font-mono">-</div>
              <div class="stat-label">Toplam Müşteri</div>
            </div>
          </div>
          <div class="stat-card stat-emerald">
            <div class="stat-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value font-mono">-</div>
              <div class="stat-label">Bireysel</div>
            </div>
          </div>
          <div class="stat-card stat-violet">
            <div class="stat-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                <polyline points="9,22 9,12 15,12 15,22"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value font-mono">-</div>
              <div class="stat-label">Kurumsal</div>
            </div>
          </div>
          <div class="stat-card stat-amber">
            <div class="stat-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value font-mono">-</div>
              <div class="stat-label">Bu Ay Yeni</div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="card" style="margin-bottom: 1.5rem;">
          <div class="card-body">
            <div class="filter-row">
              <select class="form-select">
                <option value="">Tüm Tipler</option>
                <option value="bireysel">Bireysel</option>
                <option value="kurumsal">Kurumsal</option>
              </select>
              <input type="text" class="form-input filter-input-flex" placeholder="TC / VKN">
              <input type="text" class="form-input filter-input-flex" placeholder="Ad Soyad / Ünvan">
              <button class="btn btn-secondary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"/>
                </svg>
                Filtrele
              </button>
              <button class="btn btn-ghost">Temizle</button>
            </div>
          </div>
        </div>

        <!-- Customers Table -->
        <div class="card">
          <div class="card-body" style="padding: 0;">
            <div class="table-container">
              <table class="data-table mobile-cards">
                <thead>
                  <tr>
                    <th>Müşteri</th>
                    <th>TC / VKN</th>
                    <th>İletişim</th>
                    <th>Tip</th>
                    <th>Poliçe</th>
                    <th>Toplam Prim</th>
                    <th>İşlemler</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem;">
                      <div style="color: var(--text-tertiary);">Yükleniyor...</div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer">
            <div class="pagination">
              <div class="pagination-info">Yükleniyor...</div>
              <div class="pagination-pages">
                <button class="pagination-btn" disabled>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15,18 9,12 15,6"/></svg>
                </button>
                <button class="pagination-btn active">1</button>
                <button class="pagination-btn">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,18 15,12 9,6"/></svg>
                </button>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add/Edit Customer Modal -->
  <div class="modal-overlay" id="addCustomerModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Yeni Müşteri Ekle</h3>
        <button class="modal-close" onclick="closeCustomerModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="customerForm">
          <input type="hidden" id="customerId">
          <div class="form-group">
            <label class="form-label">Müşteri Tipi <span class="text-danger">*</span></label>
            <select class="form-select" id="customerType" required>
              <option value="1">Bireysel</option>
              <option value="2">Kurumsal</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">TC Kimlik No / VKN <span class="text-danger">*</span></label>
              <input type="text" class="form-input" id="tcVkn" placeholder="11 haneli TC veya 10 haneli VKN" required>
            </div>
            <div class="form-group">
              <label class="form-label">Ad Soyad / Ünvan <span class="text-danger">*</span></label>
              <input type="text" class="form-input" id="customerName" placeholder="Ad Soyad veya Şirket Ünvanı" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Telefon <span class="text-danger">*</span></label>
              <input type="tel" class="form-input" id="phone" placeholder="05XX XXX XX XX" required>
            </div>
            <div class="form-group">
              <label class="form-label">E-posta</label>
              <input type="email" class="form-input" id="email" placeholder="ornek@email.com">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Adres</label>
            <textarea class="form-textarea" id="address" rows="2" placeholder="Tam adres"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCustomerModal()">İptal</button>
        <button class="btn btn-primary" onclick="saveCustomer()">Müşteriyi Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteConfirmModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Müşteri Sil</h3>
        <button class="modal-close" onclick="closeDeleteModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p>Bu müşteriyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
        <input type="hidden" id="deleteCustomerId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">İptal</button>
        <button class="btn btn-primary" style="background: #ef4444;" onclick="confirmDelete()">Sil</button>
      </div>
    </div>
  </div>

  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/app.js"></script>
  <script src="../../components/sidebar.js"></script>

  <script>
    // ═══════════════════════════════════════════════════════════════
    // CUSTOMER LIST PAGE - JAVASCRIPT
    // ═══════════════════════════════════════════════════════════════

    // State
    let allCustomers = [];
    let filteredCustomers = [];
    let currentPage = 1;
    const pageSize = 10;
    let editingCustomerId = null;

    // ═══════════════════════════════════════════════════════════════
    // INITIALIZATION
    // ═══════════════════════════════════════════════════════════════

    document.addEventListener('DOMContentLoaded', async function() {
      // Check authentication
      if (!APP_CONFIG.AUTH.getUser()) {
        APP_CONFIG.AUTH.redirectToLogin();
        return;
      }

      // Check permission
      requirePermission('musterileriGorebilsin');

      // Load data
      await Promise.all([
        loadCustomers(),
        loadStats()
      ]);

      // Setup event listeners
      setupEventListeners();
    });

    // ═══════════════════════════════════════════════════════════════
    // DATA LOADING
    // ═══════════════════════════════════════════════════════════════

    async function loadCustomers() {
      try {
        const customers = await apiGet('customers', { limit: 1000 });
        allCustomers = customers;
        filteredCustomers = [...customers];
        renderCustomers();
      } catch (error) {
        console.error('Müşteriler yüklenirken hata:', error);
        showToast('Müşteriler yüklenirken hata oluştu', 'error');
      }
    }

    async function loadStats() {
      try {
        const stats = await apiGet('customers/stats');
        updateStats(stats);
      } catch (error) {
        console.error('İstatistikler yüklenirken hata:', error);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // RENDERING
    // ═══════════════════════════════════════════════════════════════

    function renderCustomers() {
      const tbody = document.querySelector('.data-table tbody');
      if (!tbody) return;

      // Calculate pagination
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageCustomers = filteredCustomers.slice(startIndex, endIndex);

      if (pageCustomers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 2rem;">
              <div style="color: var(--text-tertiary);">Müşteri bulunamadı</div>
            </td>
          </tr>
        `;
        renderPagination();
        return;
      }

      tbody.innerHTML = pageCustomers.map(customer => {
        const isKurumsal = customer.sahipTuru === 2;
        const displayName = isKurumsal
          ? customer.adi
          : `${customer.adi || ''} ${customer.soyadi || ''}`.trim();
        const initials = getInitials(displayName);
        const avatarColor = getAvatarColor(customer.id);
        const tcVkn = customer.tcKimlikNo || customer.vergiNo || '-';
        const registerDate = customer.eklenmeZamani
          ? new Date(customer.eklenmeZamani).toLocaleDateString('tr-TR')
          : '-';
        const toplamPrim = formatCurrency(customer.toplamPrim || 0);

        return `
          <tr data-id="${customer.id}">
            <td>
              <div class="flex items-center gap-3">
                <div class="avatar avatar-sm ${avatarColor}">${initials}</div>
                <div>
                  <div class="cell-main">${escapeHtml(displayName)}</div>
                  <div class="cell-sub">Kayıt: ${registerDate}</div>
                </div>
              </div>
            </td>
            <td><span class="font-mono">${escapeHtml(tcVkn)}</span></td>
            <td>
              <div class="cell-main">${escapeHtml(customer.gsm || '-')}</div>
              <div class="cell-sub">${escapeHtml(customer.email || '-')}</div>
            </td>
            <td><span class="badge ${isKurumsal ? 'badge-neutral' : 'badge-info'}">${isKurumsal ? 'Kurumsal' : 'Bireysel'}</span></td>
            <td><span class="font-semibold">${customer.policeSayisi || 0}</span></td>
            <td><span class="font-mono font-semibold">${toplamPrim}</span></td>
            <td>
              <div class="table-actions">
                <a href="detail.html?id=${customer.id}" class="btn btn-icon btn-ghost" title="Detay">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </a>
                <button class="btn btn-icon btn-ghost" title="Düzenle" onclick="editCustomer(${customer.id})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <button class="btn btn-icon btn-ghost" title="Sil" onclick="deleteCustomer(${customer.id})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/></svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      renderPagination();
    }

    function renderPagination() {
      const paginationInfo = document.querySelector('.pagination-info');
      const paginationPages = document.querySelector('.pagination-pages');

      const totalCount = filteredCustomers.length;
      const totalPages = Math.ceil(totalCount / pageSize);
      const startIndex = (currentPage - 1) * pageSize + 1;
      const endIndex = Math.min(currentPage * pageSize, totalCount);

      if (paginationInfo) {
        paginationInfo.textContent = totalCount > 0
          ? `Toplam ${totalCount.toLocaleString('tr-TR')} kayıttan ${startIndex}-${endIndex} arası gösteriliyor`
          : 'Kayıt bulunamadı';
      }

      if (paginationPages) {
        let pagesHtml = `
          <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15,18 9,12 15,6"/></svg>
          </button>
        `;

        // Generate page buttons
        const pages = getPageNumbers(currentPage, totalPages);
        pages.forEach(page => {
          if (page === '...') {
            pagesHtml += `<button class="pagination-btn" disabled>...</button>`;
          } else {
            pagesHtml += `<button class="pagination-btn ${page === currentPage ? 'active' : ''}" onclick="goToPage(${page})">${page}</button>`;
          }
        });

        pagesHtml += `
          <button class="pagination-btn" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,18 15,12 9,6"/></svg>
          </button>
        `;

        paginationPages.innerHTML = pagesHtml;
      }
    }

    function getPageNumbers(current, total) {
      if (total <= 7) {
        return Array.from({length: total}, (_, i) => i + 1);
      }

      if (current <= 3) {
        return [1, 2, 3, 4, '...', total];
      }

      if (current >= total - 2) {
        return [1, '...', total - 3, total - 2, total - 1, total];
      }

      return [1, '...', current - 1, current, current + 1, '...', total];
    }

    function goToPage(page) {
      const totalPages = Math.ceil(filteredCustomers.length / pageSize);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderCustomers();
    }

    function updateStats(stats) {
      const statCards = document.querySelectorAll('.stat-card .stat-value');
      if (statCards.length >= 4) {
        statCards[0].textContent = (stats.toplamMusteriSayisi || 0).toLocaleString('tr-TR');
        statCards[1].textContent = (stats.bireyselMusteriSayisi || 0).toLocaleString('tr-TR');
        statCards[2].textContent = (stats.kurumsalMusteriSayisi || 0).toLocaleString('tr-TR');
        statCards[3].textContent = (stats.buAyYeniMusteriSayisi || 0).toLocaleString('tr-TR');
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // FILTERING & SEARCH
    // ═══════════════════════════════════════════════════════════════

    function setupEventListeners() {
      // Type filter
      const typeFilter = document.querySelector('.filter-row .form-select');
      if (typeFilter) {
        typeFilter.addEventListener('change', applyFilters);
      }

      // Filter inputs
      const filterInputs = document.querySelectorAll('.filter-row .form-input');
      filterInputs.forEach(input => {
        input.addEventListener('input', debounce(applyFilters, 300));
      });

      // Filter button
      const filterBtn = document.querySelector('.filter-row .btn-secondary');
      if (filterBtn) {
        filterBtn.addEventListener('click', applyFilters);
      }

      // Clear filter button
      const clearBtn = document.querySelector('.filter-row .btn-ghost');
      if (clearBtn) {
        clearBtn.addEventListener('click', clearFilters);
      }

      // Navbar search
      const navbarSearch = document.querySelector('.navbar-search input');
      if (navbarSearch) {
        navbarSearch.addEventListener('input', debounce(searchCustomers, 300));
      }
    }

    function applyFilters() {
      const typeFilter = document.querySelector('.filter-row .form-select');
      const filterInputs = document.querySelectorAll('.filter-row .form-input');

      const type = typeFilter?.value || '';
      const tcVkn = filterInputs[0]?.value?.toLowerCase() || '';
      const name = filterInputs[1]?.value?.toLowerCase() || '';

      filteredCustomers = allCustomers.filter(customer => {
        // Type filter
        if (type === 'bireysel' && customer.sahipTuru !== 1) return false;
        if (type === 'kurumsal' && customer.sahipTuru !== 2) return false;

        // TC/VKN filter
        if (tcVkn) {
          const customerTcVkn = (customer.tcKimlikNo || customer.vergiNo || '').toLowerCase();
          if (!customerTcVkn.includes(tcVkn)) return false;
        }

        // Name filter
        if (name) {
          const displayName = `${customer.adi || ''} ${customer.soyadi || ''}`.toLowerCase();
          if (!displayName.includes(name)) return false;
        }

        return true;
      });

      currentPage = 1;
      renderCustomers();
    }

    function clearFilters() {
      const typeFilter = document.querySelector('.filter-row .form-select');
      const filterInputs = document.querySelectorAll('.filter-row .form-input');

      if (typeFilter) typeFilter.value = '';
      filterInputs.forEach(input => input.value = '');

      filteredCustomers = [...allCustomers];
      currentPage = 1;
      renderCustomers();
    }

    function searchCustomers(event) {
      const searchTerm = event.target.value.toLowerCase();

      if (!searchTerm) {
        filteredCustomers = [...allCustomers];
      } else {
        filteredCustomers = allCustomers.filter(customer => {
          const displayName = `${customer.adi || ''} ${customer.soyadi || ''}`.toLowerCase();
          const tcVkn = (customer.tcKimlikNo || customer.vergiNo || '').toLowerCase();
          const phone = (customer.gsm || '').toLowerCase();

          return displayName.includes(searchTerm) ||
                 tcVkn.includes(searchTerm) ||
                 phone.includes(searchTerm);
        });
      }

      currentPage = 1;
      renderCustomers();
    }

    // ═══════════════════════════════════════════════════════════════
    // CRUD OPERATIONS
    // ═══════════════════════════════════════════════════════════════

    function openAddModal() {
      editingCustomerId = null;
      document.getElementById('modalTitle').textContent = 'Yeni Müşteri Ekle';
      document.getElementById('customerForm').reset();
      document.getElementById('customerId').value = '';
      document.getElementById('addCustomerModal').classList.add('active');
    }

    function closeCustomerModal() {
      document.getElementById('addCustomerModal').classList.remove('active');
      editingCustomerId = null;
    }

    async function editCustomer(id) {
      try {
        const customer = await apiGet(`customers/${id}`);
        if (!customer) {
          showToast('Müşteri bulunamadı', 'error');
          return;
        }

        editingCustomerId = id;
        document.getElementById('modalTitle').textContent = 'Müşteri Düzenle';
        document.getElementById('customerId').value = id;
        document.getElementById('customerType').value = customer.sahipTuru || 1;
        document.getElementById('tcVkn').value = customer.tcKimlikNo || customer.vergiNo || '';
        document.getElementById('customerName').value = customer.sahipTuru === 2
          ? customer.adi || ''
          : `${customer.adi || ''} ${customer.soyadi || ''}`.trim();
        document.getElementById('phone').value = customer.gsm || '';
        document.getElementById('email').value = customer.email || '';
        // Address field not in current entity, but form has it

        document.getElementById('addCustomerModal').classList.add('active');
      } catch (error) {
        console.error('Müşteri yüklenirken hata:', error);
        showToast('Müşteri bilgileri yüklenirken hata oluştu', 'error');
      }
    }

    async function saveCustomer() {
      const form = document.getElementById('customerForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const customerType = parseInt(document.getElementById('customerType').value);
      const tcVkn = document.getElementById('tcVkn').value.trim();
      const customerName = document.getElementById('customerName').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();

      // Parse name for bireysel customers
      let adi, soyadi;
      if (customerType === 1) {
        const nameParts = customerName.split(' ');
        soyadi = nameParts.pop() || '';
        adi = nameParts.join(' ') || '';
      } else {
        adi = customerName;
        soyadi = null;
      }

      const user = APP_CONFIG.AUTH.getUser();
      const data = {
        sahipTuru: customerType,
        tcKimlikNo: tcVkn.length === 11 ? tcVkn : null,
        vergiNo: tcVkn.length === 10 ? tcVkn : null,
        adi: adi,
        soyadi: soyadi,
        gsm: phone,
        email: email || null,
        ekleyenFirmaId: user?.firmaId,
        ekleyenUyeId: user?.id,
        ekleyenSubeId: user?.subeId
      };

      try {
        if (editingCustomerId) {
          // Update
          await apiPut(`customers/${editingCustomerId}`, data);
          showToast('Müşteri güncellendi', 'success');
        } else {
          // Create
          await apiPost('customers', data);
          showToast('Müşteri oluşturuldu', 'success');
        }

        closeCustomerModal();
        await Promise.all([loadCustomers(), loadStats()]);
      } catch (error) {
        console.error('Müşteri kaydedilirken hata:', error);
        showToast(error.message || 'Müşteri kaydedilirken hata oluştu', 'error');
      }
    }

    function deleteCustomer(id) {
      document.getElementById('deleteCustomerId').value = id;
      document.getElementById('deleteConfirmModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteConfirmModal').classList.remove('active');
    }

    async function confirmDelete() {
      const id = document.getElementById('deleteCustomerId').value;

      try {
        const result = await apiDelete(`customers/${id}`);
        if (result.success) {
          showToast('Müşteri silindi', 'success');
          closeDeleteModal();
          await Promise.all([loadCustomers(), loadStats()]);
        } else {
          showToast(result.errorMessage || 'Müşteri silinemedi', 'error');
        }
      } catch (error) {
        console.error('Müşteri silinirken hata:', error);
        showToast(error.message || 'Müşteri silinirken hata oluştu', 'error');
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // UTILITY FUNCTIONS
    // ═══════════════════════════════════════════════════════════════

    function getInitials(name) {
      if (!name) return '??';
      const parts = name.trim().split(' ').filter(p => p);
      if (parts.length === 0) return '??';
      if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }

    function getAvatarColor(id) {
      const colors = ['avatar-cyan', 'avatar-emerald', 'avatar-violet', 'avatar-amber', 'avatar-rose'];
      return colors[id % colors.length];
    }

    function formatCurrency(amount) {
      return '₺' + (amount || 0).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  </script>
</body>
</html>
