<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yakalanan Poliçeler - IHSAN AI</title>
  <link rel="stylesheet" href="../../assets/css/main.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
  <!-- Global Config & API Helper -->
  <script src="../../assets/js/config.js"></script>
</head>
<body>
  <div class="gradient-mesh"></div>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar"></aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Navbar -->
      <nav class="navbar">
        <div class="navbar-left">
          <div class="navbar-breadcrumb">
            <span class="breadcrumb-item">Poliçe İşlemleri</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Yakalanan Poliçeler</span>
          </div>
        </div>
        <div class="navbar-right">
          <button class="navbar-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 01-3.46 0"/>
            </svg>
            <span class="badge">3</span>
          </button>
          <div class="navbar-divider"></div>
          <div class="navbar-user">
            <div class="navbar-avatar">AY</div>
            <div class="navbar-user-info">
              <div class="navbar-user-name">Ahmet Yılmaz</div>
              <div class="navbar-user-role">Yönetici</div>
            </div>
          </div>
        </div>
      </nav>

      <!-- Page Wrapper -->
      <div class="page-wrapper">
        <!-- Page Content -->
        <div class="page-content">
          <!-- Page Header with Date Filter -->
          <div class="page-header-extended">
            <div class="page-header-top">
              <div>
                <h1 class="page-title">Yakalanan Poliçeler</h1>
                <p class="page-subtitle">Seçilen dönemde yakalanan poliçeler</p>
              </div>
              <div class="page-actions">
                <button class="btn btn-secondary" onclick="refreshData()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23,4 23,10 17,10"/>
                    <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
                  </svg>
                  Yenile
                </button>
                <button class="btn btn-primary" onclick="sendAllToPool()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14"/>
                    <path d="M12 5l7 7-7 7"/>
                  </svg>
                  Tümünü Havuza Gönder
                </button>
              </div>
            </div>
            <div class="page-header-filter">
              <div class="date-presets" id="datePresets">
                <button type="button" class="date-preset-btn active" data-range="today" onclick="handlePresetClick(this, 'today')">Bugün</button>
                <button type="button" class="date-preset-btn" data-range="yesterday" onclick="handlePresetClick(this, 'yesterday')">Dün</button>
                <button type="button" class="date-preset-btn" data-range="thisWeek" onclick="handlePresetClick(this, 'thisWeek')">Bu Hafta</button>
                <button type="button" class="date-preset-btn" data-range="thisMonth" onclick="handlePresetClick(this, 'thisMonth')">Bu Ay</button>
              </div>
              <div class="date-range-picker" id="dateRangePicker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <input type="text" id="dateRangeInput" placeholder="Tarih aralığı seçin" readonly>
                <svg class="picker-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6,9 12,15 18,9"/>
                </svg>
              </div>
            </div>
          </div>

          <!-- KPI Stats - Modern Design -->
          <!-- KPI değerleri loadKPIStats() ile API'den yüklenir -->
          <div class="kpi-grid mb-4">
            <!-- Bekleyen Poliçe -->
            <div class="kpi-card kpi-amber">
              <div class="kpi-card-bg"></div>
              <div class="kpi-header">
                <div class="kpi-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2v4"/>
                    <path d="M12 18v4"/>
                    <path d="M4.93 4.93l2.83 2.83"/>
                    <path d="M16.24 16.24l2.83 2.83"/>
                    <path d="M2 12h4"/>
                    <path d="M18 12h4"/>
                    <path d="M4.93 19.07l2.83-2.83"/>
                    <path d="M16.24 7.76l2.83-2.83"/>
                  </svg>
                </div>
                <div class="kpi-trend kpi-trend-up">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/>
                    <polyline points="17,6 23,6 23,12"/>
                  </svg>
                  <span>+3</span>
                </div>
              </div>
              <div class="kpi-body">
                <div class="kpi-value" id="statPending">12</div>
                <div class="kpi-label">Bekleyen Poliçe</div>
              </div>
              <div class="kpi-footer">
                <span class="kpi-sub" id="kpiPeriodLabel">Bugün yakalanan poliçeler</span>
              </div>
            </div>

            <!-- Gönderilen -->
            <div class="kpi-card kpi-cyan">
              <div class="kpi-card-bg"></div>
              <div class="kpi-header">
                <div class="kpi-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M9 12l2 2 4-4"/>
                    <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <div class="kpi-trend kpi-trend-up">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/>
                    <polyline points="17,6 23,6 23,12"/>
                  </svg>
                  <span>+24</span>
                </div>
              </div>
              <div class="kpi-body">
                <div class="kpi-value" id="statSent">847</div>
                <div class="kpi-label">Gönderilen</div>
              </div>
              <div class="kpi-footer">
                <span class="kpi-sub" id="kpiSentPeriodLabel">Bugün gönderilen</span>
              </div>
            </div>

            <!-- Prodüktör -->
            <div class="kpi-card kpi-emerald">
              <div class="kpi-card-bg"></div>
              <div class="kpi-header">
                <div class="kpi-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M22 21v-2a4 4 0 00-3-3.87"/>
                    <path d="M16 3.13a4 4 0 010 7.75"/>
                  </svg>
                </div>
                <div class="kpi-badge">Aktif</div>
              </div>
              <div class="kpi-body">
                <div class="kpi-value" id="statProducers">4</div>
                <div class="kpi-label">Prodüktör</div>
              </div>
            </div>

            <!-- Toplam Prim -->
            <div class="kpi-card kpi-violet">
              <div class="kpi-card-bg"></div>
              <div class="kpi-header">
                <div class="kpi-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
                    <path d="M15 8h-4c-1.1 0-2 .9-2 2s.9 2 2 2h2c1.1 0 2 .9 2 2s-.9 2-2 2H9"/>
                    <path d="M12 6v2"/>
                    <path d="M12 16v2"/>
                  </svg>
                </div>
                <div class="kpi-trend kpi-trend-up">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/>
                    <polyline points="17,6 23,6 23,12"/>
                  </svg>
                  <span>%12</span>
                </div>
              </div>
              <div class="kpi-body">
                <div class="kpi-value" id="statPremium">₺156,640</div>
                <div class="kpi-label">Toplam Prim</div>
              </div>
              <div class="kpi-footer">
                <div class="kpi-progress">
                  <div class="kpi-progress-bar" style="width: 72%"></div>
                </div>
                <span class="kpi-sub">Aylık hedefin %72'si</span>
              </div>
            </div>
          </div>

          <!-- Policy List Table -->
          <div class="card" id="policyCard">
            <!-- Permission Bar -->
            <div class="permission-bar" id="permissionBar">
              <div class="permission-info">
                <span class="permission-badge admin" id="permissionBadge">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                  </svg>
                  <span id="permissionLabel">Yönetici</span>
                </span>
                <span class="permission-text" id="permissionText">Tüm alanları düzenleyebilirsiniz</span>
              </div>
              <div class="permission-actions">
                <select id="roleSelector" class="form-select form-select-sm" onchange="changeUserRole(this.value)" style="width: auto;">
                  <option value="admin">Yönetici</option>
                  <option value="editor">Editör</option>
                  <option value="viewer">İzleyici</option>
                </select>
                <button class="edit-mode-toggle" id="editModeToggle" onclick="toggleEditMode()">
                  <span class="toggle-indicator"></span>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                  <span>Düzenleme Modu</span>
                </button>
              </div>
            </div>
            <div class="card-header">
              <div class="card-header-left">
                <h3 class="card-title">Poliçe Listesi</h3>
                <span class="badge badge-warning" id="selectedCount" style="display: none;">0 seçili</span>
              </div>
              <div class="card-header-right">
                <div class="table-search">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                  </svg>
                  <input type="text" id="searchInput" placeholder="Ara..." onkeyup="filterTable()">
                </div>
                <div class="custom-dropdown" id="producerDropdown">
                  <button class="dropdown-trigger" onclick="toggleProducerDropdown(event)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <span id="producerFilterText">Tüm Prodüktörler</span>
                    <svg class="dropdown-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6,9 12,15 18,9"/>
                    </svg>
                  </button>
                  <div class="dropdown-panel" id="producerPanel">
                    <div class="dropdown-search">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                      </svg>
                      <input type="text" id="producerSearchInput" placeholder="Prodüktör ara..." oninput="filterProducerList()">
                    </div>
                    <div class="dropdown-list" id="producerList">
                      <!-- Dinamik olarak doldurulacak -->
                    </div>
                  </div>
                </div>
                <input type="hidden" id="producerFilter" value="">
              </div>
            </div>
            <div class="edit-mode-banner" id="editModeBanner">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
              <span>Düzenleme Modu Aktif — Hücrelere tıklayarak düzenleyin</span>
              <kbd style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">ESC</kbd>
              <span style="font-weight: 400; opacity: 0.9;">ile çıkın</span>
            </div>
            <div class="card-body" style="padding: 0;">
              <div class="table-container">
                <table class="data-table" id="policyTable">
                  <thead>
                    <tr>
                      <th style="width: 40px;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                      </th>
                      <th class="sortable" data-sort="policyNo" onclick="sortTable('policyNo')">
                        Poliçe No
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 15l5 5 5-5"/>
                          <path d="M7 9l5-5 5 5"/>
                        </svg>
                      </th>
                      <th class="sortable" data-sort="customer" onclick="sortTable('customer')">
                        Müşteri
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 15l5 5 5-5"/>
                          <path d="M7 9l5-5 5 5"/>
                        </svg>
                      </th>
                      <th>Tip</th>
                      <th class="sortable" data-sort="netPremium" onclick="sortTable('netPremium')">
                        Net Prim
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 15l5 5 5-5"/>
                          <path d="M7 9l5-5 5 5"/>
                        </svg>
                      </th>
                      <th class="sortable" data-sort="grossPremium" onclick="sortTable('grossPremium')">
                        Brüt Prim
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 15l5 5 5-5"/>
                          <path d="M7 9l5-5 5 5"/>
                        </svg>
                      </th>
                      <th class="sortable" data-sort="producer" onclick="sortTable('producer')">
                        Prodüktör / Şube
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 15l5 5 5-5"/>
                          <path d="M7 9l5-5 5 5"/>
                        </svg>
                      </th>
                      <th class="sortable" data-sort="date" onclick="sortTable('date')">
                        Tarih
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 15l5 5 5-5"/>
                          <path d="M7 9l5-5 5 5"/>
                        </svg>
                      </th>
                      <th style="width: 100px;">İşlem</th>
                    </tr>
                  </thead>
                  <tbody id="policyTableBody">
                    <!-- Dynamic content -->
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card-footer">
              <div class="table-footer-left">
                <button class="btn btn-primary btn-sm" id="sendSelectedBtn" onclick="sendSelectedToPool()" style="display: none;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14"/>
                    <path d="M12 5l7 7-7 7"/>
                  </svg>
                  Seçilenleri Havuza Gönder
                </button>
              </div>
              <div class="table-footer-right">
                <div class="pagination-controls">
                  <div class="page-size-selector">
                    <label>Sayfa başına:</label>
                    <select id="pageSizeSelect" onchange="changePageSize(this.value)">
                      <option value="10">10</option>
                      <option value="20" selected>20</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </div>
                  <span class="table-info" id="tableInfo">1-20 / 20 poliçe</span>
                  <div class="page-navigation">
                    <button class="page-btn" id="prevPageBtn" onclick="prevPage()" disabled>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"/>
                      </svg>
                    </button>
                    <span class="page-numbers" id="pageNumbers"></span>
                    <button class="page-btn" id="nextPageBtn" onclick="nextPage()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Info Alert -->
          <div class="alert alert-info" style="margin-top: 1.5rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="16" x2="12" y2="12"/>
              <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            <div>
              <strong>Otomatik Aktarım Aktif</strong>
              <p style="margin: 0.25rem 0 0 0; opacity: 0.8;">Yakalanan poliçeler Poliçe Havuzu'na aktarılır. Havuzda aktarım dosyalarıyla karşılaştırma yapılır.</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Floating Action Box -->
  <div class="floating-action-box" id="floatingActionBox">
    <div class="fab-header">
      <div class="fab-count">
        <span id="fabCount">0</span>
        <small>poliçe seçildi</small>
      </div>
      <button class="fab-close" onclick="clearSelection()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="fab-stats">
      <div class="fab-stat">
        <span class="fab-stat-value" id="fabTotalPremium">₺0</span>
        <span class="fab-stat-label">Toplam Prim</span>
      </div>
    </div>
    <div class="fab-actions">
      <button class="fab-btn fab-btn-primary" onclick="sendSelectedToPool()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14"/>
          <path d="M12 5l7 7-7 7"/>
        </svg>
        Havuza Gönder
      </button>
      <button class="fab-btn fab-btn-secondary" onclick="viewSelectedPolicies()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        Detayları Gör
      </button>
      <button class="fab-btn fab-btn-outline" onclick="exportSelectedPolicies()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="7,10 12,15 17,10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Excel'e Aktar
      </button>
    </div>
  </div>

  <!-- Save Changes Bar -->
  <div class="save-changes-bar" id="saveChangesBar">
    <span class="changes-count"><span id="changesCount">0</span> değişiklik bekliyor</span>
    <button class="btn btn-secondary btn-sm" onclick="discardAllChanges()">İptal</button>
    <button class="btn btn-primary btn-sm" onclick="saveAllChanges()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
        <polyline points="17,21 17,13 7,13 7,21"/>
        <polyline points="7,3 7,8 15,8"/>
      </svg>
      Tümünü Kaydet
    </button>
  </div>

  <!-- Customer Modal -->
  <div class="modal-overlay" id="customerModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Müşteri Kartı</h3>
        <button class="modal-close" onclick="closeCustomerModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="customerModalBody">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <!-- Producer Modal -->
  <div class="modal-overlay" id="producerModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Prodüktör Bilgisi</h3>
        <button class="modal-close" onclick="closeProducerModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="producerModalBody">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <!-- Branch Modal -->
  <div class="modal-overlay" id="branchModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Şube Bilgisi</h3>
        <button class="modal-close" onclick="closeBranchModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="branchModalBody">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <script src="../../assets/js/app.js"></script>
  <style>
    /* Page Header Extended */
    .page-header-extended {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
    }

    .page-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .page-header-top .page-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .page-header-top .page-subtitle {
      margin: 0.25rem 0 0 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .page-header-filter {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    /* Date Presets */
    .date-presets {
      display: flex;
      gap: 0.5rem;
    }

    .date-preset-btn {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .date-preset-btn:hover {
      color: var(--text-primary);
      border-color: var(--primary);
    }

    .date-preset-btn.active {
      color: #ffffff !important;
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%) !important;
      border-color: #6366f1 !important;
      font-weight: 600 !important;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4), 0 2px 4px rgba(99, 102, 241, 0.2) !important;
      transform: translateY(-1px);
    }

    .date-preset-btn .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(99, 102, 241, 0.3);
      transform: scale(0);
      animation: ripple 0.6s linear;
      pointer-events: none;
    }

    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    /* Date Range Picker */
    .date-range-picker {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .date-range-picker:hover,
    .date-range-picker.active {
      border-color: var(--primary);
    }

    .date-range-picker svg {
      width: 18px;
      height: 18px;
      color: var(--text-muted);
    }

    .date-range-picker input {
      border: none;
      background: transparent;
      font-size: 0.8rem;
      color: var(--text-primary);
      width: 200px;
      cursor: pointer;
    }

    .date-range-picker input:focus {
      outline: none;
    }

    .date-range-picker .picker-arrow {
      width: 14px;
      height: 14px;
      transition: transform 0.2s ease;
    }

    .date-range-picker.active .picker-arrow {
      transform: rotate(180deg);
    }

    /* Card Header */
    .card-header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .card-header-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    /* Table Search */
    .table-search {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    .table-search svg {
      color: var(--text-muted);
    }

    .table-search input {
      border: none;
      background: transparent;
      font-size: 0.8rem;
      color: var(--text-primary);
      width: 150px;
    }

    .table-search input:focus {
      outline: none;
    }

    /* Custom Dropdown */
    .custom-dropdown {
      position: relative;
    }

    .dropdown-trigger {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.8rem;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 160px;
    }

    .dropdown-trigger:hover {
      border-color: var(--primary);
      background: var(--bg-card);
    }

    .dropdown-trigger svg:first-child {
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .dropdown-trigger span {
      flex: 1;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dropdown-arrow {
      color: var(--text-muted);
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }

    .custom-dropdown.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .dropdown-panel {
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      width: 240px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12), 0 4px 12px rgba(0, 0, 0, 0.08);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
    }

    .custom-dropdown.open .dropdown-panel {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-search {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      border-bottom: 1px solid #e2e8f0;
      background: #f8fafc;
      border-radius: 12px 12px 0 0;
    }

    .dropdown-search svg {
      color: #94a3b8;
      flex-shrink: 0;
    }

    .dropdown-search input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 0.8rem;
      color: #1e293b;
      outline: none;
    }

    .dropdown-search input::placeholder {
      color: #94a3b8;
    }

    .dropdown-list {
      max-height: 240px;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .dropdown-list::-webkit-scrollbar {
      width: 6px;
    }

    .dropdown-list::-webkit-scrollbar-track {
      background: #f8fafc;
    }

    .dropdown-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .dropdown-list::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.625rem 0.75rem;
      border-radius: 8px;
      font-size: 0.8rem;
      color: #334155;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .dropdown-item:hover {
      background: #f1f5f9;
    }

    .dropdown-item.selected {
      background: #eef2ff;
      color: #4f46e5;
    }

    .dropdown-item-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }

    .dropdown-item-avatar.all {
      background: linear-gradient(135deg, #64748b, #475569);
    }

    .dropdown-item-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dropdown-item-check {
      opacity: 0;
      color: #6366f1;
      flex-shrink: 0;
    }

    .dropdown-item.selected .dropdown-item-check {
      opacity: 1;
    }

    .dropdown-empty {
      padding: 1.5rem;
      text-align: center;
      color: #94a3b8;
      font-size: 0.8rem;
    }

    /* Table Styles */
    .data-table th.sortable {
      cursor: pointer;
      user-select: none;
    }

    .data-table th.sortable:hover {
      background: var(--bg-elevated);
    }

    .data-table th.sortable svg {
      margin-left: 0.25rem;
      opacity: 0.5;
      vertical-align: middle;
    }

    .data-table th.sortable.asc svg path:first-child,
    .data-table th.sortable.desc svg path:last-child {
      opacity: 1;
      stroke: var(--primary);
    }

    .data-table tbody tr {
      transition: background 0.15s ease;
      cursor: pointer;
    }

    .data-table tbody tr:hover {
      background: var(--bg-elevated);
    }

    .data-table tbody tr.selected {
      background: var(--primary-glow);
    }

    .data-table tbody tr.selected:hover {
      background: rgba(99, 102, 241, 0.15);
    }

    .data-table input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    .data-table tbody input[type="checkbox"] {
      pointer-events: none;
    }

    .data-table thead input[type="checkbox"] {
      pointer-events: auto;
      cursor: pointer;
    }

    .data-table tbody tr td:first-child {
      position: relative;
    }

    .data-table tbody tr td:first-child::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--primary);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .data-table tbody tr.selected td:first-child::before {
      opacity: 1;
    }

    /* Policy Badge */
    .policy-type-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      border-radius: 6px;
    }

    .policy-type-badge.kasko {
      background: rgba(99, 102, 241, 0.15);
      color: #6366f1;
    }

    .policy-type-badge.trafik {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    .policy-type-badge.dask {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .policy-type-badge.saglik {
      background: rgba(236, 72, 153, 0.15);
      color: #ec4899;
    }

    .policy-type-badge.konut {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
    }

    /* Producer Avatar */
    .producer-cell {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .producer-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .producer-avatar.emerald { background: linear-gradient(135deg, #10b981, #059669); }
    .producer-avatar.cyan { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    .producer-avatar.violet { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .producer-avatar.amber { background: linear-gradient(135deg, #f59e0b, #d97706); }

    .producer-info {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .producer-name {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .producer-branch {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    /* Action Buttons */
    .table-actions {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-elevated);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
    }

    .action-btn:hover {
      background: var(--primary-glow);
    }

    .action-btn:hover svg {
      color: var(--primary);
    }

    .action-btn.send:hover {
      background: rgba(16, 185, 129, 0.15);
    }

    .action-btn.send:hover svg {
      color: #10b981;
    }

    /* Card Footer */
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--border-color);
      background: var(--bg-elevated);
      gap: 1rem;
      flex-wrap: wrap;
    }

    .table-footer-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .table-info {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Pagination Controls */
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      flex-wrap: wrap;
    }

    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .page-size-selector label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .page-size-selector select {
      padding: 0.35rem 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .page-size-selector select:hover {
      border-color: var(--primary);
    }

    .page-size-selector select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .page-navigation {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .page-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-card);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .page-btn:hover:not(:disabled) {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }

    .page-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .page-btn svg {
      width: 16px;
      height: 16px;
    }

    .page-numbers {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .page-number {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
      padding: 0 0.5rem;
      border: 1px solid transparent;
      border-radius: 6px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .page-number:hover {
      background: rgba(99, 102, 241, 0.08);
      color: var(--primary);
    }

    .page-number.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .page-ellipsis {
      color: var(--text-muted);
      padding: 0 0.25rem;
    }

    /* Clickable Links in Table */
    .clickable-link {
      color: var(--primary);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.5rem;
      margin: -0.25rem -0.5rem;
      border-radius: 6px;
      background: rgba(99, 102, 241, 0.08);
      border-bottom: 1px dashed rgba(99, 102, 241, 0.4);
    }

    .clickable-link:hover {
      color: #fff;
      background: var(--primary);
      border-bottom-color: transparent;
    }

    .clickable-link svg {
      width: 12px;
      height: 12px;
      opacity: 0.6;
      transition: all 0.2s ease;
    }

    .clickable-link:hover svg {
      opacity: 1;
    }

    .clickable-customer {
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0.25rem 0.5rem;
      margin: -0.25rem -0.5rem;
      border-radius: 6px;
      border-bottom: 1px dashed rgba(99, 102, 241, 0.3);
      position: relative;
    }

    .clickable-customer::after {
      content: '';
      position: absolute;
      right: -4px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      background: var(--primary);
      border-radius: 50%;
      opacity: 0.6;
    }

    .clickable-customer:hover {
      color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      border-bottom-color: var(--primary);
    }

    .clickable-customer:hover::after {
      opacity: 1;
      animation: pulse-dot 1s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { transform: translateY(-50%) scale(1); }
      50% { transform: translateY(-50%) scale(1.3); }
    }

    .clickable-producer {
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0.125rem 0.375rem;
      margin: -0.125rem -0.375rem;
      border-radius: 4px;
      border-bottom: 1px dashed rgba(99, 102, 241, 0.3);
    }

    .clickable-producer:hover {
      color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      border-bottom-color: var(--primary);
    }

    .clickable-branch {
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0.125rem 0.375rem;
      margin: -0.125rem -0.375rem;
      border-radius: 4px;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .clickable-branch::before {
      content: '';
      width: 4px;
      height: 4px;
      background: currentColor;
      border-radius: 50%;
      opacity: 0.5;
    }

    .clickable-branch:hover {
      color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .clickable-branch:hover::before {
      background: var(--primary);
      opacity: 1;
    }

    /* Modal Styles - Apple Glass Effect */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(50px) saturate(200%);
      -webkit-backdrop-filter: blur(50px) saturate(200%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 28px;
      width: 90%;
      max-width: 440px;
      max-height: 90vh;
      overflow: hidden;
      transform: scale(0.9) translateY(20px);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.1) inset,
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 80px rgba(99, 102, 241, 0.15);
      position: relative;
    }

    .modal::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.4) 50%,
        transparent 100%
      );
    }

    .modal::after {
      content: '';
      position: absolute;
      top: 0;
      left: 20%;
      right: 20%;
      height: 2px;
      background: linear-gradient(90deg,
        #6366f1,
        #8b5cf6,
        #ec4899,
        #f59e0b,
        #10b981
      );
      border-radius: 0 0 2px 2px;
      opacity: 0.8;
    }

    .modal-overlay.active .modal {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      margin: 0;
      letter-spacing: -0.02em;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.7);
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .modal-close:hover {
      background: rgba(239, 68, 68, 0.3);
      color: #fff;
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      max-height: calc(90vh - 80px);
    }

    /* Glass Card Content Override */
    .modal .customer-card-found,
    .modal .customer-not-found,
    .modal .info-card {
      color: #fff;
    }

    .modal .customer-card-found h4,
    .modal .customer-not-found h4,
    .modal .info-card-details h4 {
      color: #fff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .modal .customer-tc,
    .modal .customer-not-found p,
    .modal .info-card-details p {
      color: rgba(255, 255, 255, 0.7);
    }

    .modal .customer-avatar-large {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.7), rgba(139, 92, 246, 0.7));
      box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal .customer-stats {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(10px);
    }

    .modal .info-card-stats .info-stat-item {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    .modal .customer-stat-value,
    .modal .info-stat-value {
      color: #fff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .modal .customer-stat-label,
    .modal .info-stat-label {
      color: rgba(255, 255, 255, 0.6);
    }

    .modal .badge-success {
      background: rgba(16, 185, 129, 0.25);
      color: #6ee7b7;
      border: 1px solid rgba(16, 185, 129, 0.4);
      backdrop-filter: blur(10px);
    }

    .modal .empty-icon {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid rgba(245, 158, 11, 0.3);
      backdrop-filter: blur(10px);
    }

    .modal .modal-actions .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }

    .modal .modal-actions .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.18);
      color: #fff;
    }

    .modal .modal-actions .btn-primary {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.8));
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.35);
      backdrop-filter: blur(10px);
    }

    .modal .modal-actions .btn-primary:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.95), rgba(139, 92, 246, 0.95));
      transform: translateY(-1px);
      box-shadow: 0 6px 28px rgba(99, 102, 241, 0.5);
    }

    .modal .info-card-avatar {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    /* Customer Card in Modal */
    .customer-card-found {
      text-align: center;
      padding: 1rem;
    }

    .customer-card-found .customer-avatar-large {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 700;
      color: white;
      margin: 0 auto 1rem;
      background: linear-gradient(135deg, var(--primary), #4f46e5);
    }

    .customer-card-found h4 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 0.25rem 0;
    }

    .customer-card-found .customer-tc {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
      margin-bottom: 1rem;
    }

    .customer-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin: 1rem 0;
      padding: 1rem;
      background: var(--bg-elevated);
      border-radius: 12px;
    }

    .customer-stat {
      text-align: center;
    }

    .customer-stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .customer-stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* Customer Not Found */
    .customer-not-found {
      text-align: center;
      padding: 1rem;
    }

    .customer-not-found .empty-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .customer-not-found h4 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 0.5rem 0;
    }

    .customer-not-found p {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 0 0 1.5rem 0;
    }

    /* Producer/Branch Info */
    .info-card {
      padding: 1rem;
    }

    .info-card-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    .info-card-avatar {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: 700;
      color: white;
    }

    .info-card-details h4 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 0.25rem 0;
    }

    .info-card-details p {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 0;
    }

    .info-card-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .info-stat-item {
      padding: 0.875rem;
      background: var(--bg-elevated);
      border-radius: 10px;
      text-align: center;
    }

    .info-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .info-stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.125rem;
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .modal-actions .btn {
      flex: 1;
    }

    /* ═══════════════════════════════════════════════════════════════
       MODERN KPI CARDS - LIGHT THEME
       ═══════════════════════════════════════════════════════════════ */

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.25rem;
    }

    .kpi-card {
      position: relative;
      background: var(--bg-surface, #ffffff);
      border: 1px solid var(--border-subtle, rgba(148, 163, 184, 0.2));
      border-radius: 20px;
      padding: 1.5rem;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--card-shadow, 0 1px 3px rgba(0, 0, 0, 0.04));
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      border-color: var(--border-default, rgba(148, 163, 184, 0.3));
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08), 0 4px 8px rgba(0, 0, 0, 0.04);
    }

    /* Background glow effect */
    .kpi-card-bg {
      position: absolute;
      top: -50%;
      right: -30%;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.12;
      transition: opacity 0.3s ease;
    }

    .kpi-card:hover .kpi-card-bg {
      opacity: 0.2;
    }

    /* Color variants - Amber */
    .kpi-card.kpi-amber .kpi-card-bg { background: #f59e0b; }
    .kpi-card.kpi-amber .kpi-icon { background: rgba(245, 158, 11, 0.12); color: #d97706; }
    .kpi-card.kpi-amber .kpi-trend { background: rgba(245, 158, 11, 0.1); color: #b45309; }
    .kpi-card.kpi-amber .kpi-value { color: #92400e; }
    .kpi-card.kpi-amber:hover { border-color: rgba(245, 158, 11, 0.3); }

    /* Color variants - Violet */
    .kpi-card.kpi-violet .kpi-card-bg { background: #8b5cf6; }
    .kpi-card.kpi-violet .kpi-icon { background: rgba(139, 92, 246, 0.12); color: #7c3aed; }
    .kpi-card.kpi-violet .kpi-trend { background: rgba(139, 92, 246, 0.1); color: #6d28d9; }
    .kpi-card.kpi-violet .kpi-value { color: #5b21b6; }
    .kpi-card.kpi-violet .kpi-progress-bar { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
    .kpi-card.kpi-violet:hover { border-color: rgba(139, 92, 246, 0.3); }

    /* Color variants - Emerald */
    .kpi-card.kpi-emerald .kpi-card-bg { background: #10b981; }
    .kpi-card.kpi-emerald .kpi-icon { background: rgba(16, 185, 129, 0.12); color: #059669; }
    .kpi-card.kpi-emerald .kpi-badge { background: rgba(16, 185, 129, 0.12); color: #047857; border-color: rgba(16, 185, 129, 0.25); }
    .kpi-card.kpi-emerald .kpi-value { color: #065f46; }
    .kpi-card.kpi-emerald:hover { border-color: rgba(16, 185, 129, 0.3); }

    /* Color variants - Cyan */
    .kpi-card.kpi-cyan .kpi-card-bg { background: #06b6d4; }
    .kpi-card.kpi-cyan .kpi-icon { background: rgba(6, 182, 212, 0.12); color: #0891b2; }
    .kpi-card.kpi-cyan .kpi-trend { background: rgba(6, 182, 212, 0.1); color: #0e7490; }
    .kpi-card.kpi-cyan .kpi-value { color: #155e75; }
    .kpi-card.kpi-cyan:hover { border-color: rgba(6, 182, 212, 0.3); }

    /* Header */
    .kpi-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
      position: relative;
      z-index: 1;
    }

    .kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .kpi-card:hover .kpi-icon {
      transform: scale(1.05);
    }

    .kpi-icon svg {
      width: 24px;
      height: 24px;
    }

    /* Trend indicator */
    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.625rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .kpi-trend svg {
      width: 14px;
      height: 14px;
    }

    .kpi-trend-up { background: rgba(16, 185, 129, 0.1); color: #059669; }
    .kpi-trend-down { background: rgba(239, 68, 68, 0.1); color: #dc2626; }

    /* Badge */
    .kpi-badge {
      padding: 0.375rem 0.75rem;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border: 1px solid;
    }

    /* Body */
    .kpi-body {
      position: relative;
      z-index: 1;
      margin-bottom: 1rem;
    }

    .kpi-value {
      font-size: 2.25rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.1;
      margin-bottom: 0.375rem;
    }

    .kpi-label {
      font-size: 0.85rem;
      color: var(--text-muted, #64748b);
      font-weight: 500;
    }

    /* Footer */
    .kpi-footer {
      position: relative;
      z-index: 1;
      padding-top: 1rem;
      border-top: 1px solid var(--border-subtle, rgba(148, 163, 184, 0.2));
    }

    .kpi-sub {
      font-size: 0.75rem;
      color: var(--text-dim, #94a3b8);
    }

    /* Progress bar */
    .kpi-progress {
      height: 4px;
      background: var(--bg-elevated, #f1f5f9);
      border-radius: 2px;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }

    .kpi-progress-bar {
      height: 100%;
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* Responsive */
    @media (max-width: 1280px) {
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }

      .kpi-card {
        padding: 1.25rem;
      }

      .kpi-value {
        font-size: 1.75rem;
      }
    }

    /* Floating Action Box - Modern Minimalist */
    .floating-action-box {
      position: fixed;
      right: -300px;
      top: 50%;
      transform: translateY(-50%);
      width: 260px;
      background: #1a1b23;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-right: none;
      border-radius: 16px 0 0 16px;
      padding: 1.5rem;
      z-index: 500;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: -8px 0 32px rgba(0, 0, 0, 0.4);
    }

    .floating-action-box.active {
      right: 0;
    }

    .fab-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1.25rem;
    }

    .fab-count {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .fab-count span {
      font-size: 2.5rem;
      font-weight: 800;
      color: #fff;
      line-height: 1;
      letter-spacing: -0.02em;
    }

    .fab-count small {
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 500;
    }

    .fab-close {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      transition: all 0.15s ease;
    }

    .fab-close:hover {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .fab-stats {
      margin-bottom: 1.25rem;
      padding: 1rem;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(99, 102, 241, 0.15);
    }

    .fab-stat {
      text-align: center;
    }

    .fab-stat-value {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      color: #a5b4fc;
      letter-spacing: -0.01em;
    }

    .fab-stat-label {
      display: block;
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .fab-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .fab-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
    }

    .fab-btn svg {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
    }

    .fab-btn-primary {
      background: #10b981;
      color: #fff;
    }

    .fab-btn-primary:hover {
      background: #059669;
      transform: translateY(-1px);
    }

    .fab-btn-secondary {
      background: #374151;
      color: #e5e7eb;
    }

    .fab-btn-secondary:hover {
      background: #4b5563;
    }

    .fab-btn-outline {
      background: transparent;
      color: #9ca3af;
      border: 1px solid #374151;
    }

    .fab-btn-outline:hover {
      background: #374151;
      color: #e5e7eb;
      border-color: #4b5563;
    }

    /* ═══════════════════════════════════════════════════════════════
       EDITABLE FIELDS & PERMISSION SYSTEM
       ═══════════════════════════════════════════════════════════════ */

    /* Permission Indicator Bar */
    .permission-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1.25rem;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border-color);
      font-size: 0.8rem;
    }

    .permission-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .permission-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.75rem;
    }

    .permission-badge.admin {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .permission-badge.editor {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .permission-badge.viewer {
      background: rgba(156, 163, 175, 0.15);
      color: #9ca3af;
      border: 1px solid rgba(156, 163, 175, 0.3);
    }

    .permission-badge svg {
      width: 14px;
      height: 14px;
    }

    .permission-text {
      color: var(--text-muted);
    }

    .permission-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .edit-mode-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .edit-mode-toggle:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
      transform: translateY(-1px);
    }

    .edit-mode-toggle.active {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .edit-mode-toggle.active:hover {
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
      transform: translateY(-2px);
    }

    .edit-mode-toggle svg {
      width: 16px;
      height: 16px;
    }

    .edit-mode-toggle .toggle-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9ca3af;
      transition: all 0.25s ease;
    }

    .edit-mode-toggle.active .toggle-indicator {
      background: #34d399;
      box-shadow: 0 0 8px #34d399;
      animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 8px #34d399; }
      50% { box-shadow: 0 0 16px #34d399, 0 0 24px rgba(52, 211, 153, 0.4); }
    }

    /* Edit mode active state for the whole card */
    .edit-mode .permission-bar {
      background: linear-gradient(90deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
      border-bottom-color: rgba(99, 102, 241, 0.2);
    }

    /* Edit mode banner */
    .edit-mode-banner {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .edit-mode-banner svg {
      width: 18px;
      height: 18px;
      animation: bounce-edit 1s infinite;
    }

    @keyframes bounce-edit {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    .edit-mode .edit-mode-banner {
      display: flex;
    }

    /* Editable Cell Styles */
    .editable-cell {
      position: relative;
      cursor: text;
      transition: all 0.15s ease;
      border-radius: 4px;
      padding: 0.25rem 0.375rem;
      margin: -0.25rem -0.375rem;
    }

    .editable-cell:hover {
      background: rgba(99, 102, 241, 0.08);
    }

    .editable-cell::after {
      content: '';
      position: absolute;
      right: 2px;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 4px;
      background: var(--primary);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .editable-cell:hover::after {
      opacity: 0.5;
    }

    .edit-mode .editable-cell {
      background: rgba(99, 102, 241, 0.05);
      border: 1px dashed rgba(99, 102, 241, 0.25);
    }

    .edit-mode .editable-cell:hover {
      background: rgba(99, 102, 241, 0.12);
      border-color: var(--primary);
    }

    .edit-mode .editable-cell::after {
      opacity: 0.3;
    }

    .edit-mode .editable-cell:hover::after {
      opacity: 1;
    }

    /* Inline Edit Input */
    .inline-edit-input {
      width: 100%;
      padding: 0.375rem 0.5rem;
      font-size: inherit;
      font-family: inherit;
      color: var(--text-primary);
      background: var(--bg-card);
      border: 2px solid var(--primary);
      border-radius: 6px;
      outline: none;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .inline-edit-input:focus {
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.25);
    }

    .inline-edit-input.mono {
      font-family: 'JetBrains Mono', monospace;
    }

    /* Select Dropdown for Editable */
    .inline-edit-select {
      width: 100%;
      padding: 0.375rem 0.5rem;
      font-size: inherit;
      font-family: inherit;
      color: var(--text-primary);
      background: var(--bg-card);
      border: 2px solid var(--primary);
      border-radius: 6px;
      outline: none;
      cursor: pointer;
    }

    /* Read-only cell (no permission) */
    .readonly-cell {
      position: relative;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .readonly-cell::before {
      content: '';
      position: absolute;
      left: -4px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 3px;
      background: #6b7280;
      border-radius: 50%;
    }

    /* Edit Actions (save/cancel mini buttons) */
    .edit-actions {
      display: flex;
      gap: 0.25rem;
      margin-top: 0.375rem;
    }

    .edit-action-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .edit-action-btn.save {
      background: #10b981;
      color: white;
    }

    .edit-action-btn.save:hover {
      background: #059669;
    }

    .edit-action-btn.cancel {
      background: #6b7280;
      color: white;
    }

    .edit-action-btn.cancel:hover {
      background: #4b5563;
    }

    /* Field-level permission indicator */
    .field-locked {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: #6b7280;
    }

    .field-locked svg {
      width: 12px;
      height: 12px;
      opacity: 0.5;
    }

    /* Save All Changes Bar */
    .save-changes-bar {
      position: fixed;
      bottom: -80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      background: #1a1b23;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      z-index: 600;
      transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .save-changes-bar.active {
      bottom: 2rem;
    }

    .save-changes-bar .changes-count {
      color: #f59e0b;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .save-changes-bar .btn {
      padding: 0.625rem 1.25rem;
    }

    /* Row with pending changes */
    .data-table tbody tr.has-changes {
      background: rgba(245, 158, 11, 0.05);
    }

    .data-table tbody tr.has-changes td:first-child::before {
      background: #f59e0b;
      opacity: 1;
    }

    .data-table tbody tr.has-changes:hover {
      background: rgba(245, 158, 11, 0.1);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .page-header-filter {
        flex-direction: column;
        align-items: flex-start;
      }

      .date-presets {
        flex-wrap: wrap;
      }

      .permission-bar {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
      }
    }

    @media (max-width: 768px) {
      .page-header-top {
        flex-direction: column;
        gap: 1rem;
      }

      .card-header-right {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>

  <script>
    // ═══════════════════════════════════════════════════════════════
    // DATE PRESET HANDLERS (Global)
    // ═══════════════════════════════════════════════════════════════

    // Global date ranges
    let dateRanges = {};
    let flatpickrInstance = null;

    function handlePresetClick(btn, rangeKey) {
      console.log('Preset clicked:', rangeKey);

      // Update active state
      document.querySelectorAll('.date-preset-btn').forEach(b => {
        b.classList.remove('active');
      });
      btn.classList.add('active');

      // Update KPI labels
      updateKpiPeriodLabel(rangeKey);

      // Get range and filter
      const range = dateRanges[rangeKey];
      if (range && flatpickrInstance) {
        flatpickrInstance.setDate(range, true);

        const formatDateTR = (date) => {
          return date.toLocaleDateString('tr-TR', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
          });
        };

        const dateRangeInput = document.getElementById('dateRangeInput');
        if (range[0].getTime() === range[1].getTime()) {
          dateRangeInput.value = formatDateTR(range[0]);
        } else {
          dateRangeInput.value = formatDateTR(range[0]) + ' - ' + formatDateTR(range[1]);
        }

        filterByDateRange(range[0], range[1]);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // PERMISSION SYSTEM
    // ═══════════════════════════════════════════════════════════════

    // Permission configuration for different roles
    const permissionConfig = {
      admin: {
        label: 'Yönetici',
        description: 'Tüm alanları düzenleyebilirsiniz',
        badgeClass: 'admin',
        canEdit: true,
        editableFields: ['policyNo', 'customer', 'type', 'netPremium', 'grossPremium', 'producer', 'branch', 'date']
      },
      editor: {
        label: 'Editör',
        description: 'Bazı alanları düzenleyebilirsiniz',
        badgeClass: 'editor',
        canEdit: true,
        editableFields: ['customer', 'netPremium', 'grossPremium', 'producer', 'branch'] // Cannot edit policyNo, type, date
      },
      viewer: {
        label: 'İzleyici',
        description: 'Sadece görüntüleme yetkisi',
        badgeClass: 'viewer',
        canEdit: false,
        editableFields: []
      }
    };

    // ═══════════════════════════════════════════════════════════════
    // STATE VARIABLES
    // ═══════════════════════════════════════════════════════════════
    let currentUserRole = 'admin';
    let isEditMode = false;
    let pendingChanges = new Map();

    // Data arrays - API'den doldurulacak
    let policyTypes = [];
    let producersList = [];
    let branchesList = [];
    let policies = [];
    let filteredPolicies = [];

    // Selection & sorting state
    let selectedPolicies = new Set();
    let currentSort = { field: 'date', direction: 'desc' };

    // Pagination state
    let currentPage = 1;
    let pageSize = 20;
    let totalFilteredItems = 0;

    // Date range state
    let currentDateRange = {
      startDate: new Date(),
      endDate: new Date()
    };

    // ═══════════════════════════════════════════════════════════════
    // API LOADING FUNCTIONS
    // ═══════════════════════════════════════════════════════════════

    // Kullanıcı bilgisi yükle
    async function loadCurrentUser() {
      try {
        const data = await apiGet('auth/me');
        currentUserRole = data.role || 'viewer';
        APP_CONFIG.AUTH.setUser(data);
        return data;
      } catch (error) {
        console.error('Kullanıcı bilgisi alınamadı:', error);
        currentUserRole = 'viewer';
        return null;
      }
    }

    // Poliçe tipleri yükle
    async function loadPolicyTypes() {
      try {
        const data = await apiGet('policy-types');
        policyTypes = data || [];
        return data;
      } catch (error) {
        console.error('Poliçe tipleri alınamadı:', error);
        // Fallback statik veri
        policyTypes = [
          { value: 'Kasko', class: 'kasko' },
          { value: 'Trafik', class: 'trafik' },
          { value: 'DASK', class: 'dask' },
          { value: 'Sağlık', class: 'saglik' },
          { value: 'Konut', class: 'konut' }
        ];
        return policyTypes;
      }
    }

    // Prodüktör listesi yükle (kullanıcılar endpoint'inden - firmaId ile filtrelenmiş)
    async function loadProducers() {
      try {
        const user = APP_CONFIG.AUTH.getUser();
        const firmaId = user?.firmaId;
        const endpoint = firmaId ? `kullanicilar?firmaId=${firmaId}` : 'kullanicilar';
        const data = await apiGet(endpoint);
        producersList = (data || []).map(u => ({
          id: u.id,
          name: `${u.adi || ''} ${u.soyadi || ''}`.trim() || `Kullanıcı #${u.id}`
        }));
        populateProducerFilter();
        return producersList;
      } catch (error) {
        console.error('Prodüktör listesi alınamadı:', error);
        producersList = [];
        return [];
      }
    }

    // Şube listesi yükle
    async function loadBranches() {
      try {
        const data = await apiGet('subeler');
        branchesList = (data || []).map(b => b.subeAdi || b.name);
        return data;
      } catch (error) {
        console.error('Şube listesi alınamadı:', error);
        branchesList = [];
        return [];
      }
    }

    // Poliçe türü için CSS class belirle
    function getTypeClass(typeName) {
      const name = (typeName || '').toLowerCase();
      if (name.includes('kasko')) return 'kasko';
      if (name.includes('trafik')) return 'trafik';
      if (name.includes('dask')) return 'dask';
      if (name.includes('konut')) return 'konut';
      if (name.includes('sağlık') || name.includes('saglik')) return 'saglik';
      return '';
    }

    // API response'u frontend formatına dönüştür
    function mapPolicyFromApi(p) {
      // Prodüktör adını bul
      const producer = producersList.find(pr => pr.id === p.produktorId);
      const producerName = producer ? producer.name : `Prodüktör #${p.produktorId}`;

      // Poliçe türünü API'den gelen listeden bul
      const policyType = policyTypes.find(pt => pt.id === p.policeTuru);
      const typeName = policyType ? (policyType.turu || policyType.value || `Tür ${p.policeTuru}`) : `Tür ${p.policeTuru}`;
      const typeClass = getTypeClass(typeName);

      // Şube adını bul
      const branch = branchesList[p.subeId - 1] || `Şube #${p.subeId}`;

      return {
        id: p.id,
        policyNo: p.policeNumarasi || '',
        customer: p.sigortaliAdi || 'Bilinmiyor',
        type: typeName,
        typeClass: typeClass,
        netPremium: p.netPrim || 0,
        grossPremium: p.brutPrim || 0,
        producer: producerName,
        producerId: p.produktorId,
        branch: branch,
        branchId: p.subeId,
        date: p.tanzimTarihi ? new Date(p.tanzimTarihi) : new Date(),
        dateFormatted: p.tanzimTarihi ? new Date(p.tanzimTarihi).toLocaleDateString('tr-TR') : '-',
        plaka: p.plaka || '',
        acenteAdi: p.acenteAdi || '',
        acenteNo: p.acenteNo || ''
      };
    }

    // Yakalanan poliçeler yükle
    async function loadCapturedPolicies() {
      try {
        const params = {
          startDate: formatDateISO(currentDateRange.startDate),
          endDate: formatDateISO(currentDateRange.endDate),
          sortBy: currentSort.field,
          sortDir: currentSort.direction
        };

        const result = await apiGet('policies/captured', params);

        let rawPolicies = [];
        if (result.data) {
          rawPolicies = result.data;
        } else if (Array.isArray(result)) {
          rawPolicies = result;
        }

        // API response'u frontend formatına dönüştür
        policies = rawPolicies.map(mapPolicyFromApi);
        filteredPolicies = [...policies];

        renderTable();
        updateStats();
        return policies;
      } catch (error) {
        console.error('Poliçeler alınamadı:', error);
        showToast('Poliçeler yüklenirken hata oluştu', 'error');
        policies = [];
        filteredPolicies = [];
        renderTable();
        return [];
      }
    }

    // KPI istatistikleri yükle
    async function loadKPIStats() {
      try {
        const params = {
          startDate: formatDateISO(currentDateRange.startDate),
          endDate: formatDateISO(currentDateRange.endDate)
        };

        const stats = await apiGet('policies/captured/stats', params);

        // KPI kartlarını güncelle
        if (stats.pendingCount !== undefined) {
          document.getElementById('statPending').textContent = stats.pendingCount;
        }
        if (stats.totalGrossPremium !== undefined) {
          document.getElementById('statPremium').textContent = APP_CONFIG.CURRENCY.format(stats.totalGrossPremium);
        }
        if (stats.activeProducerCount !== undefined) {
          document.getElementById('statProducers').textContent = stats.activeProducerCount;
        }
        if (stats.sentCount !== undefined) {
          const sentEl = document.getElementById('statSent');
          if (sentEl) sentEl.textContent = stats.sentCount;
        }

        return stats;
      } catch (error) {
        console.error('KPI istatistikleri alınamadı:', error);
        return null;
      }
    }

    // Prodüktör dropdown'unu doldur
    function populateProducerFilter() {
      const list = document.getElementById('producerList');
      if (!list) return;

      const avatarColors = [
        'linear-gradient(135deg, #10b981, #059669)',
        'linear-gradient(135deg, #06b6d4, #0891b2)',
        'linear-gradient(135deg, #8b5cf6, #7c3aed)',
        'linear-gradient(135deg, #f59e0b, #d97706)',
        'linear-gradient(135deg, #f43f5e, #e11d48)',
        'linear-gradient(135deg, #3b82f6, #2563eb)',
        'linear-gradient(135deg, #ec4899, #db2777)',
        'linear-gradient(135deg, #14b8a6, #0d9488)'
      ];

      // "Tüm Prodüktörler" seçeneği
      let html = `
        <div class="dropdown-item selected" data-value="" onclick="selectProducer(this, '', 'Tüm Prodüktörler')">
          <span class="dropdown-item-avatar" style="background: linear-gradient(135deg, #64748b, #475569);">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 00-3-3.87"/>
              <path d="M16 3.13a4 4 0 010 7.75"/>
            </svg>
          </span>
          <span class="dropdown-item-name">Tüm Prodüktörler</span>
        </div>
      `;

      // Prodüktörleri ekle
      producersList.forEach((p, index) => {
        const initials = p.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const color = avatarColors[index % avatarColors.length];
        const escapedName = p.name.replace(/'/g, "\\'");
        html += `
          <div class="dropdown-item" data-value="${p.name}" onclick="selectProducer(this, '${escapedName}', '${escapedName}')">
            <span class="dropdown-item-avatar" style="background: ${color};">${initials}</span>
            <span class="dropdown-item-name">${p.name}</span>
          </div>
        `;
      });

      list.innerHTML = html;
    }

    // Dropdown aç/kapat
    function toggleProducerDropdown(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('producerDropdown');
      const searchInput = document.getElementById('producerSearchInput');

      dropdown.classList.toggle('open');

      if (dropdown.classList.contains('open')) {
        searchInput.value = '';
        filterProducerList();
        searchInput.focus();
      }
    }

    // Prodüktör listesini filtrele
    function filterProducerList() {
      const searchInput = document.getElementById('producerSearchInput');
      const searchTerm = searchInput.value.toLowerCase();
      const items = document.querySelectorAll('#producerList .dropdown-item');

      items.forEach(item => {
        const name = item.getAttribute('data-value').toLowerCase();
        const text = item.textContent.toLowerCase();
        if (name.includes(searchTerm) || text.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Prodüktör seç
    function selectProducer(element, value, displayText) {
      // Hidden input güncelle
      document.getElementById('producerFilter').value = value;

      // Görünen text güncelle
      document.getElementById('producerFilterText').textContent = displayText;

      // Seçili durumu güncelle
      document.querySelectorAll('#producerList .dropdown-item').forEach(item => {
        item.classList.remove('selected');
      });
      element.classList.add('selected');

      // Dropdown kapat
      document.getElementById('producerDropdown').classList.remove('open');

      // Filtreleme uygula
      filterTable();
    }

    // Click outside to close dropdown
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('producerDropdown');
      if (dropdown && !dropdown.contains(event.target)) {
        dropdown.classList.remove('open');
      }
    });

    // Tarih formatla (ISO)
    function formatDateISO(date) {
      if (!date) return '';
      const d = new Date(date);
      return d.toISOString().split('T')[0];
    }

    // ═══════════════════════════════════════════════════════════════
    // SAYFA BAŞLATMA - Initialize page
    // ═══════════════════════════════════════════════════════════════
    document.addEventListener('DOMContentLoaded', async function() {
      showLoading(true);

      try {
        // 1. Kullanıcı bilgisi ve yetkisi
        await loadCurrentUser();

        // 2. Dropdown verileri (paralel)
        await Promise.all([
          loadProducers(),
          loadBranches(),
          loadPolicyTypes()
        ]);

        // 3. Date picker başlat
        initDatePicker();

        // 4. Ana veri ve istatistikler
        await Promise.all([
          loadCapturedPolicies(),
          loadKPIStats()
        ]);

        // 5. UI bileşenlerini hazırla
        updatePermissionUI();

      } catch (error) {
        console.error('Sayfa yüklenirken hata:', error);
        showToast('Sayfa yüklenirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    });

    // ═══════════════════════════════════════════════════════════════
    // PERMISSION & EDIT MODE FUNCTIONS
    // ═══════════════════════════════════════════════════════════════

    function changeUserRole(role) {
      currentUserRole = role;
      updatePermissionUI();

      // If switching to viewer, disable edit mode
      if (role === 'viewer' && isEditMode) {
        isEditMode = false;
        document.getElementById('editModeToggle').classList.remove('active');
        document.getElementById('policyCard').classList.remove('edit-mode');
      }

      // Re-render table to reflect permission changes
      applyFilters();
    }

    function updatePermissionUI() {
      const config = permissionConfig[currentUserRole];
      const badge = document.getElementById('permissionBadge');
      const label = document.getElementById('permissionLabel');
      const text = document.getElementById('permissionText');
      const editToggle = document.getElementById('editModeToggle');

      // Update badge class
      badge.className = 'permission-badge ' + config.badgeClass;
      label.textContent = config.label;
      text.textContent = config.description;

      // Show/hide edit mode toggle based on permission
      if (config.canEdit) {
        editToggle.style.display = 'flex';
      } else {
        editToggle.style.display = 'none';
      }
    }

    function toggleEditMode() {
      const config = permissionConfig[currentUserRole];
      if (!config.canEdit) return;

      isEditMode = !isEditMode;
      const toggle = document.getElementById('editModeToggle');
      const card = document.getElementById('policyCard');

      if (isEditMode) {
        toggle.classList.add('active');
        card.classList.add('edit-mode');
      } else {
        toggle.classList.remove('active');
        card.classList.remove('edit-mode');
      }

      // Re-render to update cell styles
      applyFilters();
    }

    function canEditField(field) {
      const config = permissionConfig[currentUserRole];
      return config.canEdit && config.editableFields.includes(field);
    }

    // ═══════════════════════════════════════════════════════════════
    // INLINE EDITING FUNCTIONS
    // ═══════════════════════════════════════════════════════════════

    let currentEditCell = null;

    function startEditing(cell, policyId, field, currentValue) {
      if (!canEditField(field)) return;
      if (currentEditCell) cancelEditing();

      currentEditCell = cell;
      const originalContent = cell.innerHTML;
      cell.dataset.originalContent = originalContent;
      cell.dataset.originalValue = currentValue;

      let inputHTML = '';

      switch (field) {
        case 'type':
          inputHTML = `<select class="inline-edit-select" onchange="finishEditing(${policyId}, '${field}', this.value)" onblur="setTimeout(() => cancelEditing(), 150)">
            ${policyTypes.map(t => `<option value="${t.value}" ${t.value === currentValue ? 'selected' : ''}>${t.value}</option>`).join('')}
          </select>`;
          break;
        case 'producer':
          inputHTML = `<select class="inline-edit-select" onchange="finishEditing(${policyId}, '${field}', this.value)" onblur="setTimeout(() => cancelEditing(), 150)">
            ${producersList.map(p => `<option value="${p.name}" ${p.name === currentValue ? 'selected' : ''}>${p.name}</option>`).join('')}
          </select>`;
          break;
        case 'branch':
          inputHTML = `<select class="inline-edit-select" onchange="finishEditing(${policyId}, '${field}', this.value)" onblur="setTimeout(() => cancelEditing(), 150)">
            ${branchesList.map(b => `<option value="${b}" ${b === currentValue ? 'selected' : ''}>${b}</option>`).join('')}
          </select>`;
          break;
        case 'netPremium':
        case 'grossPremium':
          inputHTML = `<input type="number" class="inline-edit-input mono" value="${currentValue}"
            onkeydown="handleEditKeydown(event, ${policyId}, '${field}')"
            onblur="finishEditing(${policyId}, '${field}', this.value)">`;
          break;
        case 'date':
          inputHTML = `<input type="date" class="inline-edit-input" value="${currentValue}"
            onkeydown="handleEditKeydown(event, ${policyId}, '${field}')"
            onblur="finishEditing(${policyId}, '${field}', this.value)">`;
          break;
        default:
          inputHTML = `<input type="text" class="inline-edit-input ${field === 'policyNo' ? 'mono' : ''}" value="${currentValue}"
            onkeydown="handleEditKeydown(event, ${policyId}, '${field}')"
            onblur="finishEditing(${policyId}, '${field}', this.value)">`;
      }

      cell.innerHTML = inputHTML;
      const input = cell.querySelector('input, select');
      if (input) {
        input.focus();
        if (input.select) input.select();
      }
    }

    function handleEditKeydown(event, policyId, field) {
      if (event.key === 'Enter') {
        event.preventDefault();
        finishEditing(policyId, field, event.target.value);
      } else if (event.key === 'Escape') {
        cancelEditing();
      }
    }

    function finishEditing(policyId, field, newValue) {
      if (!currentEditCell) return;

      const originalValue = currentEditCell.dataset.originalValue;

      // Check if value actually changed
      if (String(newValue) !== String(originalValue)) {
        // Store the change
        if (!pendingChanges.has(policyId)) {
          pendingChanges.set(policyId, {});
        }
        pendingChanges.get(policyId)[field] = newValue;

        // Update the policy data locally
        const policy = policies.find(p => p.id === policyId);
        if (policy) {
          if (field === 'netPremium' || field === 'grossPremium') {
            policy[field] = parseFloat(newValue) || 0;
          } else if (field === 'type') {
            policy[field] = newValue;
            policy.typeClass = policyTypes.find(t => t.value === newValue)?.class || 'kasko';
          } else if (field === 'producer') {
            const prod = producersList.find(p => p.name === newValue);
            if (prod) {
              policy.producer = prod.name;
              policy.producerInitials = prod.initials;
              policy.producerColor = prod.color;
              policy.branch = prod.branch;
              // Also record branch change
              pendingChanges.get(policyId)['branch'] = prod.branch;
            }
          } else if (field === 'date') {
            policy.date = newValue;
            const d = new Date(newValue);
            policy.dateFormatted = d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
          } else {
            policy[field] = newValue;
          }
        }

        updateChangesBar();
      }

      currentEditCell = null;
      applyFilters();
    }

    function cancelEditing() {
      if (!currentEditCell) return;
      currentEditCell.innerHTML = currentEditCell.dataset.originalContent;
      currentEditCell = null;
    }

    function updateChangesBar() {
      const bar = document.getElementById('saveChangesBar');
      const count = document.getElementById('changesCount');

      let totalChanges = 0;
      pendingChanges.forEach(changes => {
        totalChanges += Object.keys(changes).length;
      });

      count.textContent = totalChanges;

      if (totalChanges > 0) {
        bar.classList.add('active');
      } else {
        bar.classList.remove('active');
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // POLİÇE DEĞİŞİKLİKLERİNİ KAYDET
    // ═══════════════════════════════════════════════════════════════
    async function saveAllChanges() {
      const changesArray = [];
      pendingChanges.forEach((changes, policyId) => {
        changesArray.push({ policyId, changes });
      });

      if (changesArray.length === 0) {
        showToast('Kaydedilecek değişiklik yok', 'info');
        return;
      }

      showLoading(true);

      try {
        const result = await apiPut('policies/batch-update', { updates: changesArray });

        if (result.success) {
          pendingChanges.clear();
          updateChangesBar();
          showToast(`${result.updatedCount || changesArray.length} poliçede değişiklikler kaydedildi`, 'success');

          // Verileri yenile
          await loadCapturedPolicies();
        } else {
          const errorMsg = result.errors ? result.errors.map(e => e.message).join(', ') : 'Bilinmeyen hata';
          showToast('Bazı değişiklikler kaydedilemedi: ' + errorMsg, 'error');
        }
      } catch (error) {
        console.error('Kaydetme hatası:', error);
        showToast('Değişiklikler kaydedilirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    async function discardAllChanges() {
      if (!confirm('Tüm değişiklikler iptal edilecek. Emin misiniz?')) return;

      pendingChanges.clear();
      updateChangesBar();

      // Verileri backend'den tekrar çek
      showLoading(true);
      try {
        await loadCapturedPolicies();
        showToast('Değişiklikler iptal edildi', 'info');
      } finally {
        showLoading(false);
      }
    }

    // Initialize Flatpickr
    function initDatePicker() {
      const dateRangeInput = document.getElementById('dateRangeInput');
      const dateRangePicker = document.getElementById('dateRangePicker');

      if (!dateRangeInput || !dateRangePicker) {
        console.error('Date picker elements not found');
        return;
      }

      const today = new Date();

      const formatDateTR = (date) => {
        return date.toLocaleDateString('tr-TR', {
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        });
      };

      // Date ranges - set globally
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);

      const thisWeekStart = new Date();
      thisWeekStart.setDate(today.getDate() - today.getDay() + 1);

      const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);

      dateRanges = {
        today: [new Date(), new Date()],
        yesterday: [yesterday, yesterday],
        thisWeek: [thisWeekStart, new Date()],
        thisMonth: [thisMonthStart, new Date()]
      };

      let currentRange = dateRanges.today;

      // Initialize Flatpickr - store globally
      flatpickrInstance = flatpickr(dateRangeInput, {
        mode: 'range',
        dateFormat: 'd M Y',
        locale: 'tr',
        defaultDate: currentRange,
        allowInput: false,
        disableMobile: true,
        onOpen: function() {
          dateRangePicker.classList.add('active');
        },
        onClose: function() {
          dateRangePicker.classList.remove('active');
        },
        onChange: function(selectedDates, dateStr) {
          if (selectedDates.length === 2) {
            // Clear active state from preset buttons
            document.querySelectorAll('.date-preset-btn').forEach(btn => {
              btn.classList.remove('active');
            });
            updateKpiPeriodLabel('custom');
            filterByDateRange(selectedDates[0], selectedDates[1]);
          }
        }
      });

      // Set initial display
      dateRangeInput.value = formatDateTR(currentRange[0]);

      // Başlangıçta "Bugün" seçili - label güncelle
      updateKpiPeriodLabel('today');

      console.log('Date picker initialized, ranges:', Object.keys(dateRanges));
    }

    // KPI period label güncelle
    function updateKpiPeriodLabel(rangeKey) {
      const pendingLabel = document.getElementById('kpiPeriodLabel');
      const sentLabel = document.getElementById('kpiSentPeriodLabel');

      const pendingLabels = {
        'today': 'Bugün yakalanan poliçeler',
        'yesterday': 'Dün yakalanan poliçeler',
        'thisWeek': 'Bu hafta yakalanan poliçeler',
        'thisMonth': 'Bu ay yakalanan poliçeler',
        'custom': 'Seçilen dönemde yakalanan'
      };

      const sentLabels = {
        'today': 'Bugün gönderilen',
        'yesterday': 'Dün gönderilen',
        'thisWeek': 'Bu hafta gönderilen',
        'thisMonth': 'Bu ay gönderilen',
        'custom': 'Seçilen dönemde gönderilen'
      };

      if (pendingLabel) {
        pendingLabel.textContent = pendingLabels[rangeKey] || pendingLabels['custom'];
      }
      if (sentLabel) {
        sentLabel.textContent = sentLabels[rangeKey] || sentLabels['custom'];
      }
    }

    // Filter by date range
    async function filterByDateRange(startDate, endDate) {
      const start = new Date(startDate);
      start.setHours(0, 0, 0, 0);
      const end = new Date(endDate);
      end.setHours(23, 59, 59, 999);

      // Update currentDateRange for API calls
      currentDateRange.startDate = start;
      currentDateRange.endDate = end;

      currentPage = 1; // Reset to first page when filtering

      // Load data from API with new date range
      showLoading(true);
      try {
        await Promise.all([
          loadCapturedPolicies(),
          loadKPIStats()
        ]);
      } catch (error) {
        console.error('Date filter error:', error);
        showToast('Tarih filtreleme hatası', 'error');
      } finally {
        showLoading(false);
      }
    }

    // Apply all filters
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const producerFilter = document.getElementById('producerFilter').value;

      let result = [...filteredPolicies];

      if (searchTerm) {
        result = result.filter(p =>
          p.policyNo.toLowerCase().includes(searchTerm) ||
          p.customer.toLowerCase().includes(searchTerm) ||
          p.type.toLowerCase().includes(searchTerm) ||
          p.producer.toLowerCase().includes(searchTerm) ||
          p.branch.toLowerCase().includes(searchTerm) ||
          p.dateFormatted.toLowerCase().includes(searchTerm) ||
          p.netPremium.toString().includes(searchTerm) ||
          p.grossPremium.toString().includes(searchTerm)
        );
      }

      if (producerFilter) {
        result = result.filter(p => p.producer === producerFilter);
      }

      // Sort
      result.sort((a, b) => {
        let aVal = a[currentSort.field];
        let bVal = b[currentSort.field];

        if (currentSort.field === 'premium') {
          aVal = parseFloat(aVal);
          bVal = parseFloat(bVal);
        }

        if (currentSort.direction === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });

      renderTableWithData(result);
      updateStats(result);
    }

    // Filter table
    function filterTable() {
      currentPage = 1; // Reset to first page when filtering
      applyFilters();
    }

    // Sort table
    function sortTable(field) {
      if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
      }

      // Update sort indicators
      document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
      });
      const currentTh = document.querySelector(`[data-sort="${field}"]`);
      if (currentTh) {
        currentTh.classList.add(currentSort.direction);
      }

      applyFilters();
    }

    // Render table
    function renderTable() {
      renderTableWithData(policies);
    }

    function renderTableWithData(data) {
      const tbody = document.getElementById('policyTableBody');

      // Store total filtered items for pagination
      totalFilteredItems = data.length;

      if (data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-muted);">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 0.5rem; opacity: 0.5;">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
              </svg>
              <br>Seçilen kriterlere uygun poliçe bulunamadı.
            </td>
          </tr>
        `;
        document.getElementById('tableInfo').textContent = '0 poliçe';
        updatePaginationControls(0, 0, 0);
        return;
      }

      // Calculate pagination
      const totalPages = Math.ceil(data.length / pageSize);

      // Ensure current page is valid
      if (currentPage > totalPages) {
        currentPage = totalPages;
      }
      if (currentPage < 1) {
        currentPage = 1;
      }

      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, data.length);
      const paginatedData = data.slice(startIndex, endIndex);

      // Helper function to generate editable cell HTML
      function editableCell(policyId, field, displayContent, rawValue, extraClass = '') {
        const canEdit = canEditField(field);
        const cellClass = canEdit ? 'editable-cell' : 'readonly-cell';
        const clickHandler = canEdit && isEditMode
          ? `onclick="event.stopPropagation(); startEditing(this, ${policyId}, '${field}', '${String(rawValue).replace(/'/g, "\\'")}')"`
          : '';

        return `<span class="${cellClass} ${extraClass}" ${clickHandler}>${displayContent}</span>`;
      }

      tbody.innerHTML = paginatedData.map(p => {
        // Check which fields have pending changes
        const policyChanges = pendingChanges.get(p.id) || {};
        const hasChanges = Object.keys(policyChanges).length > 0;

        return `
        <tr class="${selectedPolicies.has(p.id) ? 'selected' : ''} ${hasChanges ? 'has-changes' : ''}" data-id="${p.id}" onclick="handleRowClick(event, ${p.id})">
          <td>
            <input type="checkbox" ${selectedPolicies.has(p.id) ? 'checked' : ''}>
          </td>
          <td>
            ${canEditField('policyNo') && isEditMode ?
              editableCell(p.id, 'policyNo', `
                <span class="font-mono" style="font-weight: 600; display: inline-flex; align-items: center; gap: 0.375rem;">
                  ${p.policyNo}
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.5;">
                    <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                    <polyline points="15,3 21,3 21,9"/>
                    <line x1="10" y1="14" x2="21" y2="3"/>
                  </svg>
                </span>
              `, p.policyNo, 'font-mono')
              : `
              <span class="clickable-link font-mono" style="font-weight: 600;" onclick="event.stopPropagation(); openPolicyDrive('${p.policyNo}')" title="Google Drive'da aç">
                ${p.policyNo}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                  <polyline points="15,3 21,3 21,9"/>
                  <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
              </span>
            `}
          </td>
          <td>
            ${canEditField('customer') && isEditMode ?
              editableCell(p.id, 'customer', p.customer, p.customer)
              : `<div class="cell-main clickable-customer" onclick="event.stopPropagation(); openCustomerModal('${p.customer}', ${p.id})">${p.customer}</div>`
            }
          </td>
          <td>
            ${canEditField('type') && isEditMode ?
              editableCell(p.id, 'type', `<span class="policy-type-badge ${p.typeClass}">${p.type}</span>`, p.type)
              : `<span class="policy-type-badge ${p.typeClass}">${p.type}</span>`
            }
          </td>
          <td>
            ${editableCell(p.id, 'netPremium', `<span class="font-mono font-semibold">₺${p.netPremium.toLocaleString('tr-TR')}</span>`, p.netPremium, 'font-mono')}
          </td>
          <td>
            ${editableCell(p.id, 'grossPremium', `<span class="font-mono font-semibold">₺${p.grossPremium.toLocaleString('tr-TR')}</span>`, p.grossPremium, 'font-mono')}
          </td>
          <td>
            <div class="producer-cell">
              <div class="producer-avatar ${p.producerColor}">${p.producerInitials}</div>
              <div class="producer-info">
                ${canEditField('producer') && isEditMode ?
                  editableCell(p.id, 'producer', `<span class="producer-name">${p.producer}</span>`, p.producer)
                  : `<span class="producer-name clickable-producer" onclick="event.stopPropagation(); openProducerModal('${p.producer}', '${p.producerInitials}', '${p.producerColor}')">${p.producer}</span>`
                }
                ${canEditField('branch') && isEditMode ?
                  editableCell(p.id, 'branch', `<span class="producer-branch">${p.branch}</span>`, p.branch)
                  : `<span class="producer-branch clickable-branch" onclick="event.stopPropagation(); openBranchModal('${p.branch}')">${p.branch}</span>`
                }
              </div>
            </div>
          </td>
          <td>
            ${canEditField('date') && isEditMode ?
              editableCell(p.id, 'date', `<span class="cell-sub">${p.dateFormatted}</span>`, p.date)
              : `<span class="cell-sub">${p.dateFormatted}</span>`
            }
          </td>
          <td onclick="event.stopPropagation()">
            <div class="table-actions">
              <button class="action-btn view-btn" onclick="viewPolicy(${p.id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
              <button class="action-btn send" onclick="sendToPool(${p.id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M5 12h14"/>
                  <path d="M12 5l7 7-7 7"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `}).join('');

      // Update table info text
      document.getElementById('tableInfo').textContent = `${startIndex + 1}-${endIndex} / ${data.length} poliçe`;

      // Update pagination controls
      updatePaginationControls(currentPage, totalPages, data.length);
    }

    // Update stats
    function updateStats(data = policies) {
      const totalGrossPremium = data.reduce((sum, p) => sum + p.grossPremium, 0);
      const producers = [...new Set(data.map(p => p.producer))];

      document.getElementById('statPending').textContent = data.length;
      document.getElementById('statPremium').textContent = '₺' + totalGrossPremium.toLocaleString('tr-TR');
      document.getElementById('statProducers').textContent = producers.length;
    }

    // ═══════════════════════════════════════════════════════════════
    // PAGINATION FUNCTIONS
    // ═══════════════════════════════════════════════════════════════

    function updatePaginationControls(current, total, itemCount) {
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');
      const pageNumbersContainer = document.getElementById('pageNumbers');

      // Update prev/next button states
      prevBtn.disabled = current <= 1;
      nextBtn.disabled = current >= total;

      // Generate page numbers
      if (total <= 1) {
        pageNumbersContainer.innerHTML = '';
        return;
      }

      let pageNumbersHTML = '';

      // Always show first page
      pageNumbersHTML += generatePageNumber(1, current);

      // Show ellipsis if there's a gap after first page
      if (current > 3) {
        pageNumbersHTML += '<span class="page-ellipsis">...</span>';
      }

      // Show pages around current page
      for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) {
        pageNumbersHTML += generatePageNumber(i, current);
      }

      // Show ellipsis if there's a gap before last page
      if (current < total - 2) {
        pageNumbersHTML += '<span class="page-ellipsis">...</span>';
      }

      // Always show last page (if more than 1 page)
      if (total > 1) {
        pageNumbersHTML += generatePageNumber(total, current);
      }

      pageNumbersContainer.innerHTML = pageNumbersHTML;
    }

    function generatePageNumber(page, currentPage) {
      const isActive = page === currentPage;
      return `<button class="page-number ${isActive ? 'active' : ''}" onclick="goToPage(${page})">${page}</button>`;
    }

    function goToPage(page) {
      currentPage = page;
      applyFilters();
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        applyFilters();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(totalFilteredItems / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        applyFilters();
      }
    }

    function changePageSize(newSize) {
      pageSize = parseInt(newSize);
      currentPage = 1; // Reset to first page when changing page size
      applyFilters();
    }

    // Selection functions
    function handleRowClick(event, id) {
      // Toggle selection when clicking anywhere on the row
      toggleSelect(id);
    }

    function toggleSelect(id) {
      if (selectedPolicies.has(id)) {
        selectedPolicies.delete(id);
      } else {
        selectedPolicies.add(id);
      }
      updateSelectionUI();
    }

    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const visibleRows = document.querySelectorAll('#policyTableBody tr[data-id]');

      if (selectAllCheckbox.checked) {
        visibleRows.forEach(row => {
          const id = parseInt(row.dataset.id);
          selectedPolicies.add(id);
        });
      } else {
        visibleRows.forEach(row => {
          const id = parseInt(row.dataset.id);
          selectedPolicies.delete(id);
        });
      }
      updateSelectionUI();
    }

    function updateSelectionUI() {
      const count = selectedPolicies.size;
      const selectedCountBadge = document.getElementById('selectedCount');
      const sendSelectedBtn = document.getElementById('sendSelectedBtn');
      const floatingBox = document.getElementById('floatingActionBox');

      if (count > 0) {
        selectedCountBadge.textContent = count + ' seçili';
        selectedCountBadge.style.display = 'inline-flex';
        sendSelectedBtn.style.display = 'inline-flex';

        // Show floating action box
        floatingBox.classList.add('active');

        // Update floating box stats
        document.getElementById('fabCount').textContent = count;
        const totalPremium = [...selectedPolicies].reduce((sum, id) => {
          const policy = policies.find(p => p.id === id);
          return sum + (policy ? policy.grossPremium : 0);
        }, 0);
        document.getElementById('fabTotalPremium').textContent = '₺' + totalPremium.toLocaleString('tr-TR');
      } else {
        selectedCountBadge.style.display = 'none';
        sendSelectedBtn.style.display = 'none';

        // Hide floating action box
        floatingBox.classList.remove('active');
      }

      // Update row styles
      document.querySelectorAll('#policyTableBody tr[data-id]').forEach(row => {
        const id = parseInt(row.dataset.id);
        const checkbox = row.querySelector('input[type="checkbox"]');
        if (selectedPolicies.has(id)) {
          row.classList.add('selected');
          checkbox.checked = true;
        } else {
          row.classList.remove('selected');
          checkbox.checked = false;
        }
      });

      // Update select all checkbox
      const visibleRows = document.querySelectorAll('#policyTableBody tr[data-id]');
      const selectAllCheckbox = document.getElementById('selectAll');
      const allSelected = visibleRows.length > 0 && [...visibleRows].every(row => selectedPolicies.has(parseInt(row.dataset.id)));
      selectAllCheckbox.checked = allSelected;
    }

    function clearSelection() {
      selectedPolicies.clear();
      updateSelectionUI();
    }

    function viewSelectedPolicies() {
      const selectedList = [...selectedPolicies].map(id => {
        const policy = policies.find(p => p.id === id);
        return policy ? `${policy.policyNo} - ${policy.customer}` : '';
      }).join('\n');

      alert('Seçili Poliçeler:\n\n' + selectedList);
    }

    function exportSelectedPolicies() {
      const selectedData = [...selectedPolicies].map(id => policies.find(p => p.id === id)).filter(Boolean);

      if (selectedData.length === 0) return;

      // Create CSV content
      const headers = ['Poliçe No', 'Müşteri', 'Tip', 'Net Prim', 'Brüt Prim', 'Prodüktör', 'Şube', 'Tarih'];
      const rows = selectedData.map(p => [
        p.policyNo,
        p.customer,
        p.type,
        p.netPremium,
        p.grossPremium,
        p.producer,
        p.branch,
        p.dateFormatted
      ]);

      const csvContent = [headers, ...rows].map(row => row.join(';')).join('\n');

      // Download
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `secili_policeler_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();

      alert(`${selectedData.length} poliçe Excel'e aktarıldı.`);
    }

    // Actions
    function viewPolicy(id) {
      const policy = policies.find(p => p.id === id);
      if (policy) {
        // TODO: Modal açarak poliçe detaylarını göster veya detay sayfasına yönlendir
        // window.location.href = `/policies/${id}`;
        alert(`Poliçe Detayı:\n\nPoliçe No: ${policy.policyNo}\nMüşteri: ${policy.customer}\nTip: ${policy.type}\nNet Prim: ₺${policy.netPremium.toLocaleString('tr-TR')}\nBrüt Prim: ₺${policy.grossPremium.toLocaleString('tr-TR')}\nProdüktör: ${policy.producer}\nŞube: ${policy.branch}\nTarih: ${policy.dateFormatted}`);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // POLİÇEYİ HAVUZA GÖNDER
    // ═══════════════════════════════════════════════════════════════
    async function sendToPool(id) {
      const policy = policies.find(p => p.id === id);
      if (!policy) return;

      if (!confirm(`#${policy.policyNo} numaralı poliçe havuza gönderilecek. Onaylıyor musunuz?`)) return;

      showLoading(true);

      try {
        const result = await apiPost(`policies/${id}/send-to-pool`, {});

        if (result.success) {
          policies = policies.filter(p => p.id !== id);
          filteredPolicies = filteredPolicies.filter(p => p.id !== id);
          selectedPolicies.delete(id);
          applyFilters();
          updateStats();
          await loadKPIStats();
          showToast('Poliçe başarıyla havuza gönderildi', 'success');
        } else {
          showToast('Hata: ' + (result.message || 'Bilinmeyen hata'), 'error');
        }
      } catch (error) {
        console.error('Havuza gönderme hatası:', error);
        showToast('Poliçe havuza gönderilirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // SEÇİLİ POLİÇELERİ TOPLU HAVUZA GÖNDER
    // ═══════════════════════════════════════════════════════════════
    async function sendSelectedToPool() {
      if (selectedPolicies.size === 0) return;

      if (!confirm(`${selectedPolicies.size} poliçe havuza gönderilecek. Onaylıyor musunuz?`)) return;

      showLoading(true);

      try {
        const policyIds = Array.from(selectedPolicies);
        const result = await apiPost('policies/batch-send-to-pool', { policyIds });

        if (result.success) {
          policyIds.forEach(id => {
            policies = policies.filter(p => p.id !== id);
            filteredPolicies = filteredPolicies.filter(p => p.id !== id);
          });
          selectedPolicies.clear();
          applyFilters();
          updateStats();
          await loadKPIStats();
          showToast(`${result.sentCount || policyIds.length} poliçe başarıyla havuza gönderildi`, 'success');
        } else {
          const errorMsg = result.errors ? result.errors.map(e => e.message).join(', ') : 'Bilinmeyen hata';
          showToast('Bazı poliçeler gönderilemedi: ' + errorMsg, 'error');
        }
      } catch (error) {
        console.error('Toplu havuza gönderme hatası:', error);
        showToast('Poliçeler havuza gönderilirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    async function sendAllToPool() {
      const visiblePolicies = document.querySelectorAll('#policyTableBody tr[data-id]');
      if (visiblePolicies.length === 0) {
        showToast('Gönderilecek poliçe bulunamadı', 'warning');
        return;
      }

      if (!confirm(`${visiblePolicies.length} poliçe havuza gönderilecek. Onaylıyor musunuz?`)) return;

      showLoading(true);

      try {
        const policyIds = Array.from(visiblePolicies).map(row => parseInt(row.dataset.id));
        const result = await apiPost('policies/batch-send-to-pool', { policyIds });

        if (result.success) {
          policyIds.forEach(id => {
            policies = policies.filter(p => p.id !== id);
            filteredPolicies = filteredPolicies.filter(p => p.id !== id);
          });
          selectedPolicies.clear();
          applyFilters();
          updateStats();
          await loadKPIStats();
          showToast(`${result.sentCount || policyIds.length} poliçe başarıyla havuza gönderildi`, 'success');
        } else {
          showToast('Poliçeler gönderilemedi', 'error');
        }
      } catch (error) {
        console.error('Tüm poliçeleri gönderme hatası:', error);
        showToast('Poliçeler havuza gönderilirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // VERİLERİ YENİLE
    // ═══════════════════════════════════════════════════════════════
    async function refreshData() {
      showLoading(true);

      try {
        await Promise.all([
          loadCapturedPolicies(),
          loadKPIStats()
        ]);
        showToast('Veriler yenilendi', 'success');
      } catch (error) {
        console.error('Yenileme hatası:', error);
        showToast('Veriler yenilenirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // POLICY DRIVE LINK
    // ═══════════════════════════════════════════════════════════════

    function openPolicyDrive(policyNo) {
      // Google Drive link formatı - gerçek uygulamada API'den gelecek
      // Örnek: https://drive.google.com/drive/folders/FOLDER_ID
      const driveBaseUrl = 'https://drive.google.com/drive/search?q=';
      const searchQuery = encodeURIComponent(policyNo);
      const driveUrl = driveBaseUrl + searchQuery;

      // Yeni sekmede aç
      window.open(driveUrl, '_blank');
    }

    // ═══════════════════════════════════════════════════════════════
    // CUSTOMER MODAL
    // ═══════════════════════════════════════════════════════════════

    async function openCustomerModal(customerName, policyId) {
      const modal = document.getElementById('customerModal');
      const modalBody = document.getElementById('customerModalBody');

      // Loading state
      modalBody.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <div class="loading-spinner" style="display: inline-block;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 11-6.219-8.56"/>
            </svg>
          </div>
          <p style="margin-top: 1rem; opacity: 0.7;">Müşteri bilgisi yükleniyor...</p>
        </div>
      `;
      modal.classList.add('active');

      try {
        const customer = await apiGet('customers/search', { name: customerName });

        if (customer && customer.hasCard) {
          // Müşteri kartı mevcut
          const initials = customerName.split(' ').map(n => n[0]).join('');
          const collectionRate = customer.collectionRate || 0;
          modalBody.innerHTML = `
            <div class="customer-card-found">
              <div class="customer-avatar-large">${initials}</div>
              <h4>${customer.name || customerName}</h4>
              <div class="customer-tc">${customer.tc || ''}</div>
              <span class="badge badge-success">Müşteri Kartı Mevcut</span>

              <div class="customer-stats">
                <div class="customer-stat">
                  <div class="customer-stat-value">${customer.policies?.count || customer.policyCount || 0}</div>
                  <div class="customer-stat-label">Poliçe</div>
                </div>
                <div class="customer-stat">
                  <div class="customer-stat-value">${APP_CONFIG.CURRENCY.format(customer.policies?.totalPremium || customer.totalPremium || 0)}</div>
                  <div class="customer-stat-label">Toplam Prim</div>
                </div>
                <div class="customer-stat">
                  <div class="customer-stat-value">%${collectionRate}</div>
                  <div class="customer-stat-label">Tahsilat</div>
                </div>
              </div>

              <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeCustomerModal()">Kapat</button>
                <button class="btn btn-primary" onclick="goToCustomerCard(${customer.id || 0})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                  Müşteri Kartına Git
                </button>
              </div>
            </div>
          `;
        } else {
          // Müşteri kartı yok
          const initials = customerName.split(' ').map(n => n[0]).join('');
          const tc = customer?.tc || '';
          modalBody.innerHTML = `
            <div class="customer-not-found">
              <div class="empty-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                  <line x1="12" y1="11" x2="12" y2="17"/>
                  <line x1="9" y1="14" x2="15" y2="14"/>
                </svg>
              </div>
              <h4>Müşteri Kartı Bulunamadı</h4>
              <p><strong>${customerName}</strong> için sistemde kayıtlı müşteri kartı bulunmuyor.</p>

              <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 14px; margin-bottom: 1rem; text-align: left; border: 1px solid rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <span style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">Müşteri Adı:</span>
                  <span style="font-weight: 600; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">${customerName}</span>
                </div>
                ${tc ? `<div style="display: flex; justify-content: space-between;">
                  <span style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">TC/VKN:</span>
                  <span style="font-family: 'JetBrains Mono', monospace; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">${tc}</span>
                </div>` : ''}
              </div>

              <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeCustomerModal()">Kapat</button>
                <button class="btn btn-primary" onclick="createCustomerCard('${customerName}', '${tc}', ${policyId})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <line x1="20" y1="8" x2="20" y2="14"/>
                    <line x1="23" y1="11" x2="17" y2="11"/>
                  </svg>
                  Yeni Kart Oluştur
                </button>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Müşteri bilgisi alınamadı:', error);
        // Müşteri bulunamadı - oluşturma seçeneği sun
        const initials = customerName.split(' ').map(n => n[0]).join('');
        modalBody.innerHTML = `
          <div class="customer-not-found">
            <div class="empty-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
                <line x1="12" y1="11" x2="12" y2="17"/>
                <line x1="9" y1="14" x2="15" y2="14"/>
              </svg>
            </div>
            <h4>Müşteri Kartı Bulunamadı</h4>
            <p><strong>${customerName}</strong> için sistemde kayıtlı müşteri kartı bulunmuyor.</p>

            <div class="modal-actions">
              <button class="btn btn-secondary" onclick="closeCustomerModal()">Kapat</button>
              <button class="btn btn-primary" onclick="createCustomerCard('${customerName}', '', ${policyId})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                  <circle cx="8.5" cy="7" r="4"/>
                  <line x1="20" y1="8" x2="20" y2="14"/>
                  <line x1="23" y1="11" x2="17" y2="11"/>
                </svg>
                Yeni Kart Oluştur
              </button>
            </div>
          </div>
        `;
      }
    }

    function closeCustomerModal() {
      document.getElementById('customerModal').classList.remove('active');
    }

    function goToCustomerCard(customerId) {
      closeCustomerModal();
      // Müşteri kartı sayfasına yönlendir
      window.location.href = `../customers/list.html?id=${customerId}`;
    }

    // ═══════════════════════════════════════════════════════════════
    // YENİ MÜŞTERİ KARTI OLUŞTUR
    // ═══════════════════════════════════════════════════════════════
    async function createCustomerCard(customerName, tc, linkedPolicyId) {
      closeCustomerModal();

      // API ile müşteri oluşturmayı dene
      try {
        const result = await apiPost('customers', {
          name: customerName,
          tc: tc || '',
          linkedPolicyId: linkedPolicyId
        });

        if (result.success && result.customerId) {
          showToast('Müşteri kartı oluşturuldu', 'success');
          // Müşteri sayfasına yönlendir
          window.location.href = `../customers/list.html?id=${result.customerId}`;
        } else {
          // Manuel oluşturma için yönlendir
          window.location.href = `../customers/list.html?action=new&name=${encodeURIComponent(customerName)}&tc=${encodeURIComponent(tc || '')}`;
        }
      } catch (error) {
        console.error('Müşteri oluşturulamadı:', error);
        // Fallback: Müşteri sayfasına yönlendir
        window.location.href = `../customers/list.html?action=new&name=${encodeURIComponent(customerName)}&tc=${encodeURIComponent(tc || '')}`;
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // PRODUCER MODAL
    // ═══════════════════════════════════════════════════════════════

    async function openProducerModal(producerName, initials, color) {
      const modal = document.getElementById('producerModal');
      const modalBody = document.getElementById('producerModalBody');

      // Loading state
      modalBody.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <div class="loading-spinner" style="display: inline-block;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 11-6.219-8.56"/>
            </svg>
          </div>
          <p style="margin-top: 1rem; opacity: 0.7;">Prodüktör bilgisi yükleniyor...</p>
        </div>
      `;
      modal.classList.add('active');

      try {
        const producer = await apiGet('producers/search', { name: producerName });

        if (producer) {
          const pColor = producer.color || color;
          const pInitials = producer.initials || initials;
          const stats = producer.stats || {};
          const policyCount = stats.policyCount || 0;
          const totalPremium = stats.totalPremium || 0;
          const performance = stats.performance || 0;

          modalBody.innerHTML = `
            <div class="info-card">
              <div class="info-card-header">
                <div class="info-card-avatar" style="background: linear-gradient(135deg, ${getColorGradient(pColor)});">${pInitials}</div>
                <div class="info-card-details">
                  <h4>${producer.name || producerName}</h4>
                  <p>${producer.role || 'Prodüktör'} • ${producer.branchName || ''} Şubesi</p>
                </div>
              </div>

              <div class="info-card-stats">
                <div class="info-stat-item">
                  <div class="info-stat-value">${policyCount}</div>
                  <div class="info-stat-label">Poliçe (Bu Ay)</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${APP_CONFIG.CURRENCY.format(totalPremium)}</div>
                  <div class="info-stat-label">Prim (Bu Ay)</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${performance}%</div>
                  <div class="info-stat-label">Hedef</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${APP_CONFIG.CURRENCY.format(totalPremium * 0.076)}</div>
                  <div class="info-stat-label">Komisyon</div>
                </div>
              </div>

              <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeProducerModal()">Kapat</button>
                <button class="btn btn-primary" onclick="goToProducerPage(${producer.id || 0})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                  </svg>
                  Prodüktör Sayfası
                </button>
              </div>
            </div>
          `;
        } else {
          modalBody.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <p>Prodüktör bilgisi bulunamadı.</p>
              <button class="btn btn-secondary" onclick="closeProducerModal()">Kapat</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Prodüktör bilgisi alınamadı:', error);
        modalBody.innerHTML = `
          <div style="text-align: center; padding: 2rem;">
            <p>Prodüktör bilgisi yüklenirken hata oluştu.</p>
            <button class="btn btn-secondary" onclick="closeProducerModal()">Kapat</button>
          </div>
        `;
      }
    }

    function closeProducerModal() {
      document.getElementById('producerModal').classList.remove('active');
    }

    function goToProducerPage(producerId) {
      closeProducerModal();
      window.location.href = `../employees/list.html?id=${producerId}`;
    }

    // ═══════════════════════════════════════════════════════════════
    // BRANCH MODAL
    // ═══════════════════════════════════════════════════════════════

    async function openBranchModal(branchName) {
      const modal = document.getElementById('branchModal');
      const modalBody = document.getElementById('branchModalBody');

      // Loading state
      modalBody.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <div class="loading-spinner" style="display: inline-block;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 11-6.219-8.56"/>
            </svg>
          </div>
          <p style="margin-top: 1rem; opacity: 0.7;">Şube bilgisi yükleniyor...</p>
        </div>
      `;
      modal.classList.add('active');

      try {
        const branch = await apiGet('branches/search', { name: branchName });

        if (branch) {
          const initials = (branch.name || branchName).substring(0, 2).toUpperCase();
          const stats = branch.stats || {};
          const employeeCount = stats.employeeCount || 0;
          const policyCount = stats.policyCount || 0;
          const totalPremium = stats.totalPremium || 0;
          const avgPremium = policyCount > 0 ? Math.round(totalPremium / policyCount) : 0;

          modalBody.innerHTML = `
            <div class="info-card">
              <div class="info-card-header">
                <div class="info-card-avatar" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">${initials}</div>
                <div class="info-card-details">
                  <h4>${branch.name || branchName} Şubesi</h4>
                  <p>Şube Müdürü: ${branch.manager || 'Belirtilmemiş'}</p>
                </div>
              </div>

              ${branch.address ? `
              <div style="background: rgba(255, 255, 255, 0.1); padding: 0.75rem 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);">
                <div style="display: flex; align-items: center; gap: 0.5rem; color: rgba(255, 255, 255, 0.8); font-size: 0.85rem;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.7;">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                  </svg>
                  ${branch.address}
                </div>
              </div>
              ` : ''}

              <div class="info-card-stats">
                <div class="info-stat-item">
                  <div class="info-stat-value">${employeeCount}</div>
                  <div class="info-stat-label">Çalışan</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${policyCount}</div>
                  <div class="info-stat-label">Poliçe (Bu Ay)</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${APP_CONFIG.CURRENCY.format(totalPremium)}</div>
                  <div class="info-stat-label">Prim (Bu Ay)</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${APP_CONFIG.CURRENCY.format(avgPremium)}</div>
                  <div class="info-stat-label">Ort. Prim</div>
                </div>
              </div>

              <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeBranchModal()">Kapat</button>
                <button class="btn btn-primary" onclick="goToBranchPage(${branch.id || 0})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                    <polyline points="9,22 9,12 15,12 15,22"/>
                  </svg>
                  Şube Sayfası
                </button>
              </div>
            </div>
          `;
        } else {
          modalBody.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <p>Şube bilgisi bulunamadı.</p>
              <button class="btn btn-secondary" onclick="closeBranchModal()">Kapat</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Şube bilgisi alınamadı:', error);
        modalBody.innerHTML = `
          <div style="text-align: center; padding: 2rem;">
            <p>Şube bilgisi yüklenirken hata oluştu.</p>
            <button class="btn btn-secondary" onclick="closeBranchModal()">Kapat</button>
          </div>
        `;
      }
    }

    function closeBranchModal() {
      document.getElementById('branchModal').classList.remove('active');
    }

    function goToBranchPage(branchId) {
      closeBranchModal();
      window.location.href = `../employees/list.html?branchId=${branchId}`;
    }

    // Helper function for color gradients
    function getColorGradient(color) {
      const gradients = {
        'emerald': '#10b981, #059669',
        'cyan': '#06b6d4, #0891b2',
        'violet': '#8b5cf6, #7c3aed',
        'amber': '#f59e0b, #d97706'
      };
      return gradients[color] || '#6366f1, #4f46e5';
    }

    // Close modals when clicking overlay
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
        }
      });
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(modal => {
          modal.classList.remove('active');
        });
      }
    });
  </script>
  <script src="../../components/sidebar.js"></script>
</body>
</html>
