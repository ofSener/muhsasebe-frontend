<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poliçe Havuzu - IHSAN AI</title>
  <link rel="stylesheet" href="../../assets/css/main.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
  <!-- Global Config & API Helper -->
  <script src="../../assets/js/config.js"></script>
</head>
<body>
  <div class="gradient-mesh"></div>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar"></aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Navbar -->
      <nav class="navbar">
        <div class="navbar-left">
          <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Menü">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </button>
          <div class="navbar-breadcrumb">
            <span class="breadcrumb-item">Poliçe İşlemleri</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Poliçe Havuzu</span>
          </div>
        </div>
        <div class="navbar-right">
          <button class="navbar-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 01-3.46 0"/>
            </svg>
            <span class="badge">3</span>
          </button>
          <div class="navbar-divider"></div>
          <div class="navbar-user">
            <div class="navbar-avatar"></div>
            <div class="navbar-user-info">
              <div class="navbar-user-name">Yükleniyor...</div>
              <div class="navbar-user-role"></div>
            </div>
          </div>
        </div>
      </nav>

      <!-- Page Wrapper -->
      <div class="page-wrapper">
        <!-- Page Content -->
        <div class="page-content">
          <!-- Ana Sekmeler -->
          <div class="main-tabs-container">
            <div class="main-tabs">
              <button class="main-tab active" data-source="pending" onclick="switchMainTab('pending', this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
                <span>Bekleyen İşlemler</span>
                <span class="main-tab-count" id="pendingTabCount">-</span>
              </button>
              <button class="main-tab" data-source="matched" onclick="switchMainTab('matched', this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                  <polyline points="22,4 12,14.01 9,11.01"/>
                </svg>
                <span>Eşleşen Poliçeler</span>
                <span class="main-tab-count" id="matchedTabCount">-</span>
              </button>
              <button class="main-tab" data-source="unmatched-captured" onclick="switchMainTab('unmatched-captured', this)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="8" x2="12" y2="12"/>
                  <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span>Eşleşmeyenler</span>
                <span class="main-tab-count" id="unmatchedCapturedTabCount">-</span>
              </button>
            </div>
          </div>

          <!-- Page Header (Pool için) -->
          <div class="page-header-extended" id="poolHeader" style="display: block;">
            <div class="page-header-top">
              <div>
                <h1 class="page-title" id="pageTitle">Poliçe Havuzu</h1>
                <p class="page-subtitle" id="pageSubtitle">Havuzdaki poliçelerin eşleşme durumları</p>
              </div>
              <div class="page-actions">
                <button class="btn btn-secondary" onclick="refreshPoolData()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23,4 23,10 17,10"/>
                    <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
                  </svg>
                  Yenile
                </button>
              </div>
            </div>
          </div>


          <!-- Poliçe Havuzu İçeriği -->
          <div id="poolContent">
            <!-- Dinamik olarak yüklenir -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Floating Action Box -->
  <div class="floating-action-box" id="floatingActionBox">
    <div class="fab-header">
      <div class="fab-count">
        <span id="fabCount">0</span>
        <small>poliçe seçildi</small>
      </div>
      <button class="fab-close" onclick="clearSelection()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="fab-stats">
      <div class="fab-stat">
        <span class="fab-stat-value" id="fabTotalPremium">₺0</span>
        <span class="fab-stat-label">Toplam Prim</span>
      </div>
    </div>
    <div class="fab-actions">
      <button class="fab-btn fab-btn-primary" onclick="sendSelectedToPool()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14"/>
          <path d="M12 5l7 7-7 7"/>
        </svg>
        Havuza Gönder
      </button>
      <button class="fab-btn fab-btn-secondary" onclick="viewSelectedPolicies()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        Detayları Gör
      </button>
      <button class="fab-btn fab-btn-outline" onclick="exportSelectedPolicies()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="7,10 12,15 17,10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Excel'e Aktar
      </button>
    </div>
  </div>

  <!-- Customer Modal -->
  <div class="modal-overlay" id="customerModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Müşteri Kartı</h3>
        <button class="modal-close" onclick="closeCustomerModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="customerModalBody">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <!-- Producer Modal -->
  <div class="modal-overlay" id="producerModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Prodüktör Bilgisi</h3>
        <button class="modal-close" onclick="closeProducerModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="producerModalBody">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <!-- Branch Modal -->
  <div class="modal-overlay" id="branchModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Şube Bilgisi</h3>
        <button class="modal-close" onclick="closeBranchModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="branchModalBody">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <!-- Edit Policy Modal -->
  <div class="modal-overlay" id="editPolicyModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">Poliçe Düzenle</h3>
        <button class="modal-close" onclick="closeEditPolicyModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="editPolicyModalBody">
        <form id="editPolicyForm" onsubmit="saveEditedPolicy(event)">
          <input type="hidden" id="editPolicyId">

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Poliçe No</label>
              <input type="text" class="form-control mono" id="editPolicyNo" maxlength="25">
            </div>
            <div class="form-group">
              <label class="form-label">Müşteri</label>
              <input type="text" class="form-control" id="editCustomer" readonly style="background: rgba(255,255,255,0.05);">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Poliçe Tipi</label>
              <select class="form-control" id="editType">
                <!-- Dinamik doldurulacak -->
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Tanzim Tarihi</label>
              <input type="date" class="form-control" id="editDate">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Net Prim (₺)</label>
              <input type="number" step="0.01" class="form-control mono" id="editNetPremium">
            </div>
            <div class="form-group">
              <label class="form-label">Brüt Prim (₺)</label>
              <input type="number" step="0.01" class="form-control mono" id="editGrossPremium">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Prodüktör</label>
              <select class="form-control" id="editProducer">
                <!-- Dinamik doldurulacak -->
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Şube</label>
              <select class="form-control" id="editBranch">
                <!-- Dinamik doldurulacak -->
              </select>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeEditPolicyModal()">İptal</button>
            <button type="submit" class="btn btn-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                <polyline points="17,21 17,13 7,13 7,21"/>
                <polyline points="7,3 7,8 15,8"/>
              </svg>
              Kaydet
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Unmatched (Eşleşmeyen) Policy Modal -->
  <div class="modal-overlay" id="editUnmatchedModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title">Eşleşmeyen Poliçe Düzenle</h3>
        <button class="modal-close" onclick="closeEditUnmatchedModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="editUnmatchedModalBody">
        <form id="editUnmatchedForm" onsubmit="saveEditedUnmatched(event)">
          <input type="hidden" id="editUnmatchedId">

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Poliçe No</label>
              <input type="text" class="form-control mono" id="editUnmatchedPoliceNo" readonly style="background: rgba(255,255,255,0.05);">
            </div>
            <div class="form-group">
              <label class="form-label">Sigortalı Adı</label>
              <input type="text" class="form-control" id="editUnmatchedSigortali" readonly style="background: rgba(255,255,255,0.05);">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Prodüktör <span style="color: var(--danger);">*</span></label>
              <select class="form-control" id="editUnmatchedProduktor" required>
                <option value="">Prodüktör Seçin</option>
                <!-- Dinamik doldurulacak -->
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Şube <span style="color: var(--danger);">*</span></label>
              <select class="form-control" id="editUnmatchedSube" required>
                <option value="">Şube Seçin</option>
                <!-- Dinamik doldurulacak -->
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Branş</label>
              <input type="text" class="form-control" id="editUnmatchedBrans" readonly style="background: rgba(255,255,255,0.05);">
            </div>
            <div class="form-group">
              <label class="form-label">Sigorta Şirketi</label>
              <input type="text" class="form-control" id="editUnmatchedSirket" readonly style="background: rgba(255,255,255,0.05);">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Net Prim (₺)</label>
              <input type="text" class="form-control mono" id="editUnmatchedNetPrim" readonly style="background: rgba(255,255,255,0.05);">
            </div>
            <div class="form-group">
              <label class="form-label">Brüt Prim (₺)</label>
              <input type="text" class="form-control mono" id="editUnmatchedBrutPrim" readonly style="background: rgba(255,255,255,0.05);">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Tanzim Tarihi</label>
              <input type="text" class="form-control" id="editUnmatchedTanzim" readonly style="background: rgba(255,255,255,0.05);">
            </div>
            <div class="form-group">
              <label class="form-label">Başlangıç Tarihi</label>
              <input type="text" class="form-control" id="editUnmatchedBaslangic" readonly style="background: rgba(255,255,255,0.05);">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Bitiş Tarihi</label>
              <input type="text" class="form-control" id="editUnmatchedBitis" readonly style="background: rgba(255,255,255,0.05);">
            </div>
            <div class="form-group">
              <label class="form-label">Eklenme Tarihi</label>
              <input type="text" class="form-control" id="editUnmatchedEklenme" readonly style="background: rgba(255,255,255,0.05);">
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeEditUnmatchedModal()">İptal</button>
            <button type="submit" class="btn btn-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                <polyline points="17,21 17,13 7,13 7,21"/>
                <polyline points="7,3 7,8 15,8"/>
              </svg>
              Kaydet
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="../../assets/js/app.js"></script>
  <script src="../../assets/js/date-filter-utils.js"></script>
  <style>
    /* ═══════════════════════════════════════════════════════════════
       MAIN TABS - Ana Sekmeler
       ═══════════════════════════════════════════════════════════════ */
    .main-tabs-container {
      margin-bottom: 1.5rem;
    }

    .main-tabs {
      display: flex;
      gap: 0.5rem;
      background: var(--bg-surface, var(--bg-card));
      padding: 0.5rem;
      border-radius: 16px;
      border: 1px solid var(--border-color);
    }

    .main-tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      background: transparent;
      border: 2px solid transparent;
      border-radius: 12px;
      color: var(--text-muted);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .main-tab:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .main-tab.active {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
      border-color: var(--primary);
      color: var(--primary);
    }

    .main-tab svg {
      flex-shrink: 0;
    }

    .main-tab-count {
      background: var(--bg-elevated);
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8125rem;
      font-weight: 700;
      color: var(--text-muted);
    }

    .main-tab.active .main-tab-count {
      background: var(--primary);
      color: white;
    }

    /* Pool Content - her zaman görünür (tek sekme kaldı) */
    #poolContent {
      display: block;
    }

    #capturedContent.hidden {
      display: none;
    }

    /* Page Header Extended */
    .page-header-extended {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
    }

    .page-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .page-header-top .page-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .page-header-top .page-subtitle {
      margin: 0.25rem 0 0 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .page-header-filter {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    /* Date Presets */
    .date-presets {
      display: flex;
      gap: 0.5rem;
    }

    .date-preset-btn {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .date-preset-btn:hover {
      color: var(--text-primary);
      border-color: var(--primary);
    }

    .date-preset-btn.active {
      color: #ffffff !important;
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%) !important;
      border-color: #6366f1 !important;
      font-weight: 600 !important;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4), 0 2px 4px rgba(99, 102, 241, 0.2) !important;
      transform: translateY(-1px);
    }

    .date-preset-btn .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(99, 102, 241, 0.3);
      transform: scale(0);
      animation: ripple 0.6s linear;
      pointer-events: none;
    }

    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    /* Date Range Picker */
    .date-range-picker {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .date-range-picker:hover,
    .date-range-picker.active {
      border-color: var(--primary);
    }

    .date-range-picker svg {
      width: 18px;
      height: 18px;
      color: var(--text-muted);
    }

    .date-range-picker input {
      border: none;
      background: transparent;
      font-size: 0.8rem;
      color: var(--text-primary);
      width: 200px;
      cursor: pointer;
    }

    .date-range-picker input:focus {
      outline: none;
    }

    .date-range-picker .picker-arrow {
      width: 14px;
      height: 14px;
      transition: transform 0.2s ease;
    }

    .date-range-picker.active .picker-arrow {
      transform: rotate(180deg);
    }

    /* Card Header */
    .card-header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .card-header-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    /* Table Search */
    .table-search {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    .table-search svg {
      color: var(--text-muted);
    }

    .table-search input {
      border: none;
      background: transparent;
      font-size: 0.8rem;
      color: var(--text-primary);
      width: 150px;
    }

    .table-search input:focus {
      outline: none;
    }

    /* Custom Dropdown */
    .custom-dropdown {
      position: relative;
    }

    .dropdown-trigger {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.8rem;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 160px;
    }

    .dropdown-trigger:hover {
      border-color: var(--primary);
      background: var(--bg-card);
    }

    .dropdown-trigger svg:first-child {
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .dropdown-trigger span {
      flex: 1;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dropdown-arrow {
      color: var(--text-muted);
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }

    .custom-dropdown.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .dropdown-panel {
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      width: 240px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12), 0 4px 12px rgba(0, 0, 0, 0.08);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
    }

    .custom-dropdown.open .dropdown-panel {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-search {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      border-bottom: 1px solid #e2e8f0;
      background: #f8fafc;
      border-radius: 12px 12px 0 0;
    }

    .dropdown-search svg {
      color: #94a3b8;
      flex-shrink: 0;
    }

    .dropdown-search input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 0.8rem;
      color: #1e293b;
      outline: none;
    }

    .dropdown-search input::placeholder {
      color: #94a3b8;
    }

    .dropdown-list {
      max-height: 240px;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .dropdown-list::-webkit-scrollbar {
      width: 6px;
    }

    .dropdown-list::-webkit-scrollbar-track {
      background: #f8fafc;
    }

    .dropdown-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .dropdown-list::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.625rem 0.75rem;
      border-radius: 8px;
      font-size: 0.8rem;
      color: #334155;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .dropdown-item:hover {
      background: #f1f5f9;
    }

    .dropdown-item.selected {
      background: #eef2ff;
      color: #4f46e5;
    }

    .dropdown-item-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }

    .dropdown-item-avatar.all {
      background: linear-gradient(135deg, #64748b, #475569);
    }

    .dropdown-item-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dropdown-item-check {
      opacity: 0;
      color: #6366f1;
      flex-shrink: 0;
    }

    .dropdown-item.selected .dropdown-item-check {
      opacity: 1;
    }

    .dropdown-empty {
      padding: 1.5rem;
      text-align: center;
      color: #94a3b8;
      font-size: 0.8rem;
    }

    /* Table Styles */
    .data-table th.sortable {
      cursor: pointer;
      user-select: none;
    }

    .data-table th.sortable:hover {
      background: var(--bg-elevated);
    }

    .data-table th.sortable svg {
      margin-left: 0.25rem;
      opacity: 0.5;
      vertical-align: middle;
    }

    .data-table th.sortable.asc svg path:first-child,
    .data-table th.sortable.desc svg path:last-child {
      opacity: 1;
      stroke: var(--primary);
    }

    .data-table tbody tr {
      transition: background 0.15s ease;
      cursor: pointer;
    }

    .data-table tbody tr:hover {
      background: var(--bg-elevated);
    }

    .data-table tbody tr.selected {
      background: var(--primary-glow);
    }

    .data-table tbody tr.selected:hover {
      background: rgba(99, 102, 241, 0.15);
    }

    .data-table input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    .data-table tbody input[type="checkbox"] {
      pointer-events: none;
    }

    .data-table thead input[type="checkbox"] {
      pointer-events: auto;
      cursor: pointer;
    }

    .data-table tbody tr td:first-child {
      position: relative;
    }

    .data-table tbody tr td:first-child::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--primary);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .data-table tbody tr.selected td:first-child::before {
      opacity: 1;
    }

    /* Policy Badge */
    .policy-type-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      border-radius: 6px;
    }

    .policy-type-badge.kasko {
      background: rgba(99, 102, 241, 0.15);
      color: #6366f1;
    }

    .policy-type-badge.trafik {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    .policy-type-badge.dask {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .policy-type-badge.saglik {
      background: rgba(236, 72, 153, 0.15);
      color: #ec4899;
    }

    .policy-type-badge.konut {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
    }

    /* Producer Avatar */
    .producer-cell {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .producer-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .producer-avatar.emerald { background: linear-gradient(135deg, #10b981, #059669); }
    .producer-avatar.cyan { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    .producer-avatar.violet { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .producer-avatar.amber { background: linear-gradient(135deg, #f59e0b, #d97706); }

    .producer-info {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .producer-name {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .producer-branch {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    /* Action Buttons */
    .table-actions {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-elevated);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
    }

    .action-btn:hover {
      background: var(--primary-glow);
    }

    .action-btn:hover svg {
      color: var(--primary);
    }

    .action-btn.send:hover {
      background: rgba(16, 185, 129, 0.15);
    }

    .action-btn.send:hover svg {
      color: #10b981;
    }

    /* Card Footer */
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--border-color);
      background: var(--bg-elevated);
      gap: 1rem;
      flex-wrap: wrap;
    }

    .table-footer-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .table-info {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Pagination Controls */
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      flex-wrap: wrap;
    }

    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .page-size-selector label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .page-size-selector select {
      padding: 0.35rem 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .page-size-selector select:hover {
      border-color: var(--primary);
    }

    .page-size-selector select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .page-navigation {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .page-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-card);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .page-btn:hover:not(:disabled) {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }

    .page-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .page-btn svg {
      width: 16px;
      height: 16px;
    }

    .page-numbers {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .page-number {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
      padding: 0 0.5rem;
      border: 1px solid transparent;
      border-radius: 6px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .page-number:hover {
      background: rgba(99, 102, 241, 0.08);
      color: var(--primary);
    }

    .page-number.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .page-ellipsis {
      color: var(--text-muted);
      padding: 0 0.25rem;
    }

    /* Clickable Links in Table */
    .clickable-link {
      color: var(--primary);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.5rem;
      margin: -0.25rem -0.5rem;
      border-radius: 6px;
      background: rgba(99, 102, 241, 0.08);
      border-bottom: 1px dashed rgba(99, 102, 241, 0.4);
    }

    .clickable-link:hover {
      color: #fff;
      background: var(--primary);
      border-bottom-color: transparent;
    }

    .clickable-link svg {
      width: 12px;
      height: 12px;
      opacity: 0.6;
      transition: all 0.2s ease;
    }

    .clickable-link:hover svg {
      opacity: 1;
    }

    .clickable-customer {
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0.25rem 0.5rem;
      margin: -0.25rem -0.5rem;
      border-radius: 6px;
      border-bottom: 1px dashed rgba(99, 102, 241, 0.3);
      position: relative;
    }

    .clickable-customer::after {
      content: '';
      position: absolute;
      right: -4px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      background: var(--primary);
      border-radius: 50%;
      opacity: 0.6;
    }

    .clickable-customer:hover {
      color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      border-bottom-color: var(--primary);
    }

    .clickable-customer:hover::after {
      opacity: 1;
      animation: pulse-dot 1s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { transform: translateY(-50%) scale(1); }
      50% { transform: translateY(-50%) scale(1.3); }
    }

    .clickable-producer {
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0.125rem 0.375rem;
      margin: -0.125rem -0.375rem;
      border-radius: 4px;
      border-bottom: 1px dashed rgba(99, 102, 241, 0.3);
    }

    .clickable-producer:hover {
      color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      border-bottom-color: var(--primary);
    }

    .clickable-branch {
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0.125rem 0.375rem;
      margin: -0.125rem -0.375rem;
      border-radius: 4px;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .clickable-branch::before {
      content: '';
      width: 4px;
      height: 4px;
      background: currentColor;
      border-radius: 50%;
      opacity: 0.5;
    }

    .clickable-branch:hover {
      color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .clickable-branch:hover::before {
      background: var(--primary);
      opacity: 1;
    }

    /* Modal Styles - Apple Glass Effect */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(50px) saturate(200%);
      -webkit-backdrop-filter: blur(50px) saturate(200%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 28px;
      width: 90%;
      max-width: 440px;
      max-height: 90vh;
      overflow: hidden;
      transform: scale(0.9) translateY(20px);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.1) inset,
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 80px rgba(99, 102, 241, 0.15);
      position: relative;
    }

    .modal::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.4) 50%,
        transparent 100%
      );
    }

    .modal::after {
      content: '';
      position: absolute;
      top: 0;
      left: 20%;
      right: 20%;
      height: 2px;
      background: linear-gradient(90deg,
        #6366f1,
        #8b5cf6,
        #ec4899,
        #f59e0b,
        #10b981
      );
      border-radius: 0 0 2px 2px;
      opacity: 0.8;
    }

    .modal-overlay.active .modal {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      margin: 0;
      letter-spacing: -0.02em;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.7);
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .modal-close:hover {
      background: rgba(239, 68, 68, 0.3);
      color: #fff;
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      max-height: calc(90vh - 80px);
    }

    /* Glass Card Content Override */
    .modal .customer-card-found,
    .modal .customer-not-found,
    .modal .info-card {
      color: #fff;
    }

    .modal .customer-card-found h4,
    .modal .customer-not-found h4,
    .modal .info-card-details h4 {
      color: #fff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .modal .customer-tc,
    .modal .customer-not-found p,
    .modal .info-card-details p {
      color: rgba(255, 255, 255, 0.7);
    }

    .modal .customer-avatar-large {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.7), rgba(139, 92, 246, 0.7));
      box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal .customer-stats {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(10px);
    }

    .modal .info-card-stats .info-stat-item {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    .modal .customer-stat-value,
    .modal .info-stat-value {
      color: #fff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .modal .customer-stat-label,
    .modal .info-stat-label {
      color: rgba(255, 255, 255, 0.6);
    }

    .modal .badge-success {
      background: rgba(16, 185, 129, 0.25);
      color: #6ee7b7;
      border: 1px solid rgba(16, 185, 129, 0.4);
      backdrop-filter: blur(10px);
    }

    .modal .empty-icon {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid rgba(245, 158, 11, 0.3);
      backdrop-filter: blur(10px);
    }

    .modal .modal-actions .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }

    .modal .modal-actions .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.18);
      color: #fff;
    }

    .modal .modal-actions .btn-primary {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.8));
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.35);
      backdrop-filter: blur(10px);
    }

    .modal .modal-actions .btn-primary:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.95), rgba(139, 92, 246, 0.95));
      transform: translateY(-1px);
      box-shadow: 0 6px 28px rgba(99, 102, 241, 0.5);
    }

    .modal .info-card-avatar {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    /* Customer Card in Modal */
    .customer-card-found {
      text-align: center;
      padding: 1rem;
    }

    .customer-card-found .customer-avatar-large {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 700;
      color: white;
      margin: 0 auto 1rem;
      background: linear-gradient(135deg, var(--primary), #4f46e5);
    }

    .customer-card-found h4 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 0.25rem 0;
    }

    .customer-card-found .customer-tc {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
      margin-bottom: 1rem;
    }

    .customer-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin: 1rem 0;
      padding: 1rem;
      background: var(--bg-elevated);
      border-radius: 12px;
    }

    .customer-stat {
      text-align: center;
    }

    .customer-stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .customer-stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* Customer Not Found */
    .customer-not-found {
      text-align: center;
      padding: 1rem;
    }

    .customer-not-found .empty-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .customer-not-found h4 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 0.5rem 0;
    }

    .customer-not-found p {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 0 0 1.5rem 0;
    }

    /* Producer/Branch Info */
    .info-card {
      padding: 1rem;
    }

    .info-card-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    .info-card-avatar {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: 700;
      color: white;
    }

    .info-card-details h4 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 0.25rem 0;
    }

    .info-card-details p {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 0;
    }

    .info-card-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .info-stat-item {
      padding: 0.875rem;
      background: var(--bg-elevated);
      border-radius: 10px;
      text-align: center;
    }

    .info-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .info-stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.125rem;
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .modal-actions .btn {
      flex: 1;
    }

    /* ═══════════════════════════════════════════════════════════════
       MODERN KPI CARDS - LIGHT THEME
       ═══════════════════════════════════════════════════════════════ */

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.25rem;
    }

    .kpi-card {
      position: relative;
      background: var(--bg-surface, #ffffff);
      border: 1px solid var(--border-subtle, rgba(148, 163, 184, 0.2));
      border-radius: 20px;
      padding: 1.5rem;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--card-shadow, 0 1px 3px rgba(0, 0, 0, 0.04));
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      border-color: var(--border-default, rgba(148, 163, 184, 0.3));
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08), 0 4px 8px rgba(0, 0, 0, 0.04);
    }

    /* Background glow effect */
    .kpi-card-bg {
      position: absolute;
      top: -50%;
      right: -30%;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.12;
      transition: opacity 0.3s ease;
    }

    .kpi-card:hover .kpi-card-bg {
      opacity: 0.2;
    }

    /* Color variants - Amber */
    .kpi-card.kpi-amber .kpi-card-bg { background: #f59e0b; }
    .kpi-card.kpi-amber .kpi-icon { background: rgba(245, 158, 11, 0.12); color: #d97706; }
    .kpi-card.kpi-amber .kpi-trend { background: rgba(245, 158, 11, 0.1); color: #b45309; }
    .kpi-card.kpi-amber .kpi-value { color: #92400e; }
    .kpi-card.kpi-amber:hover { border-color: rgba(245, 158, 11, 0.3); }

    /* Color variants - Violet */
    .kpi-card.kpi-violet .kpi-card-bg { background: #8b5cf6; }
    .kpi-card.kpi-violet .kpi-icon { background: rgba(139, 92, 246, 0.12); color: #7c3aed; }
    .kpi-card.kpi-violet .kpi-trend { background: rgba(139, 92, 246, 0.1); color: #6d28d9; }
    .kpi-card.kpi-violet .kpi-value { color: #5b21b6; }
    .kpi-card.kpi-violet .kpi-progress-bar { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
    .kpi-card.kpi-violet:hover { border-color: rgba(139, 92, 246, 0.3); }

    /* Color variants - Emerald */
    .kpi-card.kpi-emerald .kpi-card-bg { background: #10b981; }
    .kpi-card.kpi-emerald .kpi-icon { background: rgba(16, 185, 129, 0.12); color: #059669; }
    .kpi-card.kpi-emerald .kpi-badge { background: rgba(16, 185, 129, 0.12); color: #047857; border-color: rgba(16, 185, 129, 0.25); }
    .kpi-card.kpi-emerald .kpi-value { color: #065f46; }
    .kpi-card.kpi-emerald:hover { border-color: rgba(16, 185, 129, 0.3); }

    /* Color variants - Cyan */
    .kpi-card.kpi-cyan .kpi-card-bg { background: #06b6d4; }
    .kpi-card.kpi-cyan .kpi-icon { background: rgba(6, 182, 212, 0.12); color: #0891b2; }
    .kpi-card.kpi-cyan .kpi-trend { background: rgba(6, 182, 212, 0.1); color: #0e7490; }
    .kpi-card.kpi-cyan .kpi-value { color: #155e75; }
    .kpi-card.kpi-cyan:hover { border-color: rgba(6, 182, 212, 0.3); }

    /* Color variants - Blue (Bekleyen) */
    .kpi-card.kpi-blue .kpi-card-bg { background: #3b82f6; }
    .kpi-card.kpi-blue .kpi-icon { background: rgba(59, 130, 246, 0.12); color: #2563eb; }
    .kpi-card.kpi-blue .kpi-trend { background: rgba(59, 130, 246, 0.1); color: #1d4ed8; }
    .kpi-card.kpi-blue .kpi-value { color: #1e40af; }
    .kpi-card.kpi-blue:hover { border-color: rgba(59, 130, 246, 0.3); }

    /* Color variants - Purple (Toplam Prim) */
    .kpi-card.kpi-purple .kpi-card-bg { background: #8b5cf6; }
    .kpi-card.kpi-purple .kpi-icon { background: rgba(139, 92, 246, 0.12); color: #7c3aed; }
    .kpi-card.kpi-purple .kpi-trend { background: rgba(139, 92, 246, 0.1); color: #6d28d9; }
    .kpi-card.kpi-purple .kpi-value { color: #5b21b6; }
    .kpi-card.kpi-purple:hover { border-color: rgba(139, 92, 246, 0.3); }

    /* Header */
    .kpi-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
      position: relative;
      z-index: 1;
    }

    .kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .kpi-card:hover .kpi-icon {
      transform: scale(1.05);
    }

    .kpi-icon svg {
      width: 24px;
      height: 24px;
    }

    /* Trend indicator */
    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.625rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .kpi-trend svg {
      width: 14px;
      height: 14px;
    }

    .kpi-trend-up { background: rgba(16, 185, 129, 0.1); color: #059669; }
    .kpi-trend-down { background: rgba(239, 68, 68, 0.1); color: #dc2626; }

    /* Badge */
    .kpi-badge {
      padding: 0.375rem 0.75rem;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border: 1px solid;
    }

    /* Body */
    .kpi-body {
      position: relative;
      z-index: 1;
      margin-bottom: 1rem;
    }

    .kpi-value {
      font-size: 2.25rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.1;
      margin-bottom: 0.375rem;
    }

    .kpi-label {
      font-size: 0.85rem;
      color: var(--text-muted, #64748b);
      font-weight: 500;
    }

    /* Footer */
    .kpi-footer {
      position: relative;
      z-index: 1;
      padding-top: 1rem;
      border-top: 1px solid var(--border-subtle, rgba(148, 163, 184, 0.2));
    }

    .kpi-sub {
      font-size: 0.75rem;
      color: var(--text-dim, #94a3b8);
    }

    /* Progress bar */
    .kpi-progress {
      height: 4px;
      background: var(--bg-elevated, #f1f5f9);
      border-radius: 2px;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }

    .kpi-progress-bar {
      height: 100%;
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* Responsive */
    @media (max-width: 1280px) {
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }

      .kpi-card {
        padding: 1.25rem;
      }

      .kpi-value {
        font-size: 1.75rem;
      }
    }

    /* Floating Action Box - Modern Minimalist */
    .floating-action-box {
      position: fixed;
      right: -300px;
      top: 50%;
      transform: translateY(-50%);
      width: 260px;
      background: #1a1b23;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-right: none;
      border-radius: 16px 0 0 16px;
      padding: 1.5rem;
      z-index: 500;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: -8px 0 32px rgba(0, 0, 0, 0.4);
    }

    .floating-action-box.active {
      right: 0;
    }

    .fab-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1.25rem;
    }

    .fab-count {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .fab-count span {
      font-size: 2.5rem;
      font-weight: 800;
      color: #fff;
      line-height: 1;
      letter-spacing: -0.02em;
    }

    .fab-count small {
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 500;
    }

    .fab-close {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      transition: all 0.15s ease;
    }

    .fab-close:hover {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .fab-stats {
      margin-bottom: 1.25rem;
      padding: 1rem;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(99, 102, 241, 0.15);
    }

    .fab-stat {
      text-align: center;
    }

    .fab-stat-value {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      color: #a5b4fc;
      letter-spacing: -0.01em;
    }

    .fab-stat-label {
      display: block;
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .fab-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .fab-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
    }

    .fab-btn svg {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
    }

    .fab-btn-primary {
      background: #10b981;
      color: #fff;
    }

    .fab-btn-primary:hover {
      background: #059669;
      transform: translateY(-1px);
    }

    .fab-btn-secondary {
      background: #374151;
      color: #e5e7eb;
    }

    .fab-btn-secondary:hover {
      background: #4b5563;
    }

    .fab-btn-outline {
      background: transparent;
      color: #9ca3af;
      border: 1px solid #374151;
    }

    .fab-btn-outline:hover {
      background: #374151;
      color: #e5e7eb;
      border-color: #4b5563;
    }

    /* ═══════════════════════════════════════════════════════════════
       EDITABLE FIELDS & PERMISSION SYSTEM
       ═══════════════════════════════════════════════════════════════ */

    /* Permission Indicator Bar */
    .permission-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1.25rem;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border-color);
      font-size: 0.8rem;
    }

    .permission-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .permission-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.75rem;
    }

    .permission-badge.admin {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .permission-badge.editor {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .permission-badge.viewer {
      background: rgba(156, 163, 175, 0.15);
      color: #9ca3af;
      border: 1px solid rgba(156, 163, 175, 0.3);
    }

    .permission-badge svg {
      width: 14px;
      height: 14px;
    }

    .permission-text {
      color: var(--text-muted);
    }

    .permission-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .edit-mode-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .edit-mode-toggle:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
      transform: translateY(-1px);
    }

    .edit-mode-toggle.active {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .edit-mode-toggle.active:hover {
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
      transform: translateY(-2px);
    }

    .edit-mode-toggle svg {
      width: 16px;
      height: 16px;
    }

    .edit-mode-toggle .toggle-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9ca3af;
      transition: all 0.25s ease;
    }

    .edit-mode-toggle.active .toggle-indicator {
      background: #34d399;
      box-shadow: 0 0 8px #34d399;
      animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 8px #34d399; }
      50% { box-shadow: 0 0 16px #34d399, 0 0 24px rgba(52, 211, 153, 0.4); }
    }

    /* Edit mode active state for the whole card */
    .edit-mode .permission-bar {
      background: linear-gradient(90deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
      border-bottom-color: rgba(99, 102, 241, 0.2);
    }

    /* Edit mode banner */
    .edit-mode-banner {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .edit-mode-banner svg {
      width: 18px;
      height: 18px;
      animation: bounce-edit 1s infinite;
    }

    @keyframes bounce-edit {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    .edit-mode .edit-mode-banner {
      display: flex;
    }

    /* Editable Cell Styles */
    .editable-cell {
      position: relative;
      cursor: text;
      transition: all 0.15s ease;
      border-radius: 4px;
      padding: 0.25rem 0.375rem;
      margin: -0.25rem -0.375rem;
    }

    .editable-cell:hover {
      background: rgba(99, 102, 241, 0.08);
    }

    .editable-cell::after {
      content: '';
      position: absolute;
      right: 2px;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 4px;
      background: var(--primary);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .editable-cell:hover::after {
      opacity: 0.5;
    }

    .edit-mode .editable-cell {
      background: rgba(99, 102, 241, 0.05);
      border: 1px dashed rgba(99, 102, 241, 0.25);
    }

    .edit-mode .editable-cell:hover {
      background: rgba(99, 102, 241, 0.12);
      border-color: var(--primary);
    }

    .edit-mode .editable-cell::after {
      opacity: 0.3;
    }

    .edit-mode .editable-cell:hover::after {
      opacity: 1;
    }

    /* Inline Edit Input */
    .inline-edit-input {
      width: 100%;
      padding: 0.375rem 0.5rem;
      font-size: inherit;
      font-family: inherit;
      color: var(--text-primary);
      background: var(--bg-card);
      border: 2px solid var(--primary);
      border-radius: 6px;
      outline: none;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .inline-edit-input:focus {
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.25);
    }

    .inline-edit-input.mono {
      font-family: 'JetBrains Mono', monospace;
    }

    /* Select Dropdown for Editable */
    .inline-edit-select {
      width: 100%;
      padding: 0.375rem 0.5rem;
      font-size: inherit;
      font-family: inherit;
      color: var(--text-primary);
      background: var(--bg-card);
      border: 2px solid var(--primary);
      border-radius: 6px;
      outline: none;
      cursor: pointer;
    }

    /* Read-only cell (no permission) */
    .readonly-cell {
      position: relative;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .readonly-cell::before {
      content: '';
      position: absolute;
      left: -4px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 3px;
      background: #6b7280;
      border-radius: 50%;
    }

    /* Edit Actions (save/cancel mini buttons) */
    .edit-actions {
      display: flex;
      gap: 0.25rem;
      margin-top: 0.375rem;
    }

    .edit-action-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .edit-action-btn.save {
      background: #10b981;
      color: white;
    }

    .edit-action-btn.save:hover {
      background: #059669;
    }

    .edit-action-btn.cancel {
      background: #6b7280;
      color: white;
    }

    .edit-action-btn.cancel:hover {
      background: #4b5563;
    }

    /* Field-level permission indicator */
    .field-locked {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: #6b7280;
    }

    .field-locked svg {
      width: 12px;
      height: 12px;
      opacity: 0.5;
    }

    /* Save All Changes Bar */
    .save-changes-bar {
      position: fixed;
      bottom: -80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      background: #1a1b23;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      z-index: 600;
      transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .save-changes-bar.active {
      bottom: 2rem;
    }

    .save-changes-bar .changes-count {
      color: #f59e0b;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .save-changes-bar .btn {
      padding: 0.625rem 1.25rem;
    }

    /* Row with pending changes */
    .data-table tbody tr.has-changes {
      background: rgba(245, 158, 11, 0.05);
    }

    .data-table tbody tr.has-changes td:first-child::before {
      background: #f59e0b;
      opacity: 1;
    }

    .data-table tbody tr.has-changes:hover {
      background: rgba(245, 158, 11, 0.1);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .page-header-filter {
        flex-direction: column;
        align-items: flex-start;
      }

      .date-presets {
        flex-wrap: wrap;
      }

      .permission-bar {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
      }
    }

    @media (max-width: 768px) {
      .page-header-top {
        flex-direction: column;
        gap: 1rem;
      }

      .card-header-right {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    /* ═══════════════════════════════════════════════════════════════
       POOL (AKTARIM HAVUZU) STYLES
       ═══════════════════════════════════════════════════════════════ */

    /* Pool Status Tabs */
    .pool-status-tabs {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .pool-status-tab {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .pool-status-tab:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-hover);
    }

    .pool-status-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .pool-status-tab .tab-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.125rem 0.5rem;
      border-radius: 10px;
      font-size: 0.75rem;
    }

    .pool-status-tab:not(.active) .tab-count {
      background: var(--bg-tertiary);
    }

    /* Pool Filters */
    .pool-filters {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
    }

    .pool-filter-row {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .pool-search {
      position: relative;
      flex: 1;
      min-width: 250px;
    }

    .pool-search svg {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .pool-search input {
      width: 100%;
      padding: 0.625rem 2.5rem 0.625rem 2.5rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .pool-search input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
    }

    .pool-search-clear {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .pool-search-clear:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .pool-filter-select {
      padding: 0.625rem 2rem 0.625rem 1rem;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.875rem;
      cursor: pointer;
      min-width: 150px;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      transition: all 0.15s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .pool-filter-select:hover {
      border-color: var(--primary);
      background-color: var(--bg-secondary);
    }

    .pool-filter-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
    }

    .pool-filter-actions {
      display: flex;
      gap: 0.5rem;
      margin-left: auto;
    }

    /* Pool Table Enhancements */
    #poolContent .data-table tbody tr.selected {
      background: rgba(var(--primary-rgb), 0.08);
    }

    #poolContent .data-table tbody tr.selected td {
      border-color: rgba(var(--primary-rgb), 0.2);
    }

    .action-buttons {
      display: flex;
      gap: 0.25rem;
    }

    .action-btn-success {
      color: var(--success) !important;
    }

    .action-btn-success:hover {
      background: rgba(var(--success-rgb, 34, 197, 94), 0.1) !important;
    }

    /* Pool Pagination */
    .pool-pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
    }

    .pagination-info {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .pagination-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .pagination-size {
      padding: 0.375rem 0.75rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .pagination-buttons {
      display: flex;
      gap: 0.25rem;
    }

    .pagination-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
      padding: 0 0.5rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--bg-tertiary);
      border-color: var(--border-hover);
    }

    .pagination-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-ellipsis {
      padding: 0 0.5rem;
      color: var(--text-muted);
    }

    /* Pool Floating Actions */
    .pool-floating-actions {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 1rem 1.5rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      z-index: 100;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .floating-count {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .floating-count .count-number {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
      padding: 0 0.5rem;
      background: var(--primary);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .floating-count .count-text {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .floating-buttons {
      display: flex;
      gap: 0.5rem;
    }

    /* Checkbox styling */
    .checkbox-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      min-width: 24px;
      min-height: 24px;
    }

    .checkbox-wrapper input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }

    .checkbox-custom {
      width: 18px;
      height: 18px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 4px;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .checkbox-wrapper:hover .checkbox-custom {
      border-color: var(--primary);
    }

    .checkbox-wrapper input:checked ~ .checkbox-custom {
      background: var(--primary);
      border-color: var(--primary);
    }

    .checkbox-wrapper input:checked ~ .checkbox-custom::after {
      content: '';
      display: block;
      width: 5px;
      height: 9px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg) translate(-1px, -1px);
    }

    /* Text utilities for pool */
    .text-right {
      text-align: right;
    }

    .text-success {
      color: var(--success) !important;
    }

    .text-danger {
      color: var(--danger) !important;
    }

    .ml-2 {
      margin-left: 0.5rem;
    }

    /* KPI Card clickable state */
    .kpi-card[style*="cursor: pointer"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    /* Responsive adjustments for pool */
    @media (max-width: 1024px) {
      .pool-filter-row {
        flex-direction: column;
        align-items: stretch;
      }

      .pool-search {
        min-width: unset;
      }

      .pool-filter-select {
        width: 100%;
      }

      .pool-filter-actions {
        margin-left: 0;
        justify-content: flex-end;
      }
    }

    @media (max-width: 768px) {
      .pool-status-tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 0.5rem;
      }

      .pool-status-tab {
        white-space: nowrap;
      }

      .pool-pagination {
        flex-direction: column;
        gap: 1rem;
      }

      .pool-floating-actions {
        left: 1rem;
        right: 1rem;
        transform: none;
        flex-direction: column;
        gap: 1rem;
      }

      .floating-buttons {
        width: 100%;
      }

      .floating-buttons .btn {
        flex: 1;
      }
    }

    /* Edit Policy Modal Form Styles */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.7);
    }

    .form-control {
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      color: #fff;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.15);
    }

    .form-control.mono {
      font-family: 'JetBrains Mono', monospace;
    }

    select.form-control {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.5)' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      padding-right: 2.5rem;
    }

    select.form-control option {
      background: #1a1a2e;
      color: #fff;
    }

    .action-btn.edit-btn:hover {
      background: rgba(99, 102, 241, 0.15);
    }

    .action-btn.edit-btn:hover svg {
      stroke: #818cf8;
    }

    @media (max-width: 640px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script>
    // ═══════════════════════════════════════════════════════════════
    // PERMISSION SYSTEM
    // ═══════════════════════════════════════════════════════════════

    // Permission configuration for different roles
    const permissionConfig = {
      admin: {
        label: 'Yönetici',
        description: 'Tüm alanları düzenleyebilirsiniz',
        badgeClass: 'admin',
        canEdit: true,
        editableFields: ['policyNo', 'customer', 'type', 'netPremium', 'grossPremium', 'producer', 'branch', 'date']
      },
      editor: {
        label: 'Editör',
        description: 'Bazı alanları düzenleyebilirsiniz',
        badgeClass: 'editor',
        canEdit: true,
        editableFields: ['customer', 'netPremium', 'grossPremium', 'producer', 'branch'] // Cannot edit policyNo, type, date
      },
      viewer: {
        label: 'İzleyici',
        description: 'Sadece görüntüleme yetkisi',
        badgeClass: 'viewer',
        canEdit: false,
        editableFields: []
      }
    };

    // ═══════════════════════════════════════════════════════════════
    // STATE VARIABLES
    // ═══════════════════════════════════════════════════════════════
    let currentUserRole = 'admin';

    // Data arrays - API'den doldurulacak
    let policyTypes = [];
    let producersList = [];
    let branchesList = [];
    let policies = [];
    let filteredPolicies = [];

    // Selection & sorting state
    let selectedPolicies = new Set();
    let currentSort = { field: 'date', direction: 'desc' };

    // Pagination state
    let currentPage = 1;
    let pageSize = 20;
    let totalFilteredItems = 0;

    // ═══════════════════════════════════════════════════════════════
    // YENİ STATE YÖNETİMİ (Pipeline Architecture)
    // ═══════════════════════════════════════════════════════════════
    let rawData = [];

    const tableState = {
      sort: { field: 'date', direction: 'desc' },
      filters: { search: '', producer: '', branch: '' },
      pagination: { currentPage: 1, pageSize: 20 },
      selection: new Set()
    };

    // ═══════════════════════════════════════════════════════════════
    // POOL (AKTARIM HAVUZU) STATE YÖNETİMİ
    // ═══════════════════════════════════════════════════════════════
    const poolState = {
      data: null,
      filters: {
        status: 'all', // all, matched, unmatched, difference
        search: '',
        bransId: '',
        sigortaSirketiId: ''
      },
      pagination: {
        currentPage: 1,
        pageSize: 20
      },
      selection: new Set(),
      loading: false,
      lookups: {
        branslar: [],
        sigortaSirketleri: [],
        loaded: false
      }
    };

    // Eşleşmeyenler (Yakalanan ama havuzda olmayan) state
    const unmatchedCapturedState = {
      data: null,
      loading: false,
      pagination: {
        currentPage: 1,
        pageSize: 20
      },
      filters: {
        search: '',
        bransId: null,
        sigortaSirketiId: null
      }
    };

    // Date range state
    let currentDateRange = {
      startDate: new Date(),
      endDate: new Date()
    };

    // ═══════════════════════════════════════════════════════════════
    // API LOADING FUNCTIONS
    // ═══════════════════════════════════════════════════════════════

    // Kullanıcı bilgisi yükle
    async function loadCurrentUser() {
      try {
        const data = await apiGet('auth/me');
        currentUserRole = data.role || 'viewer';
        APP_CONFIG.AUTH.setUser(data);
        return data;
      } catch (error) {
        console.error('Kullanıcı bilgisi alınamadı:', error);
        currentUserRole = 'viewer';
        return null;
      }
    }

    // Poliçe tipleri yükle
    async function loadPolicyTypes() {
      try {
        const data = await apiGet('policy-types');
        policyTypes = data || [];
        return data;
      } catch (error) {
        console.error('Poliçe tipleri alınamadı:', error);
        // Fallback statik veri
        policyTypes = [
          { value: 'Kasko', class: 'kasko' },
          { value: 'Trafik', class: 'trafik' },
          { value: 'DASK', class: 'dask' },
          { value: 'Sağlık', class: 'saglik' },
          { value: 'Konut', class: 'konut' }
        ];
        return policyTypes;
      }
    }

    // Prodüktör listesi yükle (sadece aktif kullanıcılar - firmaId ile filtrelenmiş)
    async function loadProducers() {
      try {
        const user = APP_CONFIG.AUTH.getUser();
        const firmaId = user?.firmaId;
        const endpoint = firmaId ? `kullanicilar/aktif?firmaId=${firmaId}` : 'kullanicilar/aktif';
        const data = await apiGet(endpoint);
        producersList = (data || []).map(u => ({
          id: u.id,
          name: `${u.adi || ''} ${u.soyadi || ''}`.trim() || `Kullanıcı #${u.id}`,
          subeId: u.subeId,
          branch: u.subeAdi || ''
        }));
        populateProducerFilter();
        return producersList;
      } catch (error) {
        console.error('Prodüktör listesi alınamadı:', error);
        producersList = [];
        return [];
      }
    }

    // Şube listesi yükle (firmaId ile filtrelenmiş)
    async function loadBranches() {
      try {
        const user = APP_CONFIG.AUTH.getUser();
        const firmaId = user?.firmaId;
        const endpoint = firmaId ? `branches?firmaId=${firmaId}` : 'branches';
        const data = await apiGet(endpoint);
        branchesList = (data || []).map(b => b.subeAdi || b.name);
        populateBranchFilter();
        return data;
      } catch (error) {
        console.error('Şube listesi alınamadı:', error);
        branchesList = [];
        return [];
      }
    }

    // Poliçe türü için CSS class belirle
    function getTypeClass(typeName) {
      const name = (typeName || '').toLowerCase();
      if (name.includes('kasko')) return 'kasko';
      if (name.includes('trafik')) return 'trafik';
      if (name.includes('dask')) return 'dask';
      if (name.includes('konut')) return 'konut';
      if (name.includes('sağlık') || name.includes('saglik')) return 'saglik';
      return '';
    }

    // API response'u frontend formatına dönüştür
    function mapPolicyFromApi(p) {
      // Prodüktör adını bul
      const producer = producersList.find(pr => pr.id === p.produktorId);
      const producerName = producer ? producer.name : `Prodüktör #${p.produktorId}`;

      // Poliçe türü adı doğrudan API'den geliyor (policeTuruAdi)
      // Fallback olarak eski alan adlarını da kontrol et
      const typeName = p.policeTuruAdi || p.policeTuru || 'Bilinmiyor';
      const typeClass = getTypeClass(typeName);

      // Şube adını al (API'dan doğrudan geliyor)
      const branch = p.subeAdi || `Şube #${p.subeId}`;

      return {
        id: p.id,
        policyNo: p.policeNo || p.policeNumarasi || '',
        customer: p.sigortaliAdi || 'Bilinmiyor',
        type: typeName,
        typeClass: typeClass,
        netPremium: p.netPrim || 0,
        grossPremium: p.brutPrim || 0,
        producer: producerName,
        producerId: p.produktorId,
        branch: branch,
        branchId: p.subeId,
        date: p.tanzimTarihi ? new Date(p.tanzimTarihi) : new Date(),
        dateFormatted: p.tanzimTarihi ? new Date(p.tanzimTarihi).toLocaleDateString('tr-TR') : '-',
        plaka: p.plaka || '',
        acenteAdi: p.acenteAdi || '',
        acenteNo: p.acenteNo || ''
      };
    }

    // Yakalanan poliçeler yükle
    async function loadCapturedPolicies() {
      try {
        const params = {
          startDate: formatDateISO(currentDateRange.startDate),
          endDate: formatDateISO(currentDateRange.endDate),
          sortBy: currentSort.field,
          sortDir: currentSort.direction
        };

        const result = await apiGet('policies/captured', params);

        let rawPolicies = [];
        if (result.data) {
          rawPolicies = result.data;
        } else if (Array.isArray(result)) {
          rawPolicies = result;
        }

        // API response'u frontend formatına dönüştür
        policies = rawPolicies.map(mapPolicyFromApi);
        filteredPolicies = [...policies];

        // applyFilters kullan - sorting dahil tüm işlemler yapılsın
        applyFilters();
        return policies;
      } catch (error) {
        console.error('Poliçeler alınamadı:', error);
        showToast('Poliçeler yüklenirken hata oluştu', 'error');
        policies = [];
        filteredPolicies = [];
        applyFilters();
        return [];
      }
    }

    // KPI istatistikleri yükle
    async function loadKPIStats() {
      try {
        const params = {
          startDate: formatDateISO(currentDateRange.startDate),
          endDate: formatDateISO(currentDateRange.endDate)
        };

        const stats = await apiGet('policies/captured/stats', params);

        // KPI kartlarını güncelle
        if (stats.pendingCount !== undefined) {
          document.getElementById('statPending').textContent = stats.pendingCount;
        }
        if (stats.totalGrossPremium !== undefined) {
          document.getElementById('statPremium').textContent = APP_CONFIG.CURRENCY.format(stats.totalGrossPremium);
        }
        if (stats.activeProducerCount !== undefined) {
          document.getElementById('statProducers').textContent = stats.activeProducerCount;
        }
        if (stats.sentCount !== undefined) {
          const sentEl = document.getElementById('statSent');
          if (sentEl) sentEl.textContent = stats.sentCount;
        }

        return stats;
      } catch (error) {
        console.error('KPI istatistikleri alınamadı:', error);
        return null;
      }
    }

    // Prodüktör dropdown'unu doldur
    function populateProducerFilter() {
      const list = document.getElementById('producerList');
      if (!list) return;

      const avatarColors = [
        'linear-gradient(135deg, #10b981, #059669)',
        'linear-gradient(135deg, #06b6d4, #0891b2)',
        'linear-gradient(135deg, #8b5cf6, #7c3aed)',
        'linear-gradient(135deg, #f59e0b, #d97706)',
        'linear-gradient(135deg, #f43f5e, #e11d48)',
        'linear-gradient(135deg, #3b82f6, #2563eb)',
        'linear-gradient(135deg, #ec4899, #db2777)',
        'linear-gradient(135deg, #14b8a6, #0d9488)'
      ];

      // "Tüm Prodüktörler" seçeneği
      let html = `
        <div class="dropdown-item selected" data-value="" onclick="selectProducer(this, '', 'Tüm Prodüktörler')">
          <span class="dropdown-item-avatar" style="background: linear-gradient(135deg, #64748b, #475569);">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 00-3-3.87"/>
              <path d="M16 3.13a4 4 0 010 7.75"/>
            </svg>
          </span>
          <span class="dropdown-item-name">Tüm Prodüktörler</span>
        </div>
      `;

      // Prodüktörleri ekle
      producersList.forEach((p, index) => {
        const initials = p.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const color = avatarColors[index % avatarColors.length];
        const escapedName = p.name.replace(/'/g, "\\'");
        html += `
          <div class="dropdown-item" data-value="${p.name}" onclick="selectProducer(this, '${escapedName}', '${escapedName}')">
            <span class="dropdown-item-avatar" style="background: ${color};">${initials}</span>
            <span class="dropdown-item-name">${p.name}</span>
          </div>
        `;
      });

      list.innerHTML = html;
    }

    // Dropdown aç/kapat
    function toggleProducerDropdown(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('producerDropdown');
      const searchInput = document.getElementById('producerSearchInput');

      dropdown.classList.toggle('open');

      if (dropdown.classList.contains('open')) {
        searchInput.value = '';
        filterProducerList();
        searchInput.focus();
      }
    }

    // Prodüktör listesini filtrele
    function filterProducerList() {
      const searchInput = document.getElementById('producerSearchInput');
      const searchTerm = searchInput.value.toLowerCase();
      const items = document.querySelectorAll('#producerList .dropdown-item');

      items.forEach(item => {
        const name = item.getAttribute('data-value').toLowerCase();
        const text = item.textContent.toLowerCase();
        if (name.includes(searchTerm) || text.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Prodüktör seç
    function selectProducer(element, value, displayText) {
      // Hidden input güncelle
      document.getElementById('producerFilter').value = value;

      // Görünen text güncelle
      document.getElementById('producerFilterText').textContent = displayText;

      // Seçili durumu güncelle
      document.querySelectorAll('#producerList .dropdown-item').forEach(item => {
        item.classList.remove('selected');
      });
      element.classList.add('selected');

      // Dropdown kapat
      document.getElementById('producerDropdown').classList.remove('open');

      // Filtreleme uygula
      filterTable();
    }

    // Click outside to close dropdown
    document.addEventListener('click', function(event) {
      const producerDropdown = document.getElementById('producerDropdown');
      if (producerDropdown && !producerDropdown.contains(event.target)) {
        producerDropdown.classList.remove('open');
      }
      const branchDropdown = document.getElementById('branchDropdown');
      if (branchDropdown && !branchDropdown.contains(event.target)) {
        branchDropdown.classList.remove('open');
      }
    });

    // ═══════════════════════════════════════════════════════════════
    // ŞUBE DROPDOWN FONKSİYONLARI
    // ═══════════════════════════════════════════════════════════════

    // Şube dropdown'unu doldur
    function populateBranchFilter() {
      const list = document.getElementById('branchList');
      if (!list) return;

      const avatarColors = [
        'linear-gradient(135deg, #10b981, #059669)',
        'linear-gradient(135deg, #06b6d4, #0891b2)',
        'linear-gradient(135deg, #8b5cf6, #7c3aed)',
        'linear-gradient(135deg, #f59e0b, #d97706)',
        'linear-gradient(135deg, #f43f5e, #e11d48)',
        'linear-gradient(135deg, #3b82f6, #2563eb)'
      ];

      // "Tüm Şubeler" seçeneği
      let html = `
        <div class="dropdown-item selected" data-value="" onclick="selectBranch(this, '', 'Tüm Şubeler')">
          <span class="dropdown-item-avatar" style="background: linear-gradient(135deg, #64748b, #475569);">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
              <polyline points="9,22 9,12 15,12 15,22"/>
            </svg>
          </span>
          <span class="dropdown-item-name">Tüm Şubeler</span>
        </div>
      `;

      // Şubeleri ekle
      branchesList.forEach((name, index) => {
        const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const color = avatarColors[index % avatarColors.length];
        const escapedName = name.replace(/'/g, "\\'");
        html += `
          <div class="dropdown-item" data-value="${name}" onclick="selectBranch(this, '${escapedName}', '${escapedName}')">
            <span class="dropdown-item-avatar" style="background: ${color};">${initials}</span>
            <span class="dropdown-item-name">${name}</span>
          </div>
        `;
      });

      list.innerHTML = html;
    }

    // Şube dropdown aç/kapat
    function toggleBranchDropdown(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('branchDropdown');
      const searchInput = document.getElementById('branchSearchInput');

      dropdown.classList.toggle('open');

      if (dropdown.classList.contains('open')) {
        searchInput.value = '';
        filterBranchList();
        searchInput.focus();
      }
    }

    // Şube listesini filtrele
    function filterBranchList() {
      const searchInput = document.getElementById('branchSearchInput');
      const searchTerm = searchInput.value.toLowerCase();
      const items = document.querySelectorAll('#branchList .dropdown-item');

      items.forEach(item => {
        const name = item.getAttribute('data-value').toLowerCase();
        const text = item.textContent.toLowerCase();
        if (name.includes(searchTerm) || text.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Şube seç
    function selectBranch(element, value, displayText) {
      // Hidden input güncelle
      document.getElementById('branchFilter').value = value;

      // Görünen text güncelle
      document.getElementById('branchFilterText').textContent = displayText;

      // Seçili durumu güncelle
      document.querySelectorAll('#branchList .dropdown-item').forEach(item => {
        item.classList.remove('selected');
      });
      element.classList.add('selected');

      // Dropdown kapat
      document.getElementById('branchDropdown').classList.remove('open');

      // Filtreleme uygula
      filterTable();
    }

    // Tarih formatla (ISO) - Yerel tarih kullanılır (UTC dönüşümü yapılmaz)
    function formatDateISO(date) {
      if (!date) return '';
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ═══════════════════════════════════════════════════════════════
    // SAYFA BAŞLATMA - Initialize page
    // ═══════════════════════════════════════════════════════════════
    document.addEventListener('DOMContentLoaded', async function() {
      // Check permission before loading page
      requirePermission('policeHavuzunuGorebilsin');

      showLoading(true);

      try {
        // 1. Kullanıcı bilgisi ve yetkisi
        await loadCurrentUser();

        // 2. Pool lookup verilerini yükle
        await loadPoolLookups();

        // 3. İlk tab: Bekleyen İşlemler
        poolState.filters.status = 'unmatched,difference';
        await loadPoolData();

        // 4. Tab sayılarını yükle
        loadTabCounts();

      } catch (error) {
        console.error('Sayfa yüklenirken hata:', error);
        showToast('Sayfa yüklenirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    });

    // ═══════════════════════════════════════════════════════════════
    // MAIN TAB SWITCHING - Ana Sekme Değiştirme
    // ═══════════════════════════════════════════════════════════════

    let currentMainTab = 'pending'; // 'pending' veya 'matched'

    function switchMainTab(tab, btn) {
      // Tab butonlarını güncelle
      document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      currentMainTab = tab;

      // Status'e göre pool verilerini filtrele
      if (tab === 'pending') {
        // Bekleyen İşlemler: AKTARIMDA + FARK_VAR
        poolState.filters.status = 'unmatched,difference';
        document.getElementById('pageTitle').textContent = 'Bekleyen İşlemler';
        document.getElementById('pageSubtitle').textContent = 'Eşleşme bekleyen ve fark olan poliçeler';
        loadPoolData(true);
      } else if (tab === 'matched') {
        // Eşleşen Poliçeler: ESLESTI
        poolState.filters.status = 'matched';
        document.getElementById('pageTitle').textContent = 'Eşleşen Poliçeler';
        document.getElementById('pageSubtitle').textContent = 'Tam eşleşen ve onay bekleyen poliçeler';
        loadPoolData(true);
      } else if (tab === 'unmatched-captured') {
        // Eşleşmeyenler: Yakalanan ama havuzda olmayan
        document.getElementById('pageTitle').textContent = 'Eşleşmeyenler';
        document.getElementById('pageSubtitle').textContent = 'Yakalanan ama havuzda olmayan poliçeler';
        loadUnmatchedCaptured(true);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // POOL (AKTARIM HAVUZU) FONKSİYONLARI
    // ═══════════════════════════════════════════════════════════════

    // Pool için branş ve sigorta şirketleri yükle
    async function loadPoolLookups() {
      if (poolState.lookups.loaded) return;

      try {
        const [branslar, sigortaSirketleri] = await Promise.all([
          apiGet('policy-types').catch(() => []),  // sigortapoliceturleri tablosundan
          apiGet('insurance-companies').catch(() => [])
        ]);

        poolState.lookups.branslar = branslar || [];
        poolState.lookups.sigortaSirketleri = sigortaSirketleri || [];
        poolState.lookups.loaded = true;

        // Global değişkenlere de ata (eski kod uyumluluğu için)
        window.sigortaSirketleri = sigortaSirketleri || [];
      } catch (error) {
        console.error('Pool lookup verileri yüklenemedi:', error);
      }
    }

    // Pool verilerini yükle
    async function loadPoolData(resetPage = false) {
      const poolContent = document.getElementById('poolContent');
      if (!poolContent) return;

      if (resetPage) {
        poolState.pagination.currentPage = 1;
      }

      // Loading state
      if (!poolState.data) {
        poolContent.innerHTML = `
          <div class="text-center py-5">
            <div class="loading-spinner mb-3">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                <path d="M21 12a9 9 0 11-6.219-8.56"/>
              </svg>
            </div>
            <p class="text-muted">Aktarım havuzu yükleniyor...</p>
          </div>
        `;
      }

      poolState.loading = true;

      // Lookup verilerini yükle (ilk sefer)
      await loadPoolLookups();

      try {
        // API parametrelerini hazırla
        const params = {
          page: poolState.pagination.currentPage,
          pageSize: poolState.pagination.pageSize
        };

        if (poolState.filters.status && poolState.filters.status !== 'all') {
          params.status = poolState.filters.status;
        }
        if (poolState.filters.search) {
          params.search = poolState.filters.search;
        }
        if (poolState.filters.bransId) {
          params.bransId = poolState.filters.bransId;
        }
        if (poolState.filters.sigortaSirketiId) {
          params.sigortaSirketiId = poolState.filters.sigortaSirketiId;
        }

        const data = await apiGet('policies/pool', params);
        poolState.data = data;
        poolState.loading = false;

        if (!data || !data.items || data.items.length === 0) {
          renderPoolEmpty();
          return;
        }

        // Pool içeriğini render et
        renderPoolContent(data);
      } catch (error) {
        console.error('Pool verileri yüklenemedi:', error);
        poolState.loading = false;
        poolContent.innerHTML = `
          <div class="card">
            <div class="card-body text-center py-5">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--danger); margin-bottom: 1rem;">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
              </svg>
              <h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">Yüklenemedi</h3>
              <p class="text-muted">${error.message || 'Aktarım havuzu yüklenirken bir hata oluştu.'}</p>
              <button class="btn btn-primary btn-sm mt-3" onclick="loadPoolData()">Tekrar Dene</button>
            </div>
          </div>
        `;
      }
    }

    // Boş pool durumu
    function renderPoolEmpty() {
      const poolContent = document.getElementById('poolContent');
      const data = poolState.data;

      // Filtre aktif mi kontrol et
      const hasFilters = poolState.filters.status !== 'all' ||
                         poolState.filters.search ||
                         poolState.filters.bransId ||
                         poolState.filters.sigortaSirketiId;

      // KPI kartlarını göster (boş olsa bile)
      poolContent.innerHTML = `
        ${renderPoolKPIs(data)}
        ${renderPoolStatusTabs()}
        ${renderPoolFilters()}
        <div class="card mt-4">
          <div class="card-body text-center py-5">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 1rem;">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="17,8 12,3 7,8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            <h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">
              ${hasFilters ? 'Sonuç Bulunamadı' : 'Aktarım Havuzu Boş'}
            </h3>
            <p class="text-muted">
              ${hasFilters
                ? 'Seçilen filtrelerle eşleşen kayıt bulunamadı.'
                : 'Henüz havuza aktarılmış poliçe bulunmuyor.'}
            </p>
            ${hasFilters ? `
              <button class="btn btn-primary mt-3" onclick="clearPoolFilters()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"/>
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                </svg>
                Filtreleri Temizle ve Tümünü Göster
              </button>
            ` : ''}
          </div>
        </div>
      `;
    }

    // KPI kartlarını render et
    function renderPoolKPIs(data) {
      const matched = data?.matchedCount || 0;
      const difference = data?.differenceCount || 0;
      const unmatched = data?.unmatchedCount || 0;
      const totalPrim = data?.totalBrutPrim || 0;
      const total = data?.totalCount || 0;

      return `
        <div class="kpi-grid mb-4">
          <!-- Eşleşen -->
          <div class="kpi-card kpi-emerald" style="cursor: pointer;" onclick="switchPoolStatus('matched')">
            <div class="kpi-card-bg"></div>
            <div class="kpi-header">
              <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                  <polyline points="22,4 12,14.01 9,11.01"/>
                </svg>
              </div>
            </div>
            <div class="kpi-content">
              <div class="kpi-value">${matched}</div>
              <div class="kpi-label">Eşleşen</div>
              <div class="kpi-subtitle">Yakalanan ile eşleşen</div>
            </div>
          </div>

          <!-- Fark Var -->
          <div class="kpi-card kpi-amber" style="cursor: pointer;" onclick="switchPoolStatus('difference')">
            <div class="kpi-card-bg"></div>
            <div class="kpi-header">
              <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
              </div>
            </div>
            <div class="kpi-content">
              <div class="kpi-value">${difference}</div>
              <div class="kpi-label">Fark Var</div>
              <div class="kpi-subtitle">Prim farkı olanlar</div>
            </div>
          </div>

          <!-- Bekleyen (Sadece Havuzda) -->
          <div class="kpi-card kpi-blue" style="cursor: pointer;" onclick="switchPoolStatus('unmatched')">
            <div class="kpi-card-bg"></div>
            <div class="kpi-header">
              <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="17,8 12,3 7,8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
              </div>
            </div>
            <div class="kpi-content">
              <div class="kpi-value">${unmatched}</div>
              <div class="kpi-label">Bekleyen</div>
              <div class="kpi-subtitle">Sadece havuzda</div>
            </div>
          </div>

          <!-- Toplam Prim -->
          <div class="kpi-card kpi-purple" style="cursor: pointer;" onclick="switchPoolStatus('all')">
            <div class="kpi-card-bg"></div>
            <div class="kpi-header">
              <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <line x1="12" y1="1" x2="12" y2="23"/>
                  <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                </svg>
              </div>
            </div>
            <div class="kpi-content">
              <div class="kpi-value">₺${totalPrim.toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
              <div class="kpi-label">Toplam Prim</div>
              <div class="kpi-subtitle">${total} poliçe</div>
            </div>
          </div>
        </div>
      `;
    }

    // Durum sekmelerini render et
    function renderPoolStatusTabs() {
      const currentStatus = poolState.filters.status || 'all';
      const data = poolState.data;

      return `
        <div class="pool-status-tabs mb-4">
          <button class="pool-status-tab ${currentStatus === 'all' ? 'active' : ''}" onclick="switchPoolStatus('all')">
            Tümü
            <span class="tab-count">${data?.totalCount || 0}</span>
          </button>
          <button class="pool-status-tab ${currentStatus === 'matched' ? 'active' : ''}" onclick="switchPoolStatus('matched')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20,6 9,17 4,12"/>
            </svg>
            Eşleşen
            <span class="tab-count">${data?.matchedCount || 0}</span>
          </button>
          <button class="pool-status-tab ${currentStatus === 'difference' ? 'active' : ''}" onclick="switchPoolStatus('difference')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
            </svg>
            Fark Var
            <span class="tab-count">${data?.differenceCount || 0}</span>
          </button>
          <button class="pool-status-tab ${currentStatus === 'unmatched' ? 'active' : ''}" onclick="switchPoolStatus('unmatched')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="17,8 12,3 7,8"/>
            </svg>
            Sadece Havuzda
            <span class="tab-count">${data?.unmatchedCount || 0}</span>
          </button>
        </div>
      `;
    }

    // Filtre alanını render et
    function renderPoolFilters() {
      const branslar = poolState.lookups.branslar || [];
      const sirketler = poolState.lookups.sigortaSirketleri || [];

      return `
        <div class="pool-filters mb-4">
          <div class="pool-filter-row">
            <div class="pool-search">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
              </svg>
              <input type="text"
                     id="poolSearchInput"
                     placeholder="Poliçe no, plaka ara..."
                     value="${poolState.filters.search || ''}"
                     onkeyup="handlePoolSearchKeyup(event)"
                     oninput="debouncePoolSearch(this.value)">
              ${poolState.filters.search ? `
                <button class="pool-search-clear" onclick="clearPoolSearch()">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                  </svg>
                </button>
              ` : ''}
            </div>

            <select class="pool-filter-select" id="poolBransFilter" onchange="handlePoolBransFilter(this.value)">
              <option value="">Tüm Branşlar</option>
              ${branslar.map(b => {
                const bId = b.id || b.bransId || '';
                const bName = b.turu || b.ad || b.name || b.bransAdi || (typeof b === 'string' ? b : 'Branş');
                return `<option value="${bId}" ${poolState.filters.bransId == bId ? 'selected' : ''}>${bName}</option>`;
              }).join('')}
            </select>

            <select class="pool-filter-select" id="poolSirketFilter" onchange="handlePoolSirketFilter(this.value)">
              <option value="">Tüm Şirketler</option>
              ${sirketler.map(s => {
                const sId = s.id || s.sigortaSirketiId || '';
                const sName = s.ad || s.name || s.sirketAdi || 'Şirket';
                return `<option value="${sId}" ${poolState.filters.sigortaSirketiId == sId ? 'selected' : ''}>${sName}</option>`;
              }).join('')}
            </select>

            <div class="pool-filter-actions">
              <button class="btn btn-outline btn-sm" onclick="clearPoolFilters()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"/>
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                </svg>
                Filtreleri Temizle
              </button>
              <button class="btn btn-primary btn-sm" onclick="loadPoolData(true)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23,4 23,10 17,10"/>
                  <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
                </svg>
                Yenile
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Pool içeriğini render et
    function renderPoolContent(data) {
      const poolContent = document.getElementById('poolContent');

      const html = `
        ${renderPoolKPIs(data)}
        ${renderPoolStatusTabs()}
        ${renderPoolFilters()}
        ${renderPoolTable(data)}
        ${renderPoolPagination(data)}
        ${renderPoolFloatingActions()}
      `;

      poolContent.innerHTML = html;
    }

    // Pool tablosunu render et
    function renderPoolTable(data) {
      const items = data.items || [];
      const hasSelection = poolState.selection.size > 0;
      const allSelected = items.length > 0 && items.every(item => poolState.selection.has(item.id));

      return `
        <div class="card">
          <div class="card-header">
            <div class="card-header-left">
              <h3 class="card-title">Aktarım Havuzu</h3>
              <span class="badge badge-info">${data.totalCount || 0} kayıt</span>
              ${hasSelection ? `<span class="badge badge-primary ml-2">${poolState.selection.size} seçili</span>` : ''}
            </div>
            <div class="card-header-right">
              ${data.totalCount > 0 ? `
                <button class="btn btn-success btn-sm" onclick="approveAllPool()">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                  </svg>
                  Tümünü Poliçelerime Kaydet
                </button>
              ` : ''}
            </div>
          </div>
          <div class="card-body" style="padding: 0;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th style="width: 40px;">
                      <label class="checkbox-wrapper">
                        <input type="checkbox"
                               ${allSelected ? 'checked' : ''}
                               onchange="togglePoolSelectAll(this.checked)">
                        <span class="checkbox-custom"></span>
                      </label>
                    </th>
                    <th>Poliçe No</th>
                    <th>Tanzim Tarihi</th>
                    <th>Sigortalı Adı</th>
                    <th>Branş</th>
                    <th>Sigorta Şirketi</th>
                    <th class="text-right">Havuz Prim</th>
                    <th class="text-right">Yakalanan Prim</th>
                    <th class="text-right">Fark</th>
                    <th class="text-right">Komisyon</th>
                    <th>Durum</th>
                    <th style="width: 100px;">İşlem</th>
                  </tr>
                </thead>
                <tbody>
                  ${items.map(item => renderPoolTableRow(item)).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // Tek bir tablo satırını render et
    function renderPoolTableRow(item) {
      const isSelected = poolState.selection.has(item.id);
      const statusClass = item.eslesmeDurumu === 'ESLESTI' ? 'badge-success' :
                          item.eslesmeDurumu === 'FARK_VAR' ? 'badge-warning' : 'badge-danger';
      const statusText = item.eslesmeDurumu === 'ESLESTI' ? 'Eşleşti' :
                         item.eslesmeDurumu === 'FARK_VAR' ? 'Fark Var' : 'Aktarımda';

      const primFarki = item.primFarki || 0;
      const farkClass = primFarki > 0 ? 'text-success' : primFarki < 0 ? 'text-danger' : '';

      // Tanzim Tarihi formatla
      const tanzimTarihiFormatted = item.tanzimTarihi
        ? new Date(item.tanzimTarihi).toLocaleDateString('tr-TR')
        : '-';

      return `
        <tr class="${isSelected ? 'selected' : ''}" data-id="${item.id}">
          <td>
            <label class="checkbox-wrapper">
              <input type="checkbox"
                     ${isSelected ? 'checked' : ''}
                     onchange="togglePoolSelection(${item.id}, this.checked)">
              <span class="checkbox-custom"></span>
            </label>
          </td>
          <td>
            <span class="font-mono">${item.policeNo || '-'}</span>
            ${item.plaka ? `<div class="text-muted text-xs">${item.plaka}</div>` : ''}
            ${item.zeyilNo > 0 ? `<div class="text-muted text-xs">Zeyil: ${item.zeyilNo}</div>` : ''}
          </td>
          <td>
            <span class="text-sm">${tanzimTarihiFormatted}</span>
          </td>
          <td>
            <span class="text-sm">${item.sigortaliAdi || '-'}</span>
          </td>
          <td><span class="badge badge-outline">${item.brans || '-'}</span></td>
          <td><span class="text-sm">${item.sigortaSirketi || '-'}</span></td>
          <td class="font-mono text-right">₺${(item.brutPrim || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
          <td class="font-mono text-right">
            ${item.yakalananPrim != null ? `₺${item.yakalananPrim.toLocaleString('tr-TR', {minimumFractionDigits: 2})}` : '<span class="text-muted">-</span>'}
          </td>
          <td class="font-mono text-right ${farkClass}">
            ${primFarki !== 0 && primFarki !== null ? `${primFarki > 0 ? '+' : ''}₺${primFarki.toLocaleString('tr-TR', {minimumFractionDigits: 2})}` : '<span class="text-muted">-</span>'}
          </td>
          <td class="font-mono text-right">
            <span class="font-mono">₺${(item.komisyon || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span>
          </td>
          <td>
            <span class="badge ${statusClass}">${statusText}</span>
          </td>
          <td>
            <div class="action-buttons">
              ${item.eslesmeDurumu === 'FARK_VAR' ? `
                <button class="btn btn-sm btn-success" onclick="acceptPoolValue(${item.id})" title="Aktarımdan geleni kabul et">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20,6 9,17 4,12"/>
                  </svg>
                  Kabul Et
                </button>
              ` : ''}
              <button class="action-btn" title="Detay" onclick="showPoolPolicyDetail(${item.id})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
              <button class="action-btn action-btn-success" title="Kaydet" onclick="approvePoolPolicy(${item.id})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20,6 9,17 4,12"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `;
    }

    // Sayfalama render et
    function renderPoolPagination(data) {
      const currentPage = data.currentPage || 1;
      const totalPages = data.totalPages || 1;
      const pageSize = poolState.pagination.pageSize;

      if (totalPages <= 1) return '';

      let pages = [];
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          pages.push(i);
        } else if (pages[pages.length - 1] !== '...') {
          pages.push('...');
        }
      }

      return `
        <div class="pool-pagination mt-4">
          <div class="pagination-info">
            Sayfa ${currentPage} / ${totalPages}
          </div>
          <div class="pagination-controls">
            <select class="pagination-size" onchange="changePoolPageSize(this.value)">
              <option value="10" ${pageSize === 10 ? 'selected' : ''}>10</option>
              <option value="20" ${pageSize === 20 ? 'selected' : ''}>20</option>
              <option value="50" ${pageSize === 50 ? 'selected' : ''}>50</option>
              <option value="100" ${pageSize === 100 ? 'selected' : ''}>100</option>
            </select>
            <div class="pagination-buttons">
              <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPoolPage(${currentPage - 1})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15,18 9,12 15,6"/>
                </svg>
              </button>
              ${pages.map(p => p === '...' ?
                `<span class="pagination-ellipsis">...</span>` :
                `<button class="pagination-btn ${p === currentPage ? 'active' : ''}" onclick="goToPoolPage(${p})">${p}</button>`
              ).join('')}
              <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPoolPage(${currentPage + 1})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9,18 15,12 9,6"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Floating action box (seçim yapılınca)
    function renderPoolFloatingActions() {
      const count = poolState.selection.size;
      if (count === 0) return '';

      return `
        <div class="pool-floating-actions" id="poolFloatingActions">
          <div class="floating-count">
            <span class="count-number">${count}</span>
            <span class="count-text">poliçe seçildi</span>
          </div>
          <div class="floating-buttons">
            <button class="btn btn-success" onclick="approveSelectedPool()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/>
              </svg>
              Seçilenleri Kaydet
            </button>
            <button class="btn btn-outline" onclick="clearPoolSelection()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
              </svg>
              Seçimi Temizle
            </button>
          </div>
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════
    // POOL EVENT HANDLERS
    // ═══════════════════════════════════════════════════════════════

    // Durum sekmesi değiştir
    function switchPoolStatus(status) {
      poolState.filters.status = status;
      poolState.pagination.currentPage = 1;
      poolState.selection.clear();
      loadPoolData();
    }

    // Arama debounce
    let poolSearchTimeout = null;
    function debouncePoolSearch(value) {
      if (poolSearchTimeout) clearTimeout(poolSearchTimeout);
      poolSearchTimeout = setTimeout(() => {
        poolState.filters.search = value;
        loadPoolData(true);
      }, 300);
    }

    function handlePoolSearchKeyup(event) {
      if (event.key === 'Enter') {
        if (poolSearchTimeout) clearTimeout(poolSearchTimeout);
        poolState.filters.search = event.target.value;
        loadPoolData(true);
      }
    }

    function clearPoolSearch() {
      poolState.filters.search = '';
      const input = document.getElementById('poolSearchInput');
      if (input) input.value = '';
      loadPoolData(true);
    }

    // Branş filtresi
    function handlePoolBransFilter(value) {
      poolState.filters.bransId = value;
      loadPoolData(true);
    }

    // Şirket filtresi
    function handlePoolSirketFilter(value) {
      poolState.filters.sigortaSirketiId = value;
      loadPoolData(true);
    }

    // Filtreleri temizle
    function clearPoolFilters() {
      poolState.filters = {
        status: 'all',
        search: '',
        bransId: '',
        sigortaSirketiId: ''
      };
      loadPoolData(true);
    }

    // Seçim işlemleri
    function togglePoolSelection(id, checked) {
      if (checked) {
        poolState.selection.add(id);
      } else {
        poolState.selection.delete(id);
      }
      updatePoolSelectionUI();
    }

    function togglePoolSelectAll(checked) {
      const items = poolState.data?.items || [];
      if (checked) {
        items.forEach(item => poolState.selection.add(item.id));
      } else {
        items.forEach(item => poolState.selection.delete(item.id));
      }
      updatePoolSelectionUI();
    }

    function clearPoolSelection() {
      poolState.selection.clear();
      updatePoolSelectionUI();
    }

    function updatePoolSelectionUI() {
      // Tablo satırlarını güncelle
      const rows = document.querySelectorAll('#poolContent table tbody tr');
      rows.forEach(row => {
        const id = parseInt(row.dataset.id);
        const checkbox = row.querySelector('input[type="checkbox"]');
        if (poolState.selection.has(id)) {
          row.classList.add('selected');
          if (checkbox) checkbox.checked = true;
        } else {
          row.classList.remove('selected');
          if (checkbox) checkbox.checked = false;
        }
      });

      // Header checkbox'ı güncelle
      const headerCheckbox = document.querySelector('#poolContent table thead input[type="checkbox"]');
      const items = poolState.data?.items || [];
      const allSelected = items.length > 0 && items.every(item => poolState.selection.has(item.id));
      if (headerCheckbox) headerCheckbox.checked = allSelected;

      // Floating actions güncelle
      const floatingEl = document.getElementById('poolFloatingActions');
      if (floatingEl) {
        floatingEl.remove();
      }

      const poolContent = document.getElementById('poolContent');
      if (poolState.selection.size > 0 && poolContent) {
        poolContent.insertAdjacentHTML('beforeend', renderPoolFloatingActions());
      }

      // Seçili sayısı badge'ini güncelle
      const selectionBadge = document.querySelector('#poolContent .card-header .badge-primary');
      if (selectionBadge) {
        if (poolState.selection.size > 0) {
          selectionBadge.textContent = `${poolState.selection.size} seçili`;
          selectionBadge.style.display = '';
        } else {
          selectionBadge.style.display = 'none';
        }
      }
    }

    // Sayfalama
    function goToPoolPage(page) {
      poolState.pagination.currentPage = page;
      loadPoolData();
    }

    function changePoolPageSize(size) {
      poolState.pagination.pageSize = parseInt(size);
      poolState.pagination.currentPage = 1;
      loadPoolData();
    }

    // ═══════════════════════════════════════════════════════════════
    // POOL ACTIONS (KAYDETME İŞLEMLERİ)
    // ═══════════════════════════════════════════════════════════════

    // Tek poliçe kaydet
    async function approvePoolPolicy(id) {
      if (!confirm('Bu poliçeyi Poliçelerime kaydetmek istediğinize emin misiniz?')) return;

      try {
        const result = await apiPost(`policies/pool/${id}/approve`);
        if (result.success) {
          showToast('Poliçe Poliçelerime kaydedildi', 'success');
          poolState.selection.delete(id);
          loadPoolData();
        } else {
          showToast(result.errorMessage || 'Kaydetme başarısız', 'error');
        }
      } catch (error) {
        console.error('Kaydetme hatası:', error);
        showToast('Kaydetme sırasında hata oluştu', 'error');
      }
    }

    // Aktarımdan geleni kabul et (FARK_VAR durumu için)
    async function acceptPoolValue(poolPolicyId) {
      if (!confirm('Aktarımdan gelen değerler ile bu poliçeyi poliçelerinize kaydetmek istediğinizden emin misiniz?')) {
        return;
      }

      try {
        // Mevcut approval endpoint'i kullan
        const result = await apiPost(`policies/pool/${poolPolicyId}/approve`);

        if (result.success) {
          showToast('Poliçe başarıyla kaydedildi', 'success');
          // Pool'dan kaldırıldı, listeyi yenile
          poolState.selection.delete(poolPolicyId);
          await loadPoolData(true);
          await loadTabCounts();
        } else {
          showToast(result.errorMessage || 'Kayıt işlemi başarısız', 'error');
        }
      } catch (error) {
        console.error('acceptPoolValue error:', error);
        showToast('Bir hata oluştu: ' + (error.message || 'Bilinmeyen hata'), 'error');
      }
    }

    // Seçilenleri kaydet
    async function approveSelectedPool() {
      const ids = Array.from(poolState.selection);
      if (ids.length === 0) {
        showToast('Lütfen en az bir poliçe seçin', 'warning');
        return;
      }

      if (!confirm(`${ids.length} poliçeyi Poliçelerime kaydetmek istediğinize emin misiniz?`)) return;

      try {
        const result = await apiPost('policies/pool/batch-approve', { poolPolicyIds: ids });

        if (result.successCount > 0) {
          showToast(`${result.successCount} poliçe Poliçelerime kaydedildi`, 'success');
        }
        if (result.failedCount > 0) {
          showToast(`${result.failedCount} poliçe kaydedilemedi`, 'warning');
          console.warn('Kaydetme hataları:', result.errors);
        }

        poolState.selection.clear();
        loadPoolData();
      } catch (error) {
        console.error('Toplu kaydetme hatası:', error);
        showToast('Toplu kaydetme sırasında hata oluştu', 'error');
      }
    }

    // Tüm havuzdaki poliçeleri kaydet
    async function approveAllPool() {
      const data = poolState.data;
      if (!data || data.totalCount === 0) {
        showToast('Havuzda poliçe bulunamadı', 'info');
        return;
      }

      if (!confirm(`Havuzdaki tüm ${data.totalCount} poliçeyi Poliçelerime kaydetmek istediğinize emin misiniz?`)) return;

      try {
        // Tüm havuzdaki poliçeleri çek
        const allData = await apiGet('policies/pool', {
          pageSize: 1000
        });

        if (!allData?.items?.length) {
          showToast('Havuzda poliçe bulunamadı', 'info');
          return;
        }

        const ids = allData.items.map(item => item.id);
        const result = await apiPost('policies/pool/batch-approve', { poolPolicyIds: ids });

        if (result.successCount > 0) {
          showToast(`${result.successCount} poliçe Poliçelerime kaydedildi`, 'success');
        }
        if (result.failedCount > 0) {
          showToast(`${result.failedCount} poliçe kaydedilemedi`, 'warning');
          console.warn('Kaydetme hataları:', result.errors);
        }

        poolState.selection.clear();
        loadPoolData();
      } catch (error) {
        console.error('Tüm poliçeleri kaydetme hatası:', error);
        showToast('Kaydetme sırasında hata oluştu', 'error');
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // EŞLEŞMEYENLERde (YAKALANAN AMA HAVUZDA OLMAYAN) FONKSİYONLARI
    // ═══════════════════════════════════════════════════════════════

    // Eşleşmeyenleri yükle
    async function loadUnmatchedCaptured(resetPage = false) {
      const poolContent = document.getElementById('poolContent');
      if (!poolContent) return;

      if (resetPage) {
        unmatchedCapturedState.pagination.currentPage = 1;
      }

      try {
        unmatchedCapturedState.loading = true;
        const params = {
          page: unmatchedCapturedState.pagination.currentPage,
          pageSize: unmatchedCapturedState.pagination.pageSize
        };

        if (unmatchedCapturedState.filters.search) {
          params.search = unmatchedCapturedState.filters.search;
        }
        if (unmatchedCapturedState.filters.bransId) {
          params.bransId = unmatchedCapturedState.filters.bransId;
        }
        if (unmatchedCapturedState.filters.sigortaSirketiId) {
          params.sigortaSirketiId = unmatchedCapturedState.filters.sigortaSirketiId;
        }

        const data = await apiGet('policies/captured/not-in-pool', params);
        unmatchedCapturedState.data = data;
        unmatchedCapturedState.loading = false;

        if (!data || !data.items || data.items.length === 0) {
          renderUnmatchedCapturedEmpty();
          return;
        }

        renderUnmatchedCapturedContent(data);
      } catch (error) {
        console.error('Eşleşmeyenler yüklenemedi:', error);
        unmatchedCapturedState.loading = false;
        poolContent.innerHTML = `
          <div class="card">
            <div class="card-body text-center py-5">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--danger); margin-bottom: 1rem;">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
              </svg>
              <h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">Yüklenemedi</h3>
              <p class="text-muted">${error.message || 'Bir hata oluştu'}</p>
              <button class="btn btn-primary btn-sm mt-3" onclick="loadUnmatchedCaptured()">Tekrar Dene</button>
            </div>
          </div>
        `;
      }
    }

    // Eşleşmeyenler boş durumu
    function renderUnmatchedCapturedEmpty() {
      const poolContent = document.getElementById('poolContent');
      poolContent.innerHTML = `
        <div class="card">
          <div class="card-body text-center py-5">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--success); margin-bottom: 1rem;">
              <polyline points="20,6 9,17 4,12"/>
            </svg>
            <h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">Tüm Poliçeler Eşleşti</h3>
            <p class="text-muted">Yakalanan tüm poliçeler havuzda bulunuyor.</p>
          </div>
        </div>
      `;
    }

    // Eşleşmeyenler içeriğini render et
    function renderUnmatchedCapturedContent(data) {
      const poolContent = document.getElementById('poolContent');

      const html = `
        <div class="card">
          <div class="card-header">
            <div class="card-header-left">
              <h3 class="card-title">Eşleşmeyenler</h3>
              <span class="badge badge-warning">${data.totalCount || 0} kayıt</span>
            </div>
          </div>
          <div class="card-body" style="padding: 0;">
            <div class="table-container" style="overflow-x: auto;">
              <table class="data-table" style="min-width: 1600px;">
                <thead>
                  <tr>
                    <th style="min-width: 140px;">Poliçe No</th>
                    <th style="min-width: 95px;">Tanzim</th>
                    <th style="min-width: 95px;">Başlangıç</th>
                    <th style="min-width: 95px;">Bitiş</th>
                    <th style="min-width: 150px;">Sigortalı Adı</th>
                    <th style="min-width: 100px;">Branş</th>
                    <th style="min-width: 120px;">Sigorta Şirketi</th>
                    <th style="min-width: 120px;">Prodüktör</th>
                    <th style="min-width: 100px;">Şube</th>
                    <th class="text-right" style="min-width: 100px;">Net Prim</th>
                    <th class="text-right" style="min-width: 100px;">Brüt Prim</th>
                    <th style="min-width: 95px;">Eklenme</th>
                    <th style="min-width: 150px;">İşlemler</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.items.map(item => `
                    <tr data-id="${item.id}">
                      <td>
                        <span class="font-mono" style="font-weight: 600;">${item.policeNo || '-'}</span>
                        ${item.plaka ? `<div class="text-muted text-xs">${item.plaka}</div>` : ''}
                      </td>
                      <td>
                        <span class="text-sm">${new Date(item.tanzimTarihi).toLocaleDateString('tr-TR')}</span>
                      </td>
                      <td>
                        <span class="text-sm">${new Date(item.baslangicTarihi).toLocaleDateString('tr-TR')}</span>
                      </td>
                      <td>
                        <span class="text-sm">${new Date(item.bitisTarihi).toLocaleDateString('tr-TR')}</span>
                      </td>
                      <td>
                        <span class="text-sm">${item.sigortaliAdi || '-'}</span>
                      </td>
                      <td>
                        <span class="badge badge-outline">${item.brans || '-'}</span>
                      </td>
                      <td>
                        <span class="text-sm">${item.sigortaSirketi || '-'}</span>
                      </td>
                      <td>
                        <span class="text-sm" style="font-weight: 500; color: var(--primary);">${item.produktorAdi || '<span style="color: var(--danger);">Atanmamış</span>'}</span>
                      </td>
                      <td>
                        <span class="text-sm">${item.subeAdi || '-'}</span>
                      </td>
                      <td class="text-right">
                        <span class="font-mono">₺${(item.netPrim || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span>
                      </td>
                      <td class="text-right">
                        <span class="font-mono" style="font-weight: 600;">₺${(item.brutPrim || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span>
                      </td>
                      <td>
                        <span class="text-xs text-muted">${new Date(item.eklenmeTarihi).toLocaleDateString('tr-TR')}</span>
                      </td>
                      <td>
                        <div style="display: flex; gap: 0.5rem;">
                          <button class="btn btn-sm btn-secondary" onclick="openEditUnmatchedModal(${item.id})" title="Düzenle">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                              <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                          </button>
                          <button class="btn btn-sm btn-success" onclick="sendCapturedToPool(${item.id})" title="Poliçeyi Kaydet">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                              <polyline points="17,21 17,13 7,13 7,21"/>
                              <polyline points="7,3 7,8 15,8"/>
                            </svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;

      poolContent.innerHTML = html;
    }

    // Yakalanan poliçeyi direkt kaydet (havuzu bypass et)
    async function sendCapturedToPool(capturedId) {
      if (!confirm('Bu poliçeyi Poliçelerime kaydetmek istediğinize emin misiniz?')) {
        return;
      }

      try {
        // Direkt approval endpoint'ini çağır (havuzu bypass et)
        const result = await apiPost(`policies/captured/${capturedId}/approve`);

        if (result.success) {
          showToast('Poliçe başarıyla kaydedildi', 'success');
          await loadUnmatchedCaptured(true);
          await loadTabCounts();
        } else {
          showToast(result.errorMessage || 'Kaydetme başarısız', 'error');
        }
      } catch (error) {
        console.error('sendCapturedToPool error:', error);
        showToast('Bir hata oluştu: ' + (error.message || 'Bilinmeyen hata'), 'error');
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // EŞLEŞMEYENLERİ DÜZENLEME MODAL FONKSİYONLARI
    // ═══════════════════════════════════════════════════════════════

    let currentEditingUnmatchedId = null;
    let unmatchedProduktorler = [];
    let unmatchedSubeler = [];

    // Modal'ı aç ve verileri doldur
    async function openEditUnmatchedModal(id) {
      currentEditingUnmatchedId = id;

      // Eşleşmeyen poliçeyi bul
      const item = unmatchedCapturedState.data?.items?.find(p => p.id === id);
      if (!item) {
        showToast('Poliçe bulunamadı', 'error');
        return;
      }

      // Form alanlarını doldur
      document.getElementById('editUnmatchedId').value = item.id;
      document.getElementById('editUnmatchedPoliceNo').value = item.policeNo || '';
      document.getElementById('editUnmatchedSigortali').value = item.sigortaliAdi || '';
      document.getElementById('editUnmatchedBrans').value = item.brans || '';
      document.getElementById('editUnmatchedSirket').value = item.sigortaSirketi || '';
      document.getElementById('editUnmatchedNetPrim').value = `₺${(item.netPrim || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
      document.getElementById('editUnmatchedBrutPrim').value = `₺${(item.brutPrim || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
      document.getElementById('editUnmatchedTanzim').value = new Date(item.tanzimTarihi).toLocaleDateString('tr-TR');
      document.getElementById('editUnmatchedBaslangic').value = new Date(item.baslangicTarihi).toLocaleDateString('tr-TR');
      document.getElementById('editUnmatchedBitis').value = new Date(item.bitisTarihi).toLocaleDateString('tr-TR');
      document.getElementById('editUnmatchedEklenme').value = new Date(item.eklenmeTarihi).toLocaleDateString('tr-TR');

      // Prodüktör ve Şube dropdown'larını doldur
      await loadUnmatchedProduktorSube();

      // Mevcut değerleri seç
      document.getElementById('editUnmatchedProduktor').value = item.produktorId || '';
      document.getElementById('editUnmatchedSube').value = item.subeId || '';

      // Modal'ı aç
      document.getElementById('editUnmatchedModal').classList.add('active');
    }

    // Prodüktör ve Şube listelerini yükle
    async function loadUnmatchedProduktorSube() {
      try {
        // Prodüktör listesi
        const produktorData = await apiGet('users', { role: 'produktor' });
        unmatchedProduktorler = produktorData.items || produktorData || [];

        const produktorSelect = document.getElementById('editUnmatchedProduktor');
        produktorSelect.innerHTML = '<option value="">Prodüktör Seçin</option>' +
          unmatchedProduktorler.map(p =>
            `<option value="${p.id}">${p.adSoyad || p.name}</option>`
          ).join('');

        // Şube listesi
        const subeData = await apiGet('branches');
        unmatchedSubeler = subeData.items || subeData || [];

        const subeSelect = document.getElementById('editUnmatchedSube');
        subeSelect.innerHTML = '<option value="">Şube Seçin</option>' +
          unmatchedSubeler.map(s =>
            `<option value="${s.id}">${s.subeAdi || s.name}</option>`
          ).join('');
      } catch (error) {
        console.error('Prodüktör/Şube yüklenemedi:', error);
        showToast('Prodüktör ve Şube listesi yüklenemedi', 'error');
      }
    }

    // Modal'ı kapat
    function closeEditUnmatchedModal() {
      document.getElementById('editUnmatchedModal').classList.remove('active');
      currentEditingUnmatchedId = null;
    }

    // Düzenlenen poliçeyi kaydet
    async function saveEditedUnmatched(event) {
      event.preventDefault();

      const id = currentEditingUnmatchedId;
      if (!id) return;

      const produktorId = parseInt(document.getElementById('editUnmatchedProduktor').value);
      const subeId = parseInt(document.getElementById('editUnmatchedSube').value);

      if (!produktorId || !subeId) {
        showToast('Lütfen Prodüktör ve Şube seçin', 'warning');
        return;
      }

      showLoading(true);

      try {
        // Backend'e güncelleme isteği gönder
        const result = await apiPut(`policies/captured/${id}`, {
          produktorId: produktorId,
          subeId: subeId
        });

        if (result.success) {
          showToast('Poliçe başarıyla güncellendi', 'success');
          closeEditUnmatchedModal();
          await loadUnmatchedCaptured(true);
        } else {
          showToast('Güncelleme başarısız: ' + (result.message || 'Bilinmeyen hata'), 'error');
        }
      } catch (error) {
        console.error('Güncelleme hatası:', error);
        showToast('Güncelleme sırasında hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    // Poliçe detayı göster
    function showPoolPolicyDetail(id) {
      // Modal veya side panel gösterebiliriz
      showToast('Detay sayfası yakında...', 'info');
    }

    // Tab sayılarını yükle
    async function loadTabCounts() {
      try {
        // Bekleyen İşlemler sayısı (AKTARIMDA + FARK_VAR)
        const pendingData = await apiGet('policies/pool', { status: 'unmatched,difference', pageSize: 1 });
        const pendingCount = (pendingData?.unmatchedCount || 0) + (pendingData?.differenceCount || 0);
        document.getElementById('pendingTabCount').textContent = pendingCount;

        // Eşleşen Poliçeler sayısı (ESLESTI)
        const matchedData = await apiGet('policies/pool', { status: 'matched', pageSize: 1 });
        document.getElementById('matchedTabCount').textContent = matchedData?.matchedCount || 0;

        // Eşleşmeyenler sayısı (Yakalanan ama havuzda olmayan)
        const unmatchedCapturedData = await apiGet('policies/captured/not-in-pool', { pageSize: 1 });
        document.getElementById('unmatchedCapturedTabCount').textContent = unmatchedCapturedData?.totalCount || 0;
      } catch (error) {
        console.error('Tab sayıları yüklenemedi:', error);
      }
    }

    // Pool verilerini yenile
    async function refreshPoolData() {
      showLoading(true);
      try {
        // Mevcut sekmeye göre doğru veriyi yükle
        if (currentMainTab === 'unmatched-captured') {
          await Promise.all([
            loadUnmatchedCaptured(true),
            loadTabCounts()
          ]);
        } else {
          await Promise.all([
            loadPoolData(true),
            loadTabCounts()
          ]);
        }
        showToast('Veriler yenilendi', 'success');
      } catch (error) {
        console.error('Yenileme hatası:', error);
        showToast('Veriler yenilenirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // PERMISSION & EDIT MODE FUNCTIONS
    // ═══════════════════════════════════════════════════════════════

    function changeUserRole(role) {
      currentUserRole = role;
      updatePermissionUI();

      // Re-render table to reflect permission changes
      applyFilters();
    }

    function updatePermissionUI() {
      const config = permissionConfig[currentUserRole];
      const badge = document.getElementById('permissionBadge');
      const label = document.getElementById('permissionLabel');
      const text = document.getElementById('permissionText');

      // Update badge class
      badge.className = 'permission-badge ' + config.badgeClass;
      label.textContent = config.label;
      text.textContent = config.description;
    }

    function canEditField(field) {
      const config = permissionConfig[currentUserRole];
      return config.canEdit && config.editableFields.includes(field);
    }

    // Filter by date range (sayfa-spesifik - API çağrıları)
    async function filterByDateRange(startDate, endDate) {
      const start = new Date(startDate);
      start.setHours(0, 0, 0, 0);
      const end = new Date(endDate);
      end.setHours(23, 59, 59, 999);

      // Update currentDateRange for API calls
      currentDateRange.startDate = start;
      currentDateRange.endDate = end;

      currentPage = 1; // Reset to first page when filtering

      // Load data from API with new date range
      showLoading(true);
      try {
        await Promise.all([
          loadCapturedPolicies(),
          loadKPIStats()
        ]);
      } catch (error) {
        console.error('Date filter error:', error);
        showToast('Tarih filtreleme hatası', 'error');
      } finally {
        showLoading(false);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // VERİ PIPELINE FONKSİYONLARI (Yeni Mimari)
    // ═══════════════════════════════════════════════════════════════

    function pipelineFilter(data) {
      const { search, producer, branch } = tableState.filters;

      return data.filter(item => {
        if (search) {
          const searchLower = search.toLowerCase().trim();
          const searchable = [
            item.policyNo, item.customer, item.type,
            item.producer, item.branch, item.dateFormatted,
            item.netPremium?.toString(), item.grossPremium?.toString()
          ].join(' ').toLowerCase();
          if (!searchable.includes(searchLower)) return false;
        }
        if (producer && item.producer !== producer) return false;
        if (branch && item.branch !== branch) return false;
        return true;
      });
    }

    function pipelineSort(data) {
      const { field, direction } = tableState.sort;
      if (!field || !direction) return [...data];

      return [...data].sort((a, b) => {
        const aVal = getSortValue(a, field);
        const bVal = getSortValue(b, field);

        if (aVal == null && bVal == null) return 0;
        if (aVal == null) return 1;
        if (bVal == null) return -1;

        let cmp = 0;
        if (typeof aVal === 'number' && typeof bVal === 'number') {
          cmp = aVal - bVal;
        } else {
          cmp = String(aVal).localeCompare(String(bVal), 'tr', {
            sensitivity: 'base', numeric: true
          });
        }

        return direction === 'asc' ? cmp : -cmp;
      });
    }

    function getSortValue(item, field) {
      if (field === 'date') {
        if (!item.date) return null;
        const ts = item.date instanceof Date ? item.date.getTime() : new Date(item.date).getTime();
        return isNaN(ts) ? null : ts;
      }
      if (field === 'netPremium' || field === 'grossPremium') {
        const n = Number(item[field]);
        return isNaN(n) ? null : n;
      }
      return (item[field] || '').toLocaleLowerCase('tr');
    }

    function pipelinePaginate(data) {
      const { currentPage, pageSize } = tableState.pagination;
      const total = data.length;
      const totalPages = Math.ceil(total / pageSize) || 1;
      const safePage = Math.max(1, Math.min(currentPage, totalPages));

      const start = (safePage - 1) * pageSize;
      const end = start + pageSize;

      return {
        items: data.slice(start, end),
        currentPage: safePage,
        totalPages,
        totalItems: total
      };
    }

    function refreshTable() {
      const filtered = pipelineFilter(rawData);
      const sorted = pipelineSort(filtered);
      const result = pipelinePaginate(sorted);

      // Mevcut render fonksiyonunu kullan
      renderTableWithData(result.items, result);
      updateStats(filtered);
    }

    // ═══════════════════════════════════════════════════════════════
    // ESKİ FİLTRE FONKSİYONLARI (Uyumluluk için)
    // ═══════════════════════════════════════════════════════════════

    // Apply all filters
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const producerFilter = document.getElementById('producerFilter').value;
      const branchFilter = document.getElementById('branchFilter').value;

      let result = [...filteredPolicies];

      if (searchTerm) {
        result = result.filter(p =>
          p.policyNo.toLowerCase().includes(searchTerm) ||
          p.customer.toLowerCase().includes(searchTerm) ||
          p.type.toLowerCase().includes(searchTerm) ||
          p.producer.toLowerCase().includes(searchTerm) ||
          p.branch.toLowerCase().includes(searchTerm) ||
          p.dateFormatted.toLowerCase().includes(searchTerm) ||
          p.netPremium.toString().includes(searchTerm) ||
          p.grossPremium.toString().includes(searchTerm)
        );
      }

      if (producerFilter) {
        result = result.filter(p => p.producer === producerFilter);
      }

      if (branchFilter) {
        result = result.filter(p => p.branch === branchFilter);
      }

      // Sort
      if (currentSort.field && currentSort.direction) {
        console.log('Sorting by:', currentSort.field, currentSort.direction);
        console.log('Before sort (first 3):', result.slice(0, 3).map(p => ({ [currentSort.field]: p[currentSort.field] })));

        result.sort((a, b) => {
          const aVal = a[currentSort.field];
          const bVal = b[currentSort.field];

          // NULL/UNDEFINED KONTROLÜ - null değerler sona
          const aIsNull = aVal == null;
          const bIsNull = bVal == null;
          if (aIsNull && bIsNull) return 0;
          if (aIsNull) return 1;
          if (bIsNull) return -1;

          let comparison = 0;

          // SAYISAL SÜTUNLAR (netPremium, grossPremium)
          if (currentSort.field === 'netPremium' || currentSort.field === 'grossPremium') {
            const aNum = Number(aVal);
            const bNum = Number(bVal);

            // NaN kontrolü
            if (isNaN(aNum) && isNaN(bNum)) return 0;
            if (isNaN(aNum)) return 1;
            if (isNaN(bNum)) return -1;

            comparison = aNum - bNum;
          }
          // TARİH SÜTUNU (date) - date ZATEN Date object!
          else if (currentSort.field === 'date') {
            // Date object ise direkt getTime(), değilse parse et
            const aTime = aVal instanceof Date ? aVal.getTime() : new Date(aVal).getTime();
            const bTime = bVal instanceof Date ? bVal.getTime() : new Date(bVal).getTime();

            // Invalid Date kontrolü
            if (isNaN(aTime) && isNaN(bTime)) return 0;
            if (isNaN(aTime)) return 1;
            if (isNaN(bTime)) return -1;

            comparison = aTime - bTime;
          }
          // STRING SÜTUNLAR (policyNo, customer, producer, type, branch)
          else {
            const aStr = String(aVal || '').toLocaleLowerCase('tr');
            const bStr = String(bVal || '').toLocaleLowerCase('tr');
            comparison = aStr.localeCompare(bStr, 'tr', { sensitivity: 'base', numeric: true });
          }

          return currentSort.direction === 'asc' ? comparison : -comparison;
        });

        console.log('After sort (first 3):', result.slice(0, 3).map(p => ({ [currentSort.field]: p[currentSort.field] })));
      }

      // Sıralanmış veriyi kaydet (pagination için)
      filteredPolicies = result;

      renderTableWithData(result);
      updateStats(result);
    }

    // Filter table
    function filterTable() {
      currentPage = 1; // Reset to first page when filtering
      applyFilters();
    }

    // Sort table
    function sortTable(field) {
      if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
      }

      // Reset to first page when sorting
      currentPage = 1;

      // Update sort indicators
      document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
      });
      const currentTh = document.querySelector(`[data-sort="${field}"]`);
      if (currentTh) {
        currentTh.classList.add(currentSort.direction);
      }

      applyFilters();
    }

    // Render table
    function renderTable() {
      renderTableWithData(policies);
    }

    function renderTableWithData(data, paginationInfo = null) {
      const tbody = document.getElementById('policyTableBody');

      // Yeni pipeline'dan gelen paginationInfo varsa kullan
      // Yoksa eski uyumluluk modu için hesapla
      let paginatedData, totalItems, totalPages, activePage, startIndex, endIndex;

      if (paginationInfo) {
        // YENİ PIPELINE MODU - Sıralama ZATEN yapılmış
        paginatedData = data; // data zaten slice'lanmış
        totalItems = paginationInfo.totalItems;
        totalPages = paginationInfo.totalPages;
        activePage = paginationInfo.currentPage;
        startIndex = (activePage - 1) * tableState.pagination.pageSize;

        // Eski state'i de senkronize tut (uyumluluk)
        currentPage = activePage;
        totalFilteredItems = totalItems;
        endIndex = Math.min(startIndex + tableState.pagination.pageSize, totalItems);
      } else {
        // ESKİ UYUMLULUK MODU - Sıralama ve pagination burada
        totalItems = data.length;
        totalPages = Math.ceil(totalItems / pageSize) || 1;

        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        activePage = currentPage;
        startIndex = (activePage - 1) * pageSize;
        endIndex = Math.min(startIndex + pageSize, data.length);
        paginatedData = data.slice(startIndex, endIndex);
        totalFilteredItems = totalItems;
      }

      if (totalItems === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-muted);">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 0.5rem; opacity: 0.5;">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
              </svg>
              <br>Seçilen kriterlere uygun poliçe bulunamadı.
            </td>
          </tr>
        `;
        document.getElementById('tableInfo').textContent = '0 poliçe';
        updatePaginationControls(0, 0, 0);
        return;
      }

      // Önce tbody'yi temizle
      tbody.innerHTML = '';

      // HTML içeriğini oluştur
      const rowsHtml = paginatedData.map(p => {
        return `
        <tr class="${selectedPolicies.has(p.id) ? 'selected' : ''}" data-id="${p.id}" onclick="handleRowClick(event, ${p.id})">
          <td>
            <input type="checkbox" ${selectedPolicies.has(p.id) ? 'checked' : ''}>
          </td>
          <td>
            <span class="clickable-link font-mono" style="font-weight: 600;" onclick="event.stopPropagation(); openPolicyDrive('${p.policyNo}')" title="Google Drive'da aç">
              ${p.policyNo}
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                <polyline points="15,3 21,3 21,9"/>
                <line x1="10" y1="14" x2="21" y2="3"/>
              </svg>
            </span>
          </td>
          <td>
            <div class="cell-main clickable-customer" onclick="event.stopPropagation(); openCustomerModal('${p.customer}', ${p.id})">${p.customer}</div>
          </td>
          <td>
            <span class="policy-type-badge ${p.typeClass}">${p.type}</span>
          </td>
          <td>
            <span class="font-mono font-semibold">₺${p.netPremium.toLocaleString('tr-TR')}</span>
          </td>
          <td>
            <span class="font-mono font-semibold">₺${p.grossPremium.toLocaleString('tr-TR')}</span>
          </td>
          <td>
            <div class="producer-cell">
              <div class="producer-avatar ${p.producerColor}">${p.producerInitials}</div>
              <div class="producer-info">
                <span class="producer-name clickable-producer" onclick="event.stopPropagation(); openProducerModal('${p.producer}', '${p.producerInitials}', '${p.producerColor}')">${p.producer}</span>
                <span class="producer-branch clickable-branch" onclick="event.stopPropagation(); openBranchModal('${p.branch}')">${p.branch}</span>
              </div>
            </div>
          </td>
          <td>
            <span class="cell-sub">${p.dateFormatted}</span>
          </td>
          <td onclick="event.stopPropagation()">
            <div class="table-actions">
              <button class="action-btn view-btn" onclick="viewPolicy(${p.id})" title="Görüntüle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
              <button class="action-btn edit-btn" onclick="openEditPolicyModal(${p.id})" title="Düzenle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button class="action-btn send" onclick="sendToPool(${p.id})" title="Havuza Gönder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M5 12h14"/>
                  <path d="M12 5l7 7-7 7"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `}).join('');

      // HTML'i ata ve doğrula
      tbody.innerHTML = rowsHtml;

      // DOM doğrulama - ilk satırın ID'sini kontrol et
      const firstRow = tbody.querySelector('tr[data-id]');
      const lastRow = tbody.querySelector('tr:last-child');
      console.log('🟢 DOM FIRST ROW data-id:', firstRow?.dataset.id);
      console.log('🟢 DOM LAST ROW data-id:', lastRow?.dataset.id);
      console.log('🟢 Expected first id:', paginatedData[0]?.id, 'Expected last id:', paginatedData[paginatedData.length - 1]?.id);

      // Update table info text
      document.getElementById('tableInfo').textContent = `${startIndex + 1}-${endIndex} / ${data.length} poliçe`;

      // Update pagination controls
      updatePaginationControls(currentPage, totalPages, data.length);
    }

    // Update stats - KPI cards removed, function kept for compatibility
    function updateStats(data = policies) {
      // No-op: KPI stat elements (statPending, statPremium, statProducers) were removed during refactor
      // Tab counts are now managed by loadTabCounts() function
    }

    // ═══════════════════════════════════════════════════════════════
    // PAGINATION FUNCTIONS
    // ═══════════════════════════════════════════════════════════════

    function updatePaginationControls(current, total, itemCount) {
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');
      const pageNumbersContainer = document.getElementById('pageNumbers');

      // Update prev/next button states
      prevBtn.disabled = current <= 1;
      nextBtn.disabled = current >= total;

      // Generate page numbers
      if (total <= 1) {
        pageNumbersContainer.innerHTML = '';
        return;
      }

      let pageNumbersHTML = '';

      // Always show first page
      pageNumbersHTML += generatePageNumber(1, current);

      // Show ellipsis if there's a gap after first page
      if (current > 3) {
        pageNumbersHTML += '<span class="page-ellipsis">...</span>';
      }

      // Show pages around current page
      for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) {
        pageNumbersHTML += generatePageNumber(i, current);
      }

      // Show ellipsis if there's a gap before last page
      if (current < total - 2) {
        pageNumbersHTML += '<span class="page-ellipsis">...</span>';
      }

      // Always show last page (if more than 1 page)
      if (total > 1) {
        pageNumbersHTML += generatePageNumber(total, current);
      }

      pageNumbersContainer.innerHTML = pageNumbersHTML;
    }

    function generatePageNumber(page, currentPage) {
      const isActive = page === currentPage;
      return `<button class="page-number ${isActive ? 'active' : ''}" onclick="goToPage(${page})">${page}</button>`;
    }

    function goToPage(page) {
      currentPage = page;
      applyFilters();
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        applyFilters();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(totalFilteredItems / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        applyFilters();
      }
    }

    function changePageSize(newSize) {
      pageSize = parseInt(newSize);
      currentPage = 1; // Reset to first page when changing page size
      applyFilters();
    }

    // Selection functions
    function handleRowClick(event, id) {
      // Toggle selection when clicking anywhere on the row
      toggleSelect(id);
    }

    function toggleSelect(id) {
      if (selectedPolicies.has(id)) {
        selectedPolicies.delete(id);
      } else {
        selectedPolicies.add(id);
      }
      updateSelectionUI();
    }

    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const visibleRows = document.querySelectorAll('#policyTableBody tr[data-id]');

      if (selectAllCheckbox.checked) {
        visibleRows.forEach(row => {
          const id = parseInt(row.dataset.id);
          selectedPolicies.add(id);
        });
      } else {
        visibleRows.forEach(row => {
          const id = parseInt(row.dataset.id);
          selectedPolicies.delete(id);
        });
      }
      updateSelectionUI();
    }

    function updateSelectionUI() {
      const count = selectedPolicies.size;
      const selectedCountBadge = document.getElementById('selectedCount');
      const sendSelectedBtn = document.getElementById('sendSelectedBtn');
      const floatingBox = document.getElementById('floatingActionBox');

      if (count > 0) {
        selectedCountBadge.textContent = count + ' seçili';
        selectedCountBadge.style.display = 'inline-flex';
        sendSelectedBtn.style.display = 'inline-flex';

        // Show floating action box
        floatingBox.classList.add('active');

        // Update floating box stats
        document.getElementById('fabCount').textContent = count;
        const totalPremium = [...selectedPolicies].reduce((sum, id) => {
          const policy = policies.find(p => p.id === id);
          return sum + (policy ? policy.grossPremium : 0);
        }, 0);
        document.getElementById('fabTotalPremium').textContent = '₺' + totalPremium.toLocaleString('tr-TR');
      } else {
        selectedCountBadge.style.display = 'none';
        sendSelectedBtn.style.display = 'none';

        // Hide floating action box
        floatingBox.classList.remove('active');
      }

      // Update row styles
      document.querySelectorAll('#policyTableBody tr[data-id]').forEach(row => {
        const id = parseInt(row.dataset.id);
        const checkbox = row.querySelector('input[type="checkbox"]');
        if (selectedPolicies.has(id)) {
          row.classList.add('selected');
          checkbox.checked = true;
        } else {
          row.classList.remove('selected');
          checkbox.checked = false;
        }
      });

      // Update select all checkbox
      const visibleRows = document.querySelectorAll('#policyTableBody tr[data-id]');
      const selectAllCheckbox = document.getElementById('selectAll');
      const allSelected = visibleRows.length > 0 && [...visibleRows].every(row => selectedPolicies.has(parseInt(row.dataset.id)));
      selectAllCheckbox.checked = allSelected;
    }

    function clearSelection() {
      selectedPolicies.clear();
      updateSelectionUI();
    }

    function viewSelectedPolicies() {
      const selectedList = [...selectedPolicies].map(id => {
        const policy = policies.find(p => p.id === id);
        return policy ? `${policy.policyNo} - ${policy.customer}` : '';
      }).join('\n');

      alert('Seçili Poliçeler:\n\n' + selectedList);
    }

    function exportSelectedPolicies() {
      const selectedData = [...selectedPolicies].map(id => policies.find(p => p.id === id)).filter(Boolean);

      if (selectedData.length === 0) return;

      // Create CSV content
      const headers = ['Poliçe No', 'Müşteri', 'Tip', 'Net Prim', 'Brüt Prim', 'Prodüktör', 'Şube', 'Tarih'];
      const rows = selectedData.map(p => [
        p.policyNo,
        p.customer,
        p.type,
        p.netPremium,
        p.grossPremium,
        p.producer,
        p.branch,
        p.dateFormatted
      ]);

      const csvContent = [headers, ...rows].map(row => row.join(';')).join('\n');

      // Download
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `secili_policeler_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();

      alert(`${selectedData.length} poliçe Excel'e aktarıldı.`);
    }

    // Actions
    function viewPolicy(id) {
      const policy = policies.find(p => p.id === id);
      if (policy) {
        // TODO: Modal açarak poliçe detaylarını göster veya detay sayfasına yönlendir
        // window.location.href = `/policies/${id}`;
        alert(`Poliçe Detayı:\n\nPoliçe No: ${policy.policyNo}\nMüşteri: ${policy.customer}\nTip: ${policy.type}\nNet Prim: ₺${policy.netPremium.toLocaleString('tr-TR')}\nBrüt Prim: ₺${policy.grossPremium.toLocaleString('tr-TR')}\nProdüktör: ${policy.producer}\nŞube: ${policy.branch}\nTarih: ${policy.dateFormatted}`);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // POLİÇEYİ HAVUZA GÖNDER
    // ═══════════════════════════════════════════════════════════════
    async function sendToPool(id) {
      const policy = policies.find(p => p.id === id);
      if (!policy) return;

      if (!confirm(`#${policy.policyNo} numaralı poliçe havuza gönderilecek. Onaylıyor musunuz?`)) return;

      showLoading(true);

      try {
        const result = await apiPost(`policies/${id}/send-to-pool`, {});

        if (result.success) {
          policies = policies.filter(p => p.id !== id);
          filteredPolicies = filteredPolicies.filter(p => p.id !== id);
          selectedPolicies.delete(id);
          applyFilters();
          updateStats();
          await loadKPIStats();
          showToast('Poliçe başarıyla havuza gönderildi', 'success');
        } else {
          showToast('Hata: ' + (result.message || 'Bilinmeyen hata'), 'error');
        }
      } catch (error) {
        console.error('Havuza gönderme hatası:', error);
        showToast('Poliçe havuza gönderilirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // SEÇİLİ POLİÇELERİ TOPLU HAVUZA GÖNDER
    // ═══════════════════════════════════════════════════════════════
    async function sendSelectedToPool() {
      if (selectedPolicies.size === 0) return;

      if (!confirm(`${selectedPolicies.size} poliçe havuza gönderilecek. Onaylıyor musunuz?`)) return;

      showLoading(true);

      try {
        const policyIds = Array.from(selectedPolicies);
        const result = await apiPost('policies/batch-send-to-pool', { policyIds });

        if (result.success) {
          policyIds.forEach(id => {
            policies = policies.filter(p => p.id !== id);
            filteredPolicies = filteredPolicies.filter(p => p.id !== id);
          });
          selectedPolicies.clear();
          applyFilters();
          updateStats();
          await loadKPIStats();
          showToast(`${result.sentCount || policyIds.length} poliçe başarıyla havuza gönderildi`, 'success');
        } else {
          const errorMsg = result.errors ? result.errors.map(e => e.message).join(', ') : 'Bilinmeyen hata';
          showToast('Bazı poliçeler gönderilemedi: ' + errorMsg, 'error');
        }
      } catch (error) {
        console.error('Toplu havuza gönderme hatası:', error);
        showToast('Poliçeler havuza gönderilirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    async function sendAllToPool() {
      const visiblePolicies = document.querySelectorAll('#policyTableBody tr[data-id]');
      if (visiblePolicies.length === 0) {
        showToast('Gönderilecek poliçe bulunamadı', 'warning');
        return;
      }

      if (!confirm(`${visiblePolicies.length} poliçe havuza gönderilecek. Onaylıyor musunuz?`)) return;

      showLoading(true);

      try {
        const policyIds = Array.from(visiblePolicies).map(row => parseInt(row.dataset.id));
        const result = await apiPost('policies/batch-send-to-pool', { policyIds });

        if (result.success) {
          policyIds.forEach(id => {
            policies = policies.filter(p => p.id !== id);
            filteredPolicies = filteredPolicies.filter(p => p.id !== id);
          });
          selectedPolicies.clear();
          applyFilters();
          updateStats();
          await loadKPIStats();
          showToast(`${result.sentCount || policyIds.length} poliçe başarıyla havuza gönderildi`, 'success');
        } else {
          showToast('Poliçeler gönderilemedi', 'error');
        }
      } catch (error) {
        console.error('Tüm poliçeleri gönderme hatası:', error);
        showToast('Poliçeler havuza gönderilirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // VERİLERİ YENİLE
    // ═══════════════════════════════════════════════════════════════
    async function refreshData() {
      showLoading(true);

      try {
        await Promise.all([
          loadCapturedPolicies(),
          loadKPIStats()
        ]);
        showToast('Veriler yenilendi', 'success');
      } catch (error) {
        console.error('Yenileme hatası:', error);
        showToast('Veriler yenilenirken hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // POLICY DRIVE LINK
    // ═══════════════════════════════════════════════════════════════

    function openPolicyDrive(policyNo) {
      // Google Drive link formatı - gerçek uygulamada API'den gelecek
      // Örnek: https://drive.google.com/drive/folders/FOLDER_ID
      const driveBaseUrl = 'https://drive.google.com/drive/search?q=';
      const searchQuery = encodeURIComponent(policyNo);
      const driveUrl = driveBaseUrl + searchQuery;

      // Yeni sekmede aç
      window.open(driveUrl, '_blank');
    }

    // ═══════════════════════════════════════════════════════════════
    // CUSTOMER MODAL
    // ═══════════════════════════════════════════════════════════════

    async function openCustomerModal(customerName, policyId) {
      const modal = document.getElementById('customerModal');
      const modalBody = document.getElementById('customerModalBody');

      // Loading state
      modalBody.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <div class="loading-spinner" style="display: inline-block;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 11-6.219-8.56"/>
            </svg>
          </div>
          <p style="margin-top: 1rem; opacity: 0.7;">Müşteri bilgisi yükleniyor...</p>
        </div>
      `;
      modal.classList.add('active');

      try {
        const customer = await apiGet('customers/search', { name: customerName });

        if (customer && customer.hasCard) {
          // Müşteri kartı mevcut
          const initials = customerName.split(' ').map(n => n[0]).join('');
          const collectionRate = customer.collectionRate || 0;
          modalBody.innerHTML = `
            <div class="customer-card-found">
              <div class="customer-avatar-large">${initials}</div>
              <h4>${customer.name || customerName}</h4>
              <div class="customer-tc">${customer.tc || ''}</div>
              <span class="badge badge-success">Müşteri Kartı Mevcut</span>

              <div class="customer-stats">
                <div class="customer-stat">
                  <div class="customer-stat-value">${customer.policies?.count || customer.policyCount || 0}</div>
                  <div class="customer-stat-label">Poliçe</div>
                </div>
                <div class="customer-stat">
                  <div class="customer-stat-value">${APP_CONFIG.CURRENCY.format(customer.policies?.totalPremium || customer.totalPremium || 0)}</div>
                  <div class="customer-stat-label">Toplam Prim</div>
                </div>
                <div class="customer-stat">
                  <div class="customer-stat-value">%${collectionRate}</div>
                  <div class="customer-stat-label">Tahsilat</div>
                </div>
              </div>

              <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeCustomerModal()">Kapat</button>
                <button class="btn btn-primary" onclick="goToCustomerCard(${customer.id || 0})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                  Müşteri Kartına Git
                </button>
              </div>
            </div>
          `;
        } else {
          // Müşteri kartı yok
          const initials = customerName.split(' ').map(n => n[0]).join('');
          const tc = customer?.tc || '';
          modalBody.innerHTML = `
            <div class="customer-not-found">
              <div class="empty-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                  <line x1="12" y1="11" x2="12" y2="17"/>
                  <line x1="9" y1="14" x2="15" y2="14"/>
                </svg>
              </div>
              <h4>Müşteri Kartı Bulunamadı</h4>
              <p><strong>${customerName}</strong> için sistemde kayıtlı müşteri kartı bulunmuyor.</p>

              <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 14px; margin-bottom: 1rem; text-align: left; border: 1px solid rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <span style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">Müşteri Adı:</span>
                  <span style="font-weight: 600; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">${customerName}</span>
                </div>
                ${tc ? `<div style="display: flex; justify-content: space-between;">
                  <span style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">TC/VKN:</span>
                  <span style="font-family: 'JetBrains Mono', monospace; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">${tc}</span>
                </div>` : ''}
              </div>

              <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeCustomerModal()">Kapat</button>
                <button class="btn btn-primary" onclick="createCustomerCard('${customerName}', '${tc}', ${policyId})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <line x1="20" y1="8" x2="20" y2="14"/>
                    <line x1="23" y1="11" x2="17" y2="11"/>
                  </svg>
                  Yeni Kart Oluştur
                </button>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Müşteri bilgisi alınamadı:', error);
        // Müşteri bulunamadı - oluşturma seçeneği sun
        const initials = customerName.split(' ').map(n => n[0]).join('');
        modalBody.innerHTML = `
          <div class="customer-not-found">
            <div class="empty-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
                <line x1="12" y1="11" x2="12" y2="17"/>
                <line x1="9" y1="14" x2="15" y2="14"/>
              </svg>
            </div>
            <h4>Müşteri Kartı Bulunamadı</h4>
            <p><strong>${customerName}</strong> için sistemde kayıtlı müşteri kartı bulunmuyor.</p>

            <div class="modal-actions">
              <button class="btn btn-secondary" onclick="closeCustomerModal()">Kapat</button>
              <button class="btn btn-primary" onclick="createCustomerCard('${customerName}', '', ${policyId})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                  <circle cx="8.5" cy="7" r="4"/>
                  <line x1="20" y1="8" x2="20" y2="14"/>
                  <line x1="23" y1="11" x2="17" y2="11"/>
                </svg>
                Yeni Kart Oluştur
              </button>
            </div>
          </div>
        `;
      }
    }

    function closeCustomerModal() {
      document.getElementById('customerModal').classList.remove('active');
    }

    function goToCustomerCard(customerId) {
      closeCustomerModal();
      // Müşteri kartı sayfasına yönlendir
      window.location.href = `../customers/list.html?id=${customerId}`;
    }

    // ═══════════════════════════════════════════════════════════════
    // YENİ MÜŞTERİ KARTI OLUŞTUR
    // ═══════════════════════════════════════════════════════════════
    async function createCustomerCard(customerName, tc, linkedPolicyId) {
      closeCustomerModal();

      // API ile müşteri oluşturmayı dene
      try {
        const result = await apiPost('customers', {
          name: customerName,
          tc: tc || '',
          linkedPolicyId: linkedPolicyId
        });

        if (result.success && result.customerId) {
          showToast('Müşteri kartı oluşturuldu', 'success');
          // Müşteri sayfasına yönlendir
          window.location.href = `../customers/list.html?id=${result.customerId}`;
        } else {
          // Manuel oluşturma için yönlendir
          window.location.href = `../customers/list.html?action=new&name=${encodeURIComponent(customerName)}&tc=${encodeURIComponent(tc || '')}`;
        }
      } catch (error) {
        console.error('Müşteri oluşturulamadı:', error);
        // Fallback: Müşteri sayfasına yönlendir
        window.location.href = `../customers/list.html?action=new&name=${encodeURIComponent(customerName)}&tc=${encodeURIComponent(tc || '')}`;
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // PRODUCER MODAL
    // ═══════════════════════════════════════════════════════════════

    async function openProducerModal(producerName, initials, color) {
      const modal = document.getElementById('producerModal');
      const modalBody = document.getElementById('producerModalBody');

      // Loading state
      modalBody.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <div class="loading-spinner" style="display: inline-block;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 11-6.219-8.56"/>
            </svg>
          </div>
          <p style="margin-top: 1rem; opacity: 0.7;">Prodüktör bilgisi yükleniyor...</p>
        </div>
      `;
      modal.classList.add('active');

      try {
        const producer = await apiGet('producers/search', { name: producerName });

        if (producer) {
          const pColor = producer.color || color;
          const pInitials = producer.initials || initials;
          const stats = producer.stats || {};
          const policyCount = stats.policyCount || 0;
          const totalPremium = stats.totalPremium || 0;
          const performance = stats.performance || 0;

          modalBody.innerHTML = `
            <div class="info-card">
              <div class="info-card-header">
                <div class="info-card-avatar" style="background: linear-gradient(135deg, ${getColorGradient(pColor)});">${pInitials}</div>
                <div class="info-card-details">
                  <h4>${producer.name || producerName}</h4>
                  <p>${producer.role || 'Prodüktör'} • ${producer.branchName || ''} Şubesi</p>
                </div>
              </div>

              <div class="info-card-stats">
                <div class="info-stat-item">
                  <div class="info-stat-value">${policyCount}</div>
                  <div class="info-stat-label">Poliçe (Bu Ay)</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${APP_CONFIG.CURRENCY.format(totalPremium)}</div>
                  <div class="info-stat-label">Prim (Bu Ay)</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${performance}%</div>
                  <div class="info-stat-label">Hedef</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${APP_CONFIG.CURRENCY.format(totalPremium * 0.076)}</div>
                  <div class="info-stat-label">Komisyon</div>
                </div>
              </div>

              <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeProducerModal()">Kapat</button>
                <button class="btn btn-primary" onclick="goToProducerPage(${producer.id || 0})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                  </svg>
                  Prodüktör Sayfası
                </button>
              </div>
            </div>
          `;
        } else {
          modalBody.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <p>Prodüktör bilgisi bulunamadı.</p>
              <button class="btn btn-secondary" onclick="closeProducerModal()">Kapat</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Prodüktör bilgisi alınamadı:', error);
        modalBody.innerHTML = `
          <div style="text-align: center; padding: 2rem;">
            <p>Prodüktör bilgisi yüklenirken hata oluştu.</p>
            <button class="btn btn-secondary" onclick="closeProducerModal()">Kapat</button>
          </div>
        `;
      }
    }

    function closeProducerModal() {
      document.getElementById('producerModal').classList.remove('active');
    }

    function goToProducerPage(producerId) {
      closeProducerModal();
      window.location.href = `../employees/list.html?id=${producerId}`;
    }

    // ═══════════════════════════════════════════════════════════════
    // BRANCH MODAL
    // ═══════════════════════════════════════════════════════════════

    async function openBranchModal(branchName) {
      const modal = document.getElementById('branchModal');
      const modalBody = document.getElementById('branchModalBody');

      // Loading state
      modalBody.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <div class="loading-spinner" style="display: inline-block;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 11-6.219-8.56"/>
            </svg>
          </div>
          <p style="margin-top: 1rem; opacity: 0.7;">Şube bilgisi yükleniyor...</p>
        </div>
      `;
      modal.classList.add('active');

      try {
        const branch = await apiGet('branches/search', { name: branchName });

        if (branch) {
          const initials = (branch.name || branchName).substring(0, 2).toUpperCase();
          const stats = branch.stats || {};
          const employeeCount = stats.employeeCount || 0;
          const policyCount = stats.policyCount || 0;
          const totalPremium = stats.totalPremium || 0;
          const avgPremium = policyCount > 0 ? Math.round(totalPremium / policyCount) : 0;

          modalBody.innerHTML = `
            <div class="info-card">
              <div class="info-card-header">
                <div class="info-card-avatar" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">${initials}</div>
                <div class="info-card-details">
                  <h4>${branch.name || branchName} Şubesi</h4>
                  <p>Şube Müdürü: ${branch.manager || 'Belirtilmemiş'}</p>
                </div>
              </div>

              ${branch.address ? `
              <div style="background: rgba(255, 255, 255, 0.1); padding: 0.75rem 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);">
                <div style="display: flex; align-items: center; gap: 0.5rem; color: rgba(255, 255, 255, 0.8); font-size: 0.85rem;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.7;">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                  </svg>
                  ${branch.address}
                </div>
              </div>
              ` : ''}

              <div class="info-card-stats">
                <div class="info-stat-item">
                  <div class="info-stat-value">${employeeCount}</div>
                  <div class="info-stat-label">Çalışan</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${policyCount}</div>
                  <div class="info-stat-label">Poliçe (Bu Ay)</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${APP_CONFIG.CURRENCY.format(totalPremium)}</div>
                  <div class="info-stat-label">Prim (Bu Ay)</div>
                </div>
                <div class="info-stat-item">
                  <div class="info-stat-value">${APP_CONFIG.CURRENCY.format(avgPremium)}</div>
                  <div class="info-stat-label">Ort. Prim</div>
                </div>
              </div>

              <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeBranchModal()">Kapat</button>
                <button class="btn btn-primary" onclick="goToBranchPage(${branch.id || 0})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                    <polyline points="9,22 9,12 15,12 15,22"/>
                  </svg>
                  Şube Sayfası
                </button>
              </div>
            </div>
          `;
        } else {
          modalBody.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <p>Şube bilgisi bulunamadı.</p>
              <button class="btn btn-secondary" onclick="closeBranchModal()">Kapat</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Şube bilgisi alınamadı:', error);
        modalBody.innerHTML = `
          <div style="text-align: center; padding: 2rem;">
            <p>Şube bilgisi yüklenirken hata oluştu.</p>
            <button class="btn btn-secondary" onclick="closeBranchModal()">Kapat</button>
          </div>
        `;
      }
    }

    function closeBranchModal() {
      document.getElementById('branchModal').classList.remove('active');
    }

    function goToBranchPage(branchId) {
      closeBranchModal();
      window.location.href = `../employees/list.html?branchId=${branchId}`;
    }

    // Helper function for color gradients
    function getColorGradient(color) {
      const gradients = {
        'emerald': '#10b981, #059669',
        'cyan': '#06b6d4, #0891b2',
        'violet': '#8b5cf6, #7c3aed',
        'amber': '#f59e0b, #d97706'
      };
      return gradients[color] || '#6366f1, #4f46e5';
    }

    // ═══════════════════════════════════════════════════════════════
    // EDIT POLICY MODAL
    // ═══════════════════════════════════════════════════════════════

    let currentEditingPolicyId = null;

    function openEditPolicyModal(policyId) {
      const policy = policies.find(p => p.id === policyId);
      if (!policy) {
        showToast('Poliçe bulunamadı', 'error');
        return;
      }

      currentEditingPolicyId = policyId;

      // Form alanlarını doldur
      document.getElementById('editPolicyId').value = policyId;
      document.getElementById('editPolicyNo').value = policy.policyNo || '';
      document.getElementById('editCustomer').value = policy.customer || '';
      document.getElementById('editDate').value = policy.date || '';
      document.getElementById('editNetPremium').value = policy.netPremium || 0;
      document.getElementById('editGrossPremium').value = policy.grossPremium || 0;

      // Poliçe tipi dropdown
      const typeSelect = document.getElementById('editType');
      typeSelect.innerHTML = policyTypes.map(t =>
        `<option value="${t.value}" ${t.value === policy.type ? 'selected' : ''}>${t.value}</option>`
      ).join('');

      // Prodüktör dropdown
      const producerSelect = document.getElementById('editProducer');
      producerSelect.innerHTML = producersList.map(p =>
        `<option value="${p.name}" ${p.name === policy.producer ? 'selected' : ''}>${p.name}</option>`
      ).join('');

      // Şube dropdown
      const branchSelect = document.getElementById('editBranch');
      branchSelect.innerHTML = branchesList.map(b =>
        `<option value="${b}" ${b === policy.branch ? 'selected' : ''}>${b}</option>`
      ).join('');

      // Modalı aç
      document.getElementById('editPolicyModal').classList.add('active');
    }

    function closeEditPolicyModal() {
      document.getElementById('editPolicyModal').classList.remove('active');
      currentEditingPolicyId = null;
    }

    async function saveEditedPolicy(event) {
      event.preventDefault();

      const policyId = currentEditingPolicyId;
      if (!policyId) return;

      const policy = policies.find(p => p.id === policyId);
      if (!policy) return;

      // Form değerlerini al
      const newPolicyNo = document.getElementById('editPolicyNo').value.trim();
      const newType = document.getElementById('editType').value;
      const newDate = document.getElementById('editDate').value;
      const newNetPremium = parseFloat(document.getElementById('editNetPremium').value) || 0;
      const newGrossPremium = parseFloat(document.getElementById('editGrossPremium').value) || 0;
      const newProducer = document.getElementById('editProducer').value;
      const newBranch = document.getElementById('editBranch').value;

      // Değişiklikleri topla
      const changes = {};

      if (newPolicyNo !== policy.policyNo) changes.policyNo = newPolicyNo;
      if (newType !== policy.type) changes.type = newType;
      if (newDate !== policy.date) changes.date = newDate;
      if (newNetPremium !== policy.netPremium) changes.netPremium = newNetPremium;
      if (newGrossPremium !== policy.grossPremium) changes.grossPremium = newGrossPremium;
      if (newProducer !== policy.producer) changes.producer = newProducer;
      if (newBranch !== policy.branch) changes.branch = newBranch;

      // Değişiklik yoksa
      if (Object.keys(changes).length === 0) {
        showToast('Değişiklik yapılmadı', 'info');
        closeEditPolicyModal();
        return;
      }

      // API'ye gönder
      showLoading(true);
      try {
        const result = await apiPut('policies/captured/batch-update', {
          updates: [{ policyId, changes }]
        });

        if (result.success) {
          // Yerel veriyi güncelle
          Object.assign(policy, {
            policyNo: newPolicyNo,
            type: newType,
            typeClass: policyTypes.find(t => t.value === newType)?.class || 'kasko',
            date: newDate,
            dateFormatted: new Date(newDate).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }),
            netPremium: newNetPremium,
            grossPremium: newGrossPremium,
            producer: newProducer,
            branch: newBranch
          });

          // Prodüktör bilgilerini güncelle
          const prod = producersList.find(p => p.name === newProducer);
          if (prod) {
            policy.producerInitials = prod.initials;
            policy.producerColor = prod.color;
          }

          showToast('Poliçe başarıyla güncellendi', 'success');
          closeEditPolicyModal();
          applyFilters(); // Tabloyu yenile
        } else {
          showToast('Güncelleme başarısız: ' + (result.message || 'Bilinmeyen hata'), 'error');
        }
      } catch (error) {
        console.error('Güncelleme hatası:', error);
        showToast('Güncelleme sırasında hata oluştu', 'error');
      } finally {
        showLoading(false);
      }
    }

    // Close modals when clicking overlay
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
        }
      });
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(modal => {
          modal.classList.remove('active');
        });
      }
    });
  </script>
  <script src="../../components/sidebar.js"></script>
</body>
</html>
