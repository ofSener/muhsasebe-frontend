<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Çalışan Listesi - IHSAN AI</title>
  <link rel="stylesheet" href="../../assets/css/main.css">
  <style>
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-backdrop .modal {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      max-width: 90vw;
      max-height: 90vh;
      overflow: hidden;
      animation: modalIn 0.2s ease-out;
    }
    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="../../logo.png" alt="IHSAN AI" onerror="this.style.display='none'; this.parentElement.innerHTML='IA';">
        </div>
        <div class="sidebar-brand">
          <h1>IHSAN AI</h1>
          <span>Sigorta Yönetimi</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Ana Menü</div>
          <div class="nav-item">
            <a href="../../index.html" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
              </svg>
              <span class="nav-text">Dashboard</span>
            </a>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Poliçe İşlemleri</div>
          <div class="nav-item has-submenu">
            <a href="#" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10,9 9,9 8,9"/>
              </svg>
              <span class="nav-text">Poliçeler</span>
              <svg class="nav-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
              </svg>
            </a>
            <div class="nav-submenu">
              <a href="../policies/my-policies.html" class="nav-link"><span class="nav-text">Poliçelerim</span></a>
              <a href="../policies/captured.html" class="nav-link"><span class="nav-text">Yakalanan Poliçeler</span></a>
              <a href="../policies/pool.html" class="nav-link"><span class="nav-text">Poliçe Havuzu</span></a>
              <a href="../policies/add-manual.html" class="nav-link"><span class="nav-text">Manuel Ekle</span></a>
              <a href="../policies/bulk-import.html" class="nav-link"><span class="nav-text">Toplu Aktar</span></a>
            </div>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Yönetim</div>
          <div class="nav-item has-submenu open">
            <a href="#" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                <path d="M16 3.13a4 4 0 010 7.75"/>
              </svg>
              <span class="nav-text">Çalışanlarım</span>
              <svg class="nav-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
              </svg>
            </a>
            <div class="nav-submenu">
              <a href="list.html" class="nav-link active"><span class="nav-text">Çalışan Listesi</span></a>
              <a href="performance.html" class="nav-link"><span class="nav-text">Performans</span></a>
              <a href="tracking.html" class="nav-link"><span class="nav-text">Takip / Hakediş</span></a>
              <a href="commission.html" class="nav-link"><span class="nav-text">Komisyon Ayarları</span></a>
            </div>
          </div>
          <div class="nav-item has-submenu">
            <a href="#" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              <span class="nav-text">Müşterilerimiz</span>
              <svg class="nav-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
              </svg>
            </a>
            <div class="nav-submenu">
              <a href="../customers/list.html" class="nav-link"><span class="nav-text">Müşteri Listesi</span></a>
              <a href="../customers/detail.html" class="nav-link"><span class="nav-text">Müşteri Detay</span></a>
              <a href="../customers/renewals.html" class="nav-link"><span class="nav-text">Yenileme Takibi</span></a>
            </div>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Finans</div>
          <div class="nav-item has-submenu">
            <a href="#" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
              </svg>
              <span class="nav-text">Finans</span>
              <svg class="nav-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
              </svg>
            </a>
            <div class="nav-submenu">
              <a href="../finance/dashboard.html" class="nav-link"><span class="nav-text">Finansal Özet</span></a>
              <a href="../finance/policies.html" class="nav-link"><span class="nav-text">Poliçe Bazlı</span></a>
              <a href="../finance/collections.html" class="nav-link"><span class="nav-text">Tahsilat Takibi</span></a>
              <a href="../finance/reports.html" class="nav-link"><span class="nav-text">Raporlar</span></a>
            </div>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Sistem</div>
          <div class="nav-item has-submenu">
            <a href="#" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
              </svg>
              <span class="nav-text">Ayarlar</span>
              <svg class="nav-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
              </svg>
            </a>
            <div class="nav-submenu">
              <a href="../settings/permissions.html" class="nav-link"><span class="nav-text">Yetki Yönetimi</span></a>
              <a href="../settings/agency-codes.html" class="nav-link"><span class="nav-text">Acente Kodları</span></a>
              <a href="../settings/report-settings.html" class="nav-link"><span class="nav-text">Rapor Ayarları</span></a>
            </div>
          </div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="sidebar-toggle" onclick="document.getElementById('sidebar').classList.toggle('collapsed')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="11,17 6,12 11,7"/>
            <polyline points="18,17 13,12 18,7"/>
          </svg>
          <span class="nav-text">Daralt</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <nav class="navbar">
        <div class="navbar-left">
          <div class="navbar-breadcrumb">
            <span class="breadcrumb-item">Yönetim</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Çalışan Listesi</span>
          </div>
        </div>
        <div class="navbar-right">
          <button class="navbar-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 01-3.46 0"/>
            </svg>
            <span class="badge">3</span>
          </button>
          <div class="navbar-divider"></div>
          <div class="navbar-user">
            <div class="navbar-avatar">AY</div>
            <div class="navbar-user-info">
              <div class="navbar-user-name">Ahmet Yılmaz</div>
              <div class="navbar-user-role">Ana Yönetici</div>
            </div>
          </div>
        </div>
      </nav>

      <!-- Page Wrapper -->
      <div class="page-wrapper">
        <div class="page-content">
        <div class="page-header">
          <div>
            <h1 class="page-title">Çalışan Listesi</h1>
            <p class="page-subtitle">Ekibinizdeki tüm çalışanları yönetin ve takip edin.</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Dışa Aktar
            </button>
            <button class="btn btn-primary" onclick="openAddEmployeeModal()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Yeni Çalışan
            </button>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card stat-cyan">
            <div class="stat-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                <path d="M16 3.13a4 4 0 010 7.75"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statTotal">-</div>
              <div class="stat-label">Toplam Çalışan</div>
            </div>
          </div>

          <div class="stat-card stat-emerald">
            <div class="stat-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                <polyline points="22,4 12,14.01 9,11.01"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statActive">-</div>
              <div class="stat-label">Aktif Çalışan</div>
            </div>
          </div>

          <div class="stat-card stat-amber">
            <div class="stat-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12,6 12,12 16,14"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statInactive">-</div>
              <div class="stat-label">Pasif Çalışan</div>
            </div>
          </div>

          <div class="stat-card stat-violet">
            <div class="stat-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statPerformance">-</div>
              <div class="stat-label">Ort. Performans</div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="card" style="margin-bottom: 1.5rem;">
          <div class="card-body">
            <div class="filters-row">
              <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" class="form-input" placeholder="Çalışan ara (isim, e-posta, telefon)..." style="padding-left: 2.5rem;">
              </div>
              <select class="form-select" style="width: auto;">
                <option value="">Tüm Durumlar</option>
                <option value="active">Aktif</option>
                <option value="inactive">Pasif</option>
              </select>
              <select id="yetkiFilter" class="form-select" style="width: auto;">
                <option value="">Tüm Yetkiler</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Employee Table -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Çalışanlar</h3>
            <div class="card-actions">
              <span class="text-muted">8 çalışan listeleniyor</span>
            </div>
          </div>
          <div class="card-body" style="padding: 0;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Çalışan</th>
                    <th>E-posta</th>
                    <th>Telefon</th>
                    <th>Yetki</th>
                    <th>Durum</th>
                    <th>Poliçe</th>
                    <th>Performans</th>
                    <th>Kayıt Tarihi</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="employeeTableBody">
                  <!-- Veriler JavaScript ile yüklenecek -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Employee Modal -->
  <div class="modal-backdrop" id="addEmployeeModal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Yeni Çalışan Ekle</h3>
        <button class="modal-close" onclick="closeAddEmployeeModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="addEmployeeForm">
          <div class="form-grid-2">
            <div class="form-group">
              <label class="form-label">Ad Soyad</label>
              <input type="text" class="form-input" placeholder="Çalışan adı soyadı" required>
            </div>
            <div class="form-group">
              <label class="form-label">E-posta</label>
              <input type="email" class="form-input" placeholder="ornek@ihsanai.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Telefon</label>
              <input type="tel" class="form-input" placeholder="0532 123 4567">
            </div>
            <div class="form-group">
              <label class="form-label">Yetki</label>
              <select class="form-select" required>
                <option value="">Seçiniz</option>
                <option value="admin">Yönetici</option>
                <option value="agent">Acente</option>
                <option value="intern">Stajyer</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Notlar</label>
            <textarea class="form-textarea" placeholder="Çalışan hakkında ek notlar..." rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddEmployeeModal()">İptal</button>
        <button class="btn btn-primary">Çalışan Ekle</button>
      </div>
    </div>
  </div>

  <!-- Yetki Değiştir Modal -->
  <div class="modal-backdrop" id="yetkiModal" style="display: none;">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Yetki Değiştir</h3>
        <button class="modal-close" onclick="closeYetkiModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Çalışan: <strong id="yetkiModalName"></strong></p>
        <div class="form-group">
          <label class="form-label">Yeni Yetki</label>
          <select id="yetkiModalSelect" class="form-select">
            <option value="">Yükleniyor...</option>
          </select>
        </div>
        <input type="hidden" id="yetkiModalKullaniciId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeYetkiModal()">İptal</button>
        <button class="btn btn-primary" onclick="saveYetki()">Kaydet</button>
      </div>
    </div>
  </div>

  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/app.js"></script>
  <script>

    // Sayfa yüklendiğinde çalışanları ve yetkileri getir
    document.addEventListener('DOMContentLoaded', function() {
      loadKullanicilar();
      loadYetkiler();
    });

    // Kullanıcı bilgisinden FirmaId al
    function getCurrentFirmaId() {
      const user = APP_CONFIG.AUTH.getUser();
      return user?.firmaId || null;
    }

    // Yetkileri API'den yükle (filtre için)
    async function loadYetkiler() {
      const firmaId = getCurrentFirmaId();
      const select = document.getElementById('yetkiFilter');

      try {
        const yetkiler = await apiGet('permissions', firmaId ? { firmaId } : {});
        yetkiler.forEach(y => {
          const option = document.createElement('option');
          option.value = y.id;
          option.textContent = y.yetkiAdi;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Yetkiler yüklenirken hata:', error);
      }
    }

    // Kullanıcıları API'den yükle
    async function loadKullanicilar() {
      const tbody = document.getElementById('employeeTableBody');
      const firmaId = getCurrentFirmaId();

      if (!firmaId) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Firma bilgisi bulunamadı. Lütfen giriş yapın.</td></tr>';
        return;
      }

      tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Yükleniyor...</td></tr>';

      try {
        const kullanicilar = await apiGet('kullanicilar', { firmaId: firmaId });
        renderKullanicilar(kullanicilar);
        updateStats(kullanicilar);
      } catch (error) {
        console.error('Kullanıcılar yüklenirken hata:', error);
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Veriler yüklenirken hata oluştu.</td></tr>';
      }
    }

    // Kullanıcıları tabloya render et
    function renderKullanicilar(kullanicilar) {
      const tbody = document.getElementById('employeeTableBody');
      const countEl = document.querySelector('.card-actions .text-muted');

      if (!kullanicilar || kullanicilar.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Henüz çalışan bulunmuyor.</td></tr>';
        if (countEl) countEl.textContent = '0 çalışan listeleniyor';
        return;
      }

      if (countEl) countEl.textContent = `${kullanicilar.length} çalışan listeleniyor`;

      tbody.innerHTML = kullanicilar.map(k => {
        const isActive = k.onay === 1;
        const initials = getInitials(k.adi, k.soyadi);
        const avatarColor = getAvatarColor(k.id);
        const rolBadge = getRolBadge(k.anaYoneticimi, k.yetkiAdi);
        const durumBadge = isActive
          ? '<span class="badge badge-success">Aktif</span>'
          : '<span class="badge badge-secondary">Pasif</span>';
        const kayitTarihi = formatDate(k.kayitTarihi);
        const telefon = formatPhone(k.gsmNo);
        const rowClass = isActive ? '' : 'row-inactive';
        const avatarStyle = isActive
          ? `avatar avatar-md ${avatarColor}`
          : 'avatar avatar-md" style="background: var(--bg-elevated); color: var(--text-muted);';

        return `
          <tr class="${rowClass}">
            <td>
              <div class="flex items-center gap-3">
                <div class="${avatarStyle}">${initials}</div>
                <div>
                  <div class="font-semibold ${isActive ? '' : 'text-muted'}">${k.adi || ''} ${k.soyadi || ''}</div>
                  <div class="text-muted text-sm">${getRolText(k.anaYoneticimi, k.yetkiAdi)}</div>
                </div>
              </div>
            </td>
            <td class="${isActive ? '' : 'text-muted'}">${k.email || '-'}</td>
            <td class="font-mono ${isActive ? '' : 'text-muted'}">${telefon}</td>
            <td>${rolBadge}</td>
            <td>${durumBadge}</td>
            <td class="font-semibold font-mono ${isActive ? '' : 'text-muted'}">-</td>
            <td><span class="text-muted">-</span></td>
            <td class="text-muted">${kayitTarihi}</td>
            <td>
              <div class="action-buttons">
                ${isActive ? `
                  <button class="btn-icon" title="Yetki Değiştir" onclick="openYetkiModal(${k.id}, ${k.muhasebeYetkiId || 'null'}, '${k.adi || ''} ${k.soyadi || ''}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                  </button>
                  <button class="btn-icon" title="Karta Git" onclick="goToEmployeeCard(${k.id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                    </svg>
                  </button>
                ` : `
                  <button class="btn-icon" title="Aktif Yap" onclick="activateKullanici(${k.id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                  </button>
                `}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // İstatistikleri güncelle
    function updateStats(kullanicilar) {
      const total = kullanicilar.length;
      const active = kullanicilar.filter(k => k.onay === 1).length;
      const inactive = total - active;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statActive').textContent = active;
      document.getElementById('statInactive').textContent = inactive;
      document.getElementById('statPerformance').textContent = '-';
    }

    // Yardımcı fonksiyonlar
    function getInitials(adi, soyadi) {
      const a = (adi || '').charAt(0).toUpperCase();
      const s = (soyadi || '').charAt(0).toUpperCase();
      return a + s || '??';
    }

    function getAvatarColor(id) {
      const colors = ['avatar-emerald', 'avatar-cyan', 'avatar-violet', 'avatar-amber', 'avatar-rose'];
      return colors[id % colors.length];
    }

    function getRolBadge(anaYoneticimi, yetkiAdi) {
      // AnaYoneticimi = 0 ise Ana Yönetici
      if (anaYoneticimi === 0) {
        return '<span class="badge badge-danger">Ana Yönetici</span>';
      }
      // Yetki adı varsa onu göster
      if (yetkiAdi) {
        return `<span class="badge badge-info">${yetkiAdi}</span>`;
      }
      return '<span class="badge badge-secondary">Tanımsız</span>';
    }

    function getRolText(anaYoneticimi, yetkiAdi) {
      if (anaYoneticimi === 0) return 'Ana Yönetici';
      return yetkiAdi || 'Çalışan';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('tr-TR');
    }

    function formatPhone(phone) {
      if (!phone) return '-';
      return phone.replace(/(\d{4})(\d{3})(\d{4})/, '$1 $2 $3');
    }

    // Yetki değiştirme modal fonksiyonları
    let yetkilerCache = null;

    async function openYetkiModal(kullaniciId, currentYetkiId, kullaniciAdi) {
      document.getElementById('yetkiModalKullaniciId').value = kullaniciId;
      document.getElementById('yetkiModalName').textContent = kullaniciAdi;
      document.getElementById('yetkiModal').style.display = 'flex';

      const select = document.getElementById('yetkiModalSelect');

      // Yetkileri cache'den veya API'den al
      if (!yetkilerCache) {
        const firmaId = getCurrentFirmaId();
        yetkilerCache = await apiGet('permissions', firmaId ? { firmaId } : {});
      }

      // Select'i doldur
      select.innerHTML = '<option value="">Yetki Seçiniz</option>';
      yetkilerCache.forEach(y => {
        const option = document.createElement('option');
        option.value = y.id;
        option.textContent = y.yetkiAdi;
        if (y.id === currentYetkiId) option.selected = true;
        select.appendChild(option);
      });
    }

    function closeYetkiModal() {
      document.getElementById('yetkiModal').style.display = 'none';
    }

    async function saveYetki() {
      const kullaniciId = document.getElementById('yetkiModalKullaniciId').value;
      const yetkiId = document.getElementById('yetkiModalSelect').value;

      try {
        await apiPut(`kullanicilar/${kullaniciId}/yetki`, {
          muhasebeYetkiId: yetkiId ? parseInt(yetkiId) : null
        });
        showToast('Yetki başarıyla güncellendi', 'success');
        closeYetkiModal();
        loadKullanicilar(); // Listeyi yenile
      } catch (error) {
        showToast('Yetki güncellenirken hata oluştu', 'error');
        console.error('Yetki güncelleme hatası:', error);
      }
    }

    // Çalışan kartına git
    function goToEmployeeCard(id) {
      window.location.href = `detail.html?id=${id}`;
    }

    function activateKullanici(id) {
      console.log('Aktif yap:', id);
      // TODO: Kullanıcıyı aktif yap
    }

    function openAddEmployeeModal() {
      document.getElementById('addEmployeeModal').style.display = 'flex';
    }

    function closeAddEmployeeModal() {
      document.getElementById('addEmployeeModal').style.display = 'none';
    }
  </script>
</body>
</html>
