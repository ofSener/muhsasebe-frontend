<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Çalışan Listesi - IHSAN AI</title>
  <link rel="stylesheet" href="../../assets/css/main.css">
  <style>
    /* Tablo altı boşluğu kaldır */
    .page-wrapper,
    .page-content {
      flex: initial !important;
    }

    /* Table overflow düzeltmesi */
    .table-container {
      overflow-x: visible;
      overflow-y: visible;
    }
    @media (max-width: 1200px) {
      .table-container {
        overflow-x: auto;
      }
    }

    /* Sortable Table Headers */
    .sortable {
      cursor: pointer;
      user-select: none;
      transition: all 0.15s ease;
      position: relative;
    }
    .sortable:hover {
      color: var(--primary, #6366f1);
    }
    .sort-header {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .sort-icon {
      display: inline-flex;
      flex-direction: column;
      gap: 2px;
      opacity: 0.3;
      transition: opacity 0.15s ease;
    }
    .sortable:hover .sort-icon {
      opacity: 0.6;
    }
    .sort-icon svg {
      width: 10px;
      height: 10px;
      transition: all 0.15s ease;
    }
    .sort-icon .sort-asc,
    .sort-icon .sort-desc {
      color: var(--text-muted, #9ca3af);
    }
    /* Active sort states */
    .sortable.asc .sort-icon,
    .sortable.desc .sort-icon {
      opacity: 1;
    }
    .sortable.asc .sort-icon .sort-asc {
      color: var(--primary, #6366f1);
    }
    .sortable.asc .sort-icon .sort-desc {
      opacity: 0.2;
    }
    .sortable.desc .sort-icon .sort-desc {
      color: var(--primary, #6366f1);
    }
    .sortable.desc .sort-icon .sort-asc {
      opacity: 0.2;
    }

    /* Modern Gradient Stat Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 1200px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .stats-grid { grid-template-columns: 1fr; }
    }

    .stat-card {
      position: relative;
      padding: 1.5rem;
      border-radius: 16px;
      display: flex;
      align-items: center;
      gap: 1rem;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 50%;
      transform: translate(30%, -30%);
    }
    .stat-card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 80px;
      height: 80px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 50%;
      transform: translate(-30%, 30%);
    }

    .stat-icon {
      width: 52px;
      height: 52px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      color: #fff;
      flex-shrink: 0;
      z-index: 1;
    }
    .stat-content {
      z-index: 1;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #fff;
      line-height: 1.1;
      letter-spacing: -0.02em;
    }
    .stat-label {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 0.25rem;
      font-weight: 500;
    }

    /* Gradient Renkleri */
    .stat-card.stat-cyan {
      background: linear-gradient(135deg, #0891b2 0%, #06b6d4 50%, #22d3ee 100%);
    }
    .stat-card.stat-emerald {
      background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
    }
    .stat-card.stat-amber {
      background: linear-gradient(135deg, #d97706 0%, #f59e0b 50%, #fbbf24 100%);
    }
    .stat-card.stat-violet {
      background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 50%, #a78bfa 100%);
    }
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-backdrop .modal {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      max-width: 90vw;
      max-height: 90vh;
      overflow: hidden;
      animation: modalIn 0.2s ease-out;
    }
    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Modern Dropdown Styles - Tüm select'ler için */
    .form-select,
    .permission-select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding: 0.625rem 2.25rem 0.625rem 0.875rem;
      border: 1px solid var(--border-default);
      border-radius: 0.5rem;
      background-color: var(--bg-surface);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px;
      color: var(--text-primary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 140px;
    }
    .form-select:hover,
    .permission-select:hover {
      border-color: var(--border-hover, #4b5563);
      background-color: var(--bg-elevated);
    }
    .form-select:focus,
    .permission-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      background-color: var(--bg-surface);
    }
    .form-select option,
    .permission-select option {
      padding: 0.5rem;
      background: var(--bg-surface);
      color: var(--text-primary);
    }

    /* Tablo içi permission select - daha kompakt */
    .permission-select {
      padding: 0.5rem 2rem 0.5rem 0.75rem;
      font-size: 0.8125rem;
      min-width: 150px;
      max-width: 170px;
      background-color: rgba(99, 102, 241, 0.05);
      border-color: rgba(99, 102, 241, 0.2);
    }
    .permission-select:hover {
      background-color: rgba(99, 102, 241, 0.1);
      border-color: rgba(99, 102, 241, 0.3);
    }
    .permission-select:focus {
      background-color: rgba(99, 102, 241, 0.08);
    }

    /* Değişiklik yapılmış dropdown */
    .permission-select.changed {
      border-color: #f59e0b;
      background-color: rgba(245, 158, 11, 0.1);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f59e0b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
    }
    .permission-select.changed:hover {
      border-color: #d97706;
      background-color: rgba(245, 158, 11, 0.15);
    }

    /* Filtre kartı */
    .filters-card {
      position: relative;
      z-index: 500;
      margin-bottom: 1.5rem;
    }

    /* Filtre satırı stili */
    .filters-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: nowrap;
    }
    .filters-row .search-box {
      flex: 1;
      min-width: 200px;
      position: relative;
    }
    .filters-row .search-icon {
      position: absolute;
      left: 0.875rem;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: var(--text-muted);
      pointer-events: none;
      z-index: 1;
    }
    .filters-row .search-input {
      width: 100%;
      padding-left: 2.75rem;
    }

    /* Custom Dropdown Styles */
    .custom-dropdown {
      position: relative;
      flex-shrink: 0;
      z-index: 10;
    }
    .custom-dropdown.open {
      z-index: 9999;
    }
    .custom-dropdown.filter-dropdown {
      width: 160px;
    }
    .dropdown-toggle {
      width: 100%;
      padding: 0.625rem 2.25rem 0.625rem 0.875rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      background-color: #fff;
      color: #374151;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      position: relative;
    }
    .dropdown-toggle::after {
      content: '';
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 5px solid #9ca3af;
      transition: transform 0.2s ease;
    }
    .custom-dropdown.open .dropdown-toggle::after {
      transform: translateY(-50%) rotate(180deg);
      border-top-color: #6366f1;
    }
    .dropdown-toggle:hover {
      border-color: #d1d5db;
      background-color: #f9fafb;
    }
    .dropdown-toggle:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }
    .custom-dropdown.open .dropdown-toggle {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      background-color: #fff;
    }

    .dropdown-menu {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: linear-gradient(145deg, #f8f9fc 0%, #eef0f5 100%);
      border: 1px solid rgba(99, 102, 241, 0.15);
      border-radius: 0.75rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(99, 102, 241, 0.1);
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
      max-height: 240px;
      overflow-y: auto;
      padding: 0.375rem;
    }
    .custom-dropdown.open .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .dropdown-menu::-webkit-scrollbar {
      width: 6px;
    }
    .dropdown-menu::-webkit-scrollbar-track {
      background: transparent;
    }
    .dropdown-menu::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    .dropdown-item {
      padding: 0.625rem 0.875rem;
      font-size: 0.875rem;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: 0.5rem;
      margin: 2px 0;
    }
    .dropdown-item:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(139, 92, 246, 0.08) 100%);
      color: #4338ca;
    }
    .dropdown-item.selected {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
      color: #4338ca;
      font-weight: 600;
    }
    .dropdown-item.selected::before {
      content: '✓';
      font-size: 0.7rem;
      color: #10b981;
      font-weight: bold;
    }

    /* Permission dropdown in table */
    .permission-dropdown {
      min-width: 160px;
    }
    .permission-dropdown .dropdown-toggle {
      padding: 0.5rem 2rem 0.5rem 0.75rem;
      font-size: 0.8125rem;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border: none;
      color: #fff;
    }
    .permission-dropdown .dropdown-toggle::after {
      border-top-color: rgba(255, 255, 255, 0.7);
    }
    .permission-dropdown .dropdown-toggle:hover {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    }
    .permission-dropdown.open .dropdown-toggle {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
    }
    .permission-dropdown.changed .dropdown-toggle {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25);
    }
    .permission-dropdown.changed .dropdown-toggle:hover {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    }
    .permission-dropdown .dropdown-menu {
      min-width: 180px;
    }

    /* Yukarı açılan dropdown */
    .permission-dropdown.open-up .dropdown-menu {
      top: auto;
      bottom: calc(100% + 4px);
      transform-origin: bottom center;
    }
    .permission-dropdown.open-up.open .dropdown-menu {
      transform: translateY(0);
    }

    /* Floating Menu (body'e eklenen) */
    .dropdown-menu-floating {
      position: fixed !important;
      opacity: 1 !important;
      visibility: visible !important;
      transform: none !important;
      display: block !important;
      background: linear-gradient(145deg, #ffffff 0%, #f8f9fc 100%);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 0.75rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25), 0 8px 24px rgba(99, 102, 241, 0.15);
      z-index: 99999 !important;
      max-height: 280px !important;
      overflow-x: hidden !important;
      overflow-y: auto !important;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      padding: 0.5rem;
    }
    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .dropdown-menu-floating .dropdown-item {
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      color: #374151;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: 0.5rem;
      margin: 2px 0;
      background: transparent;
    }
    .dropdown-menu-floating .dropdown-item:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.06) 100%);
      color: #4338ca;
    }
    .dropdown-menu-floating .dropdown-item.selected {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
      color: #4338ca;
      font-weight: 600;
    }
    .dropdown-menu-floating .dropdown-item.selected::before {
      content: '\2713';
      font-size: 0.75rem;
      color: #10b981;
      font-weight: bold;
      margin-right: 0.25rem;
    }
    .dropdown-menu-floating::-webkit-scrollbar {
      width: 6px;
    }
    .dropdown-menu-floating::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 3px;
    }
    .dropdown-menu-floating::-webkit-scrollbar-thumb {
      background: rgba(99, 102, 241, 0.3);
      border-radius: 3px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .filters-row {
        flex-wrap: wrap;
      }
      .filters-row .search-box {
        width: 100%;
        flex: none;
      }
      .custom-dropdown.filter-dropdown {
        flex: 1;
        min-width: 120px;
      }
    }

    /* Floating Action Box */
    .floating-action-box {
      position: fixed;
      right: -320px;
      top: 50%;
      transform: translateY(-50%);
      width: 280px;
      background: #1a1b23;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-right: none;
      border-radius: 16px 0 0 16px;
      padding: 1.5rem;
      z-index: 1000;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: -8px 0 32px rgba(0, 0, 0, 0.4);
    }
    .floating-action-box.active {
      right: 0;
    }
    .fab-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1.25rem;
    }
    .fab-count {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }
    .fab-count span {
      font-size: 2.5rem;
      font-weight: 800;
      color: #fff;
      line-height: 1;
      letter-spacing: -0.02em;
    }
    .fab-count small {
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 500;
    }
    .fab-close {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      transition: all 0.15s ease;
    }
    .fab-close:hover {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }
    .fab-stats {
      margin-bottom: 1.25rem;
      padding: 1rem;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(99, 102, 241, 0.15);
    }
    .fab-stat {
      text-align: center;
    }
    .fab-stat-value {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: #a5b4fc;
      max-height: 80px;
      overflow-y: auto;
      text-align: left;
    }
    .fab-stat-label {
      display: block;
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }
    .fab-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .fab-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
    }
    .fab-btn svg {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
    }
    .fab-btn-primary {
      background: #10b981;
      color: #fff;
    }
    .fab-btn-primary:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    .fab-btn-outline {
      background: transparent;
      color: #9ca3af;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .fab-btn-outline:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
  <div class="gradient-mesh"></div>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar"></aside>

    <!-- Main Content -->
    <main class="main-content">
      <nav class="navbar">
        <div class="navbar-left">
          <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Menü">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </button>
          <div class="navbar-breadcrumb">
            <span class="breadcrumb-item">Yönetim</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Çalışan Listesi</span>
          </div>
        </div>
        <div class="navbar-right">
          <button class="navbar-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 01-3.46 0"/>
            </svg>
            <span class="badge">3</span>
          </button>
          <div class="navbar-divider"></div>
          <div class="navbar-user">
            <div class="navbar-avatar">AY</div>
            <div class="navbar-user-info">
              <div class="navbar-user-name">Ahmet Yılmaz</div>
              <div class="navbar-user-role">Ana Yönetici</div>
            </div>
          </div>
        </div>
      </nav>

      <!-- Page Wrapper -->
      <div class="page-wrapper">
        <div class="page-content">
        <div class="page-header">
          <div>
            <h1 class="page-title">Çalışan Listesi</h1>
            <p class="page-subtitle">Ekibinizdeki tüm çalışanları yönetin ve takip edin.</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Dışa Aktar
            </button>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card stat-cyan">
            <div class="stat-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                <path d="M16 3.13a4 4 0 010 7.75"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statTotal">-</div>
              <div class="stat-label">Toplam Çalışan</div>
            </div>
          </div>

          <div class="stat-card stat-emerald">
            <div class="stat-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                <polyline points="22,4 12,14.01 9,11.01"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statActive">-</div>
              <div class="stat-label">Aktif Çalışan</div>
            </div>
          </div>

          <div class="stat-card stat-amber">
            <div class="stat-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12,6 12,12 16,14"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statInactive">-</div>
              <div class="stat-label">Pasif Çalışan</div>
            </div>
          </div>

        </div>

        <!-- Filters -->
        <div class="card filters-card">
          <div class="card-body" style="overflow: visible;">
            <div class="filters-row">
              <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" id="searchInput" class="form-input search-input" placeholder="Çalışan ara..." oninput="applyFilters()">
              </div>

              <!-- Durum Filter Dropdown -->
              <div class="custom-dropdown filter-dropdown" id="durumDropdown">
                <button type="button" class="dropdown-toggle" onclick="toggleDropdown('durumDropdown')">
                  <span class="dropdown-text">Tüm Durumlar</span>
                </button>
                <div class="dropdown-menu">
                  <div class="dropdown-item selected" data-value="" onclick="selectDropdownItem('durumDropdown', '', 'Tüm Durumlar')">Tüm Durumlar</div>
                  <div class="dropdown-item" data-value="active" onclick="selectDropdownItem('durumDropdown', 'active', 'Aktif')">Aktif</div>
                  <div class="dropdown-item" data-value="inactive" onclick="selectDropdownItem('durumDropdown', 'inactive', 'Pasif')">Pasif</div>
                </div>
                <input type="hidden" id="durumFilter" value="">
              </div>

              <!-- Yetki Filter Dropdown -->
              <div class="custom-dropdown filter-dropdown" id="yetkiDropdown">
                <button type="button" class="dropdown-toggle" onclick="toggleDropdown('yetkiDropdown')">
                  <span class="dropdown-text">Tüm Yetkiler</span>
                </button>
                <div class="dropdown-menu" id="yetkiDropdownMenu">
                  <div class="dropdown-item selected" data-value="" onclick="selectDropdownItem('yetkiDropdown', '', 'Tüm Yetkiler')">Tüm Yetkiler</div>
                  <div class="dropdown-item" data-value="ana-yonetici" onclick="selectDropdownItem('yetkiDropdown', 'ana-yonetici', 'Ana Yönetici')">Ana Yönetici</div>
                </div>
                <input type="hidden" id="yetkiFilter" value="">
              </div>
            </div>
          </div>
        </div>

        <!-- Employee Table -->
        <div class="card" style="position: relative; z-index: 1;">
          <div class="card-header">
            <h3 class="card-title">Çalışanlar</h3>
            <div class="card-actions">
              <span class="text-muted">8 çalışan listeleniyor</span>
            </div>
          </div>
          <div class="card-body" style="padding: 0;">
            <div class="table-container">
              <table class="data-table mobile-cards">
                <thead>
                  <tr>
                    <th class="sortable" data-sort="name" onclick="sortTable('name')">
                      <span class="sort-header">
                        Çalışan
                        <span class="sort-icon">
                          <svg class="sort-asc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5H7z"/></svg>
                          <svg class="sort-desc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5H7z"/></svg>
                        </span>
                      </span>
                    </th>
                    <th class="sortable" data-sort="email" onclick="sortTable('email')">
                      <span class="sort-header">
                        E-posta
                        <span class="sort-icon">
                          <svg class="sort-asc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5H7z"/></svg>
                          <svg class="sort-desc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5H7z"/></svg>
                        </span>
                      </span>
                    </th>
                    <th>Telefon</th>
                    <th class="sortable" data-sort="yetki" onclick="sortTable('yetki')">
                      <span class="sort-header">
                        Yetki
                        <span class="sort-icon">
                          <svg class="sort-asc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5H7z"/></svg>
                          <svg class="sort-desc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5H7z"/></svg>
                        </span>
                      </span>
                    </th>
                    <th class="sortable" data-sort="durum" onclick="sortTable('durum')">
                      <span class="sort-header">
                        Durum
                        <span class="sort-icon">
                          <svg class="sort-asc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5H7z"/></svg>
                          <svg class="sort-desc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5H7z"/></svg>
                        </span>
                      </span>
                    </th>
                    <th class="sortable" data-sort="police" onclick="sortTable('police')">
                      <span class="sort-header">
                        Poliçe
                        <span class="sort-icon">
                          <svg class="sort-asc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5H7z"/></svg>
                          <svg class="sort-desc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5H7z"/></svg>
                        </span>
                      </span>
                    </th>
                    <th class="sortable" data-sort="tarih" onclick="sortTable('tarih')">
                      <span class="sort-header">
                        Kayıt Tarihi
                        <span class="sort-icon">
                          <svg class="sort-asc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5H7z"/></svg>
                          <svg class="sort-desc" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5H7z"/></svg>
                        </span>
                      </span>
                    </th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="employeeTableBody">
                  <!-- Veriler JavaScript ile yüklenecek -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Floating Action Box for Permission Changes -->
  <div class="floating-action-box" id="floatingActionBox">
    <div class="fab-header">
      <div class="fab-count">
        <span id="fabCount">0</span>
        <small>değişiklik yapıldı</small>
      </div>
      <button class="fab-close" onclick="cancelAllChanges()" title="İptal Et">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="fab-stats">
      <div class="fab-stat">
        <span class="fab-stat-value" id="fabChangesList"></span>
        <span class="fab-stat-label">Değiştirilecek Yetkiler</span>
      </div>
    </div>
    <div class="fab-actions">
      <button class="fab-btn fab-btn-primary" onclick="applyAllChanges()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        Değişiklikleri Uygula
      </button>
      <button class="fab-btn fab-btn-outline" onclick="cancelAllChanges()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
          <path d="M3 3v5h5"/>
        </svg>
        İptal Et
      </button>
    </div>
  </div>

  <!-- Add Employee Modal -->
  <div class="modal-backdrop" id="addEmployeeModal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Yeni Çalışan Ekle</h3>
        <button class="modal-close" onclick="closeAddEmployeeModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="addEmployeeForm">
          <div class="form-grid-2">
            <div class="form-group">
              <label class="form-label">Ad Soyad</label>
              <input type="text" class="form-input" placeholder="Çalışan adı soyadı" required>
            </div>
            <div class="form-group">
              <label class="form-label">E-posta</label>
              <input type="email" class="form-input" placeholder="ornek@ihsanai.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Telefon</label>
              <input type="tel" class="form-input" placeholder="0532 123 4567">
            </div>
            <div class="form-group">
              <label class="form-label">Yetki</label>
              <select class="form-select" required>
                <option value="">Seçiniz</option>
                <option value="admin">Yönetici</option>
                <option value="agent">Acente</option>
                <option value="intern">Stajyer</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Notlar</label>
            <textarea class="form-textarea" placeholder="Çalışan hakkında ek notlar..." rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddEmployeeModal()">İptal</button>
        <button class="btn btn-primary">Çalışan Ekle</button>
      </div>
    </div>
  </div>

  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/app.js"></script>
  <script>
    // Global değişkenler
    let yetkilerCache = null;
    let kullanicilarCache = [];
    let pendingPermissionChanges = {};
    // Sıralama durumu: null = sıralama yok (API sırası), değer varsa = aktif sıralama
    let currentSort = { field: null, direction: null };

    // Sayfa yüklendiğinde önce yetkileri sonra çalışanları getir
    document.addEventListener('DOMContentLoaded', async function() {
      await loadYetkiler(); // Önce yetkiler yüklensin
      await loadKullanicilar(); // Sonra çalışanlar

      // Dışarı tıklandığında dropdown'ları kapat
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.custom-dropdown') && !e.target.closest('.dropdown-menu-floating')) {
          closeAllDropdowns();
        }
      });

      // Floating menu'daki tıklamaları dinle (event delegation)
      document.addEventListener('click', function(e) {
        const floatingMenu = e.target.closest('.dropdown-menu-floating');
        if (floatingMenu && e.target.classList.contains('dropdown-item')) {
          e.preventDefault();
          e.stopPropagation();

          const value = e.target.dataset.value || '';
          const text = e.target.textContent.trim();

          // Hangi dropdown'a ait olduğunu bul (floating menu'daki dataset'ten veya açık dropdown'dan)
          const dropdownId = floatingMenu.dataset.dropdownId || document.querySelector('.custom-dropdown.open')?.id;

          if (dropdownId) {
            selectDropdownItem(dropdownId, value, text);
          }
        }
      });

      // Scroll olduğunda dropdown'ları kapat
      window.addEventListener('scroll', function() {
        closeAllDropdowns();
      }, { passive: true });
    });

    // Custom Dropdown Fonksiyonları
    function toggleDropdown(dropdownId) {
      const dropdown = document.getElementById(dropdownId);
      const wasOpen = dropdown.classList.contains('open');

      // Diğer tüm dropdown'ları kapat
      closeAllDropdowns();

      // Bu dropdown'ı aç/kapat
      if (!wasOpen) {
        dropdown.classList.add('open');
        positionDropdownMenu(dropdown);
      }
    }

    function closeAllDropdowns() {
      document.querySelectorAll('.custom-dropdown.open').forEach(d => {
        d.classList.remove('open');
        // Orijinal menüyü tekrar göster
        const menu = d.querySelector('.dropdown-menu');
        if (menu) menu.style.display = '';
      });
      // Body'deki floating menu'ları kaldır
      document.querySelectorAll('.dropdown-menu-floating').forEach(m => m.remove());
    }

    function positionDropdownMenu(dropdown) {
      const toggle = dropdown.querySelector('.dropdown-toggle');
      const menu = dropdown.querySelector('.dropdown-menu');

      // Önceki floating menüleri temizle
      document.querySelectorAll('.dropdown-menu-floating').forEach(m => m.remove());

      // Menüyü klonla ve body'e ekle
      const floatingMenu = menu.cloneNode(true);
      floatingMenu.classList.add('dropdown-menu-floating');

      // Inline onclick handler'ları kaldır (event delegation ile çalışacak)
      floatingMenu.querySelectorAll('.dropdown-item').forEach(item => {
        item.removeAttribute('onclick');
      });

      // Orijinal menüyü gizle
      menu.style.display = 'none';

      // Toggle'ın pozisyonunu al
      const rect = toggle.getBoundingClientRect();

      // Dropdown ID'sini floating menu'ya ekle (hangi dropdown'a ait olduğunu bilmek için)
      floatingMenu.dataset.dropdownId = dropdown.id;

      // Pozisyonlama
      floatingMenu.style.top = (rect.bottom + 4) + 'px';
      floatingMenu.style.left = rect.left + 'px';
      floatingMenu.style.width = Math.max(rect.width, 160) + 'px';

      document.body.appendChild(floatingMenu);

      // Ekranın dışına çıkıyorsa yukarı aç
      const menuRect = floatingMenu.getBoundingClientRect();
      if (menuRect.bottom > window.innerHeight - 10) {
        floatingMenu.style.top = (rect.top - menuRect.height - 4) + 'px';
      }
    }

    function selectDropdownItem(dropdownId, value, text) {
      const dropdown = document.getElementById(dropdownId);
      const hiddenInput = dropdown.querySelector('input[type="hidden"]');
      const toggleText = dropdown.querySelector('.dropdown-text');

      // Hidden input değerini güncelle
      hiddenInput.value = value;

      // Toggle text'i güncelle
      toggleText.textContent = text;

      // Selected class'ını güncelle
      dropdown.querySelectorAll('.dropdown-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.value === value);
      });

      // Dropdown'ı kapat
      closeAllDropdowns();

      // Filtreleri uygula
      applyFilters();
    }

    // Permission dropdown için toggle
    function togglePermissionDropdown(btn) {
      const dropdown = btn.closest('.custom-dropdown');
      const wasOpen = dropdown.classList.contains('open');

      // Diğer tüm dropdown'ları kapat
      document.querySelectorAll('.custom-dropdown.open').forEach(d => {
        d.classList.remove('open');
        d.classList.remove('open-up');
      });

      // Bu dropdown'ı aç/kapat
      if (!wasOpen) {
        // Dropdown'un ekrandaki pozisyonunu kontrol et
        const rect = btn.getBoundingClientRect();
        const menuHeight = 200; // Yaklaşık menu yüksekliği
        const spaceBelow = window.innerHeight - rect.bottom;

        // Altında yeterli alan yoksa yukarı aç
        if (spaceBelow < menuHeight) {
          dropdown.classList.add('open-up');
        }

        dropdown.classList.add('open');
      }
    }

    // Permission seçildiğinde
    function selectPermission(item, value, text) {
      const dropdown = item.closest('.custom-dropdown');
      const employeeId = parseInt(dropdown.dataset.employeeId);
      const employeeName = dropdown.dataset.employeeName;
      const originalValue = dropdown.dataset.original;

      // Toggle text'i güncelle
      dropdown.querySelector('.dropdown-text').textContent = text;

      // Selected class'ını güncelle
      dropdown.querySelectorAll('.dropdown-item').forEach(i => {
        i.classList.toggle('selected', i.dataset.value == value);
      });

      // Dropdown'ı kapat
      dropdown.classList.remove('open');

      // Permission change işlemini yap
      const newValue = value ? parseInt(value) : null;
      onPermissionChange(employeeId, newValue, employeeName, dropdown);
    }

    // Kullanıcı bilgisinden FirmaId al
    function getCurrentFirmaId() {
      const user = APP_CONFIG.AUTH.getUser();
      return user?.firmaId || null;
    }

    // Yetkileri API'den yükle (filtre ve dropdown için)
    async function loadYetkiler() {
      const firmaId = getCurrentFirmaId();
      const dropdownMenu = document.getElementById('yetkiDropdownMenu');

      try {
        const yetkiler = await apiGet('permissions', firmaId ? { firmaId } : {});
        yetkilerCache = yetkiler; // Cache'e kaydet

        // Custom dropdown menu'ya yetkileri ekle
        yetkiler.forEach(y => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.dataset.value = y.id;
          item.textContent = y.yetkiAdi;
          item.onclick = () => selectDropdownItem('yetkiDropdown', String(y.id), y.yetkiAdi);
          dropdownMenu.appendChild(item);
        });
      } catch (error) {
        console.error('Yetkiler yüklenirken hata:', error);
      }
    }

    // Kullanıcıları API'den yükle
    async function loadKullanicilar() {
      const tbody = document.getElementById('employeeTableBody');
      const firmaId = getCurrentFirmaId();

      if (!firmaId) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Firma bilgisi bulunamadı. Lütfen giriş yapın.</td></tr>';
        return;
      }

      tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Yükleniyor...</td></tr>';

      try {
        const kullanicilar = await apiGet('kullanicilar', { firmaId: firmaId });
        kullanicilarCache = kullanicilar; // Cache'e kaydet (API sırasını korur)
        updateStats(kullanicilar);
        applyFilters();
      } catch (error) {
        console.error('Kullanıcılar yüklenirken hata:', error);
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Veriler yüklenirken hata oluştu.</td></tr>';
      }
    }

    // Kullanıcıları tabloya render et
    function renderKullanicilar(kullanicilar) {
      const tbody = document.getElementById('employeeTableBody');
      const countEl = document.querySelector('.card-actions .text-muted');

      if (!kullanicilar || kullanicilar.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Henüz çalışan bulunmuyor.</td></tr>';
        if (countEl) countEl.textContent = '0 çalışan listeleniyor';
        return;
      }

      if (countEl) countEl.textContent = `${kullanicilar.length} çalışan listeleniyor`;

      // Yetki dropdown seçeneklerini oluştur
      const yetkiDropdownItems = yetkilerCache ? yetkilerCache.map(y =>
        `<div class="dropdown-item" data-value="${y.id}" onclick="selectPermission(this, ${y.id}, '${y.yetkiAdi.replace(/'/g, "\\'")}')">${y.yetkiAdi}</div>`
      ).join('') : '';

      tbody.innerHTML = kullanicilar.map(k => {
        const isActive = k.onay === 1;
        const initials = getInitials(k.adi, k.soyadi);
        const avatarColor = getAvatarColor(k.id);
        const durumBadge = isActive
          ? '<span class="badge badge-success">Aktif</span>'
          : '<span class="badge badge-secondary">Pasif</span>';
        const kayitTarihi = formatDate(k.kayitTarihi);
        const telefon = formatPhone(k.gsmNo);
        const rowClass = isActive ? '' : 'row-inactive';
        const avatarStyle = isActive
          ? `avatar avatar-md ${avatarColor}`
          : 'avatar avatar-md" style="background: var(--bg-elevated); color: var(--text-muted);';

        // Ana yönetici için dropdown gösterme
        const isAnaYonetici = k.anaYoneticimi === 0;
        const currentYetkiName = k.yetkiAdi || 'Yetki Seçiniz';
        const employeeName = `${(k.adi || '').replace(/'/g, "\\'")} ${(k.soyadi || '').replace(/'/g, "\\'")}`;

        const yetkiCell = isAnaYonetici
          ? '<span class="badge badge-danger">Ana Yönetici</span>'
          : (isActive
            ? `<div class="custom-dropdown permission-dropdown" data-employee-id="${k.id}" data-employee-name="${employeeName}" data-original="${k.muhasebeYetkiId || ''}">
                <button type="button" class="dropdown-toggle" onclick="togglePermissionDropdown(this)">
                  <span class="dropdown-text">${currentYetkiName}</span>
                </button>
                <div class="dropdown-menu">
                  <div class="dropdown-item ${!k.muhasebeYetkiId ? 'selected' : ''}" data-value="" onclick="selectPermission(this, '', 'Yetki Seçiniz')">Yetki Seçiniz</div>
                  ${yetkiDropdownItems.replace(new RegExp(`data-value="${k.muhasebeYetkiId}"`, 'g'), `data-value="${k.muhasebeYetkiId}" class="dropdown-item selected"`)}
                </div>
              </div>`
            : '<span class="badge badge-secondary">-</span>');

        return `
          <tr class="${rowClass}" data-employee-id="${k.id}">
            <td>
              <div class="flex items-center gap-3">
                <div class="${avatarStyle}">${initials}</div>
                <div>
                  <div class="font-semibold ${isActive ? '' : 'text-muted'}">${k.adi || ''} ${k.soyadi || ''}</div>
                  <div class="text-muted text-sm">${getRolText(k.anaYoneticimi, k.yetkiAdi)}</div>
                </div>
              </div>
            </td>
            <td class="${isActive ? '' : 'text-muted'}">${k.email || '-'}</td>
            <td class="font-mono ${isActive ? '' : 'text-muted'}">${telefon}</td>
            <td>${yetkiCell}</td>
            <td>${durumBadge}</td>
            <td class="font-semibold font-mono ${isActive ? '' : 'text-muted'}">${k.policeSayisi || 0}</td>
            <td class="text-muted">${kayitTarihi}</td>
            <td>
              <div class="action-buttons">
                ${isActive ? `
                  <button class="btn-icon" title="Karta Git" onclick="goToEmployeeCard(${k.id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                    </svg>
                  </button>
                ` : `
                  <button class="btn-icon" title="Aktif Yap" onclick="activateKullanici(${k.id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                  </button>
                `}
              </div>
            </td>
          </tr>
        `;
      }).join('');

    }


    // İstatistikleri güncelle
    function updateStats(kullanicilar) {
      const total = kullanicilar.length;
      const active = kullanicilar.filter(k => k.onay === 1).length;
      const inactive = total - active;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statActive').textContent = active;
      document.getElementById('statInactive').textContent = inactive;
    }

    // Filtreleri uygula
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const durumFilter = document.getElementById('durumFilter').value;
      const yetkiFilter = document.getElementById('yetkiFilter').value;

      // Filtreleme işlemi
      let filtered = kullanicilarCache.filter(k => {
        // Arama filtresi
        if (searchTerm) {
          const fullName = `${k.adi || ''} ${k.soyadi || ''}`.toLowerCase();
          const email = (k.email || '').toLowerCase();
          const phone = (k.gsmNo || '').toLowerCase();
          if (!fullName.includes(searchTerm) && !email.includes(searchTerm) && !phone.includes(searchTerm)) {
            return false;
          }
        }

        // Durum filtresi
        if (durumFilter) {
          const isActive = k.onay === 1 && !k.isEski;
          if (durumFilter === 'active' && !isActive) return false;
          if (durumFilter === 'inactive' && isActive) return false;
        }

        // Yetki filtresi
        if (yetkiFilter) {
          if (yetkiFilter === 'ana-yonetici') {
            if (k.anaYoneticimi !== 0) return false;
          } else {
            if (k.muhasebeYetkiId !== parseInt(yetkiFilter)) return false;
          }
        }

        return true;
      });

      // Sıralamayı uygula (sadece aktif sort varsa)
      if (currentSort.field && currentSort.direction) {
        filtered = sortData(filtered, currentSort.field, currentSort.direction);
      }
      // else: API sırasını koru (zaten kayıt tarihine göre desc)

      // Tabloyu güncelle
      renderKullanicilar(filtered);

      // Sayacı güncelle
      const countEl = document.querySelector('.card-actions .text-muted');
      if (countEl) {
        const totalCount = kullanicilarCache.length;
        if (filtered.length === totalCount) {
          countEl.textContent = `${totalCount} çalışan listeleniyor`;
        } else {
          countEl.textContent = `${filtered.length} / ${totalCount} çalışan gösteriliyor`;
        }
      }
    }

    // Sıralama değerini al
    function getSortValue(item, field) {
      switch (field) {
        case 'name':
          return `${item.adi || ''} ${item.soyadi || ''}`.toLocaleLowerCase('tr').trim();
        case 'email':
          return (item.email || '').toLocaleLowerCase('tr');
        case 'yetki':
          if (item.anaYoneticimi === 0) return '00-ana yönetici';
          if (!item.yetkiAdi) return '99-tanımsız';
          return `10-${item.yetkiAdi}`.toLocaleLowerCase('tr');
        case 'durum':
          return (item.onay === 1 && !item.isEski) ? 0 : 1;
        case 'police':
          return Number(item.policeSayisi) || 0;
        case 'tarih':
          if (!item.kayitTarihi) return null;
          const timestamp = new Date(item.kayitTarihi).getTime();
          return isNaN(timestamp) ? null : timestamp;
        default:
          return '';
      }
    }

    // Veri sıralama fonksiyonu
    function sortData(data, field, direction) {
      if (!field || !direction) return data;

      return [...data].sort((a, b) => {
        const valueA = getSortValue(a, field);
        const valueB = getSortValue(b, field);

        // Tarih sıralamasında null değerleri her zaman sona at
        if (field === 'tarih') {
          const aIsNull = valueA === null;
          const bIsNull = valueB === null;

          // Null değerler her zaman sona gider
          if (aIsNull && bIsNull) return 0;
          if (aIsNull) return 1;
          if (bIsNull) return -1;

          // Her iki değer de geçerli tarih - doğrudan karşılaştır
          const comparison = valueA - valueB;
          return direction === 'desc' ? -comparison : comparison;
        }

        let comparison = 0;
        if (typeof valueA === 'number' && typeof valueB === 'number') {
          comparison = valueA - valueB;
        } else {
          comparison = String(valueA).localeCompare(String(valueB), 'tr');
        }

        return direction === 'desc' ? -comparison : comparison;
      });
    }

    // Tablo sıralama fonksiyonu (3 aşamalı: asc → desc → kapalı)
    function sortTable(field) {
      // Tüm header'lardan class'ları kaldır
      document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
      });

      // Sıralama durumunu belirle
      if (currentSort.field === field) {
        // Aynı sütuna tıklandı - döngü: asc → desc → null
        if (currentSort.direction === 'asc') {
          currentSort.direction = 'desc';
        } else if (currentSort.direction === 'desc') {
          // 3. tık: sıralamayı kapat
          currentSort.field = null;
          currentSort.direction = null;
        } else {
          // null'dan asc'ye
          currentSort.direction = 'asc';
        }
      } else {
        // Farklı sütuna tıklandı - asc ile başla
        currentSort.field = field;
        currentSort.direction = 'asc';
      }

      // Aktif sort varsa header'ı işaretle
      if (currentSort.field && currentSort.direction) {
        const activeHeader = document.querySelector(`th.sortable[data-sort="${currentSort.field}"]`);
        if (activeHeader) {
          activeHeader.classList.add(currentSort.direction);
        }
      }

      // Tabloyu güncelle
      applyFilters();
    }

    // Yardımcı fonksiyonlar
    function getInitials(adi, soyadi) {
      const a = (adi || '').charAt(0).toUpperCase();
      const s = (soyadi || '').charAt(0).toUpperCase();
      return a + s || '??';
    }

    function getAvatarColor(id) {
      const colors = ['avatar-emerald', 'avatar-cyan', 'avatar-violet', 'avatar-amber', 'avatar-rose'];
      return colors[id % colors.length];
    }

    function getRolBadge(anaYoneticimi, yetkiAdi) {
      // AnaYoneticimi = 0 ise Ana Yönetici
      if (anaYoneticimi === 0) {
        return '<span class="badge badge-danger">Ana Yönetici</span>';
      }
      // Yetki adı varsa onu göster
      if (yetkiAdi) {
        return `<span class="badge badge-info">${yetkiAdi}</span>`;
      }
      return '<span class="badge badge-secondary">Tanımsız</span>';
    }

    function getRolText(anaYoneticimi, yetkiAdi) {
      if (anaYoneticimi === 0) return 'Ana Yönetici';
      return yetkiAdi || 'Çalışan';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('tr-TR');
    }

    function formatPhone(phone) {
      if (!phone) return '-';
      return phone.replace(/(\d{4})(\d{3})(\d{4})/, '$1 $2 $3');
    }

    // Yetki değişiklik takip sistemi

    // Yetki değişikliği olduğunda
    function onPermissionChange(employeeId, newPermissionId, employeeName, dropdown) {
      newPermissionId = newPermissionId ? parseInt(newPermissionId) : null;
      const employee = kullanicilarCache.find(k => k.id === employeeId);

      if (!employee) return;

      const originalPermissionId = employee.muhasebeYetkiId || null;

      // Eğer aynı yetkiye geri döndüyse, bekleyen değişikliği kaldır
      if (originalPermissionId === newPermissionId) {
        delete pendingPermissionChanges[employeeId];
      } else {
        // Yeni değişikliği kaydet
        const newPermission = yetkilerCache ? yetkilerCache.find(y => y.id === newPermissionId) : null;
        pendingPermissionChanges[employeeId] = {
          employeeId,
          employeeName,
          oldPermissionId: originalPermissionId,
          newPermissionId,
          newPermissionName: newPermission?.yetkiAdi || 'Yetki Seçilmedi'
        };
      }

      // Dropdown stilini güncelle
      if (dropdown) {
        dropdown.classList.toggle('changed', !!pendingPermissionChanges[employeeId]);
      }

      // Floating box'ı güncelle
      updateFloatingActionBox();
    }

    // Floating action box'ı güncelle
    function updateFloatingActionBox() {
      const floatingBox = document.getElementById('floatingActionBox');
      const changeCount = Object.keys(pendingPermissionChanges).length;

      if (changeCount > 0) {
        floatingBox.classList.add('active');
        document.getElementById('fabCount').textContent = changeCount;

        // Değişiklik listesini oluştur
        const changesList = Object.values(pendingPermissionChanges)
          .map(c => `${c.employeeName} → ${c.newPermissionName}`)
          .join('<br>');

        document.getElementById('fabChangesList').innerHTML = changesList;
      } else {
        floatingBox.classList.remove('active');
      }
    }

    // Tüm değişiklikleri uygula
    async function applyAllChanges() {
      const changes = Object.values(pendingPermissionChanges);

      if (changes.length === 0) return;

      if (!confirm(`${changes.length} çalışanın yetkisi değiştirilecek. Onaylıyor musunuz?`)) return;

      try {
        // Her değişiklik için API çağrısı yap
        for (const change of changes) {
          if (change.newPermissionId) {
            await apiPut(`kullanicilar/${change.employeeId}/permission`, {
              yetkiId: change.newPermissionId
            });
          }
        }

        // Başarılı mesajı göster
        showToast(`${changes.length} çalışanın yetkisi başarıyla güncellendi`, 'success');

        // Temizle ve yenile
        pendingPermissionChanges = {};
        updateFloatingActionBox();

        // Verileri yeniden yükle
        await loadKullanicilar();
      } catch (error) {
        console.error('Permission update error:', error);
        showToast('Yetkiler güncellenirken hata oluştu: ' + error.message, 'error');
      }
    }

    // Tüm değişiklikleri iptal et
    function cancelAllChanges() {
      if (Object.keys(pendingPermissionChanges).length === 0) return;

      // Dropdown'ları orijinal değerlerine döndür
      Object.keys(pendingPermissionChanges).forEach(employeeId => {
        const dropdown = document.querySelector(`.permission-dropdown[data-employee-id="${employeeId}"]`);
        if (dropdown) {
          const originalValue = dropdown.dataset.original || '';
          const employee = kullanicilarCache.find(k => k.id == employeeId);
          const originalYetkiAdi = employee?.yetkiAdi || 'Yetki Seçiniz';

          // Text'i güncelle
          dropdown.querySelector('.dropdown-text').textContent = originalYetkiAdi;

          // Selected class'ı güncelle
          dropdown.querySelectorAll('.dropdown-item').forEach(item => {
            item.classList.toggle('selected', item.dataset.value == originalValue);
          });

          dropdown.classList.remove('changed');
        }
      });

      pendingPermissionChanges = {};
      updateFloatingActionBox();
      showToast('Değişiklikler iptal edildi', 'info');
    }

    // Çalışan kartına git
    function goToEmployeeCard(id) {
      window.location.href = `detail.html?id=${id}`;
    }

    function activateKullanici(id) {
      console.log('Aktif yap:', id);
      // TODO: Kullanıcıyı aktif yap
    }

    function openAddEmployeeModal() {
      document.getElementById('addEmployeeModal').style.display = 'flex';
    }

    function closeAddEmployeeModal() {
      document.getElementById('addEmployeeModal').style.display = 'none';
    }
  </script>
  <script src="../../components/sidebar.js"></script>
</body>
</html>
