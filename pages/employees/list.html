<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Çalışan Listesi - IHSAN AI</title>
  <link rel="stylesheet" href="../../assets/css/main.css">
  <style>
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-backdrop .modal {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      max-width: 90vw;
      max-height: 90vh;
      overflow: hidden;
      animation: modalIn 0.2s ease-out;
    }
    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Modern Dropdown Styles - Tüm select'ler için */
    .form-select,
    .permission-select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding: 0.625rem 2.25rem 0.625rem 0.875rem;
      border: 1px solid var(--border-default);
      border-radius: 0.5rem;
      background-color: var(--bg-surface);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px;
      color: var(--text-primary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 140px;
    }
    .form-select:hover,
    .permission-select:hover {
      border-color: var(--border-hover, #4b5563);
      background-color: var(--bg-elevated);
    }
    .form-select:focus,
    .permission-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      background-color: var(--bg-surface);
    }
    .form-select option,
    .permission-select option {
      padding: 0.5rem;
      background: var(--bg-surface);
      color: var(--text-primary);
    }

    /* Tablo içi permission select - daha kompakt */
    .permission-select {
      padding: 0.5rem 2rem 0.5rem 0.75rem;
      font-size: 0.8125rem;
      min-width: 150px;
      max-width: 170px;
      background-color: rgba(99, 102, 241, 0.05);
      border-color: rgba(99, 102, 241, 0.2);
    }
    .permission-select:hover {
      background-color: rgba(99, 102, 241, 0.1);
      border-color: rgba(99, 102, 241, 0.3);
    }
    .permission-select:focus {
      background-color: rgba(99, 102, 241, 0.08);
    }

    /* Değişiklik yapılmış dropdown */
    .permission-select.changed {
      border-color: #f59e0b;
      background-color: rgba(245, 158, 11, 0.1);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f59e0b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
    }
    .permission-select.changed:hover {
      border-color: #d97706;
      background-color: rgba(245, 158, 11, 0.15);
    }

    /* Filtre satırı stili */
    .filters-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .filters-row .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    .filters-row .search-icon {
      position: absolute;
      left: 0.875rem;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: var(--text-muted);
      pointer-events: none;
    }
    .filters-row .search-input {
      width: 100%;
      padding-left: 2.75rem;
    }

    /* Filtre dropdown'ları */
    .filter-select {
      flex-shrink: 0;
      min-width: 160px;
      background-color: var(--bg-elevated);
    }
    .filter-select:hover {
      background-color: var(--bg-overlay);
    }

    /* Floating Action Box */
    .floating-action-box {
      position: fixed;
      right: -320px;
      top: 50%;
      transform: translateY(-50%);
      width: 280px;
      background: #1a1b23;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-right: none;
      border-radius: 16px 0 0 16px;
      padding: 1.5rem;
      z-index: 1000;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: -8px 0 32px rgba(0, 0, 0, 0.4);
    }
    .floating-action-box.active {
      right: 0;
    }
    .fab-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1.25rem;
    }
    .fab-count {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }
    .fab-count span {
      font-size: 2.5rem;
      font-weight: 800;
      color: #fff;
      line-height: 1;
      letter-spacing: -0.02em;
    }
    .fab-count small {
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 500;
    }
    .fab-close {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      transition: all 0.15s ease;
    }
    .fab-close:hover {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }
    .fab-stats {
      margin-bottom: 1.25rem;
      padding: 1rem;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(99, 102, 241, 0.15);
    }
    .fab-stat {
      text-align: center;
    }
    .fab-stat-value {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: #a5b4fc;
      max-height: 80px;
      overflow-y: auto;
      text-align: left;
    }
    .fab-stat-label {
      display: block;
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }
    .fab-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .fab-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
    }
    .fab-btn svg {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
    }
    .fab-btn-primary {
      background: #10b981;
      color: #fff;
    }
    .fab-btn-primary:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    .fab-btn-outline {
      background: transparent;
      color: #9ca3af;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .fab-btn-outline:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="../../logo.png" alt="IHSAN AI" onerror="this.style.display='none'; this.parentElement.innerHTML='IA';">
        </div>
        <div class="sidebar-brand">
          <h1>IHSAN AI</h1>
          <span>Sigorta Yönetimi</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Ana Menü</div>
          <div class="nav-item">
            <a href="../../index.html" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
              </svg>
              <span class="nav-text">Dashboard</span>
            </a>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Poliçe İşlemleri</div>
          <div class="nav-item has-submenu">
            <a href="#" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10,9 9,9 8,9"/>
              </svg>
              <span class="nav-text">Poliçeler</span>
              <svg class="nav-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
              </svg>
            </a>
            <div class="nav-submenu">
              <a href="../policies/my-policies.html" class="nav-link"><span class="nav-text">Poliçelerim</span></a>
              <a href="../policies/captured.html" class="nav-link"><span class="nav-text">Yakalanan Poliçeler</span></a>
              <a href="../policies/pool.html" class="nav-link"><span class="nav-text">Poliçe Havuzu</span></a>
              <a href="../policies/add-manual.html" class="nav-link"><span class="nav-text">Manuel Ekle</span></a>
              <a href="../policies/bulk-import.html" class="nav-link"><span class="nav-text">Toplu Aktar</span></a>
            </div>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Yönetim</div>
          <div class="nav-item has-submenu open">
            <a href="#" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                <path d="M16 3.13a4 4 0 010 7.75"/>
              </svg>
              <span class="nav-text">Çalışanlarım</span>
              <svg class="nav-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
              </svg>
            </a>
            <div class="nav-submenu">
              <a href="list.html" class="nav-link active"><span class="nav-text">Çalışan Listesi</span></a>
              <a href="performance.html" class="nav-link"><span class="nav-text">Performans</span></a>
              <a href="tracking.html" class="nav-link"><span class="nav-text">Takip / Hakediş</span></a>
              <a href="commission.html" class="nav-link"><span class="nav-text">Komisyon Ayarları</span></a>
            </div>
          </div>
          <div class="nav-item has-submenu">
            <a href="#" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              <span class="nav-text">Müşterilerimiz</span>
              <svg class="nav-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
              </svg>
            </a>
            <div class="nav-submenu">
              <a href="../customers/list.html" class="nav-link"><span class="nav-text">Müşteri Listesi</span></a>
              <a href="../customers/detail.html" class="nav-link"><span class="nav-text">Müşteri Detay</span></a>
              <a href="../customers/renewals.html" class="nav-link"><span class="nav-text">Yenileme Takibi</span></a>
            </div>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Finans</div>
          <div class="nav-item has-submenu">
            <a href="#" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
              </svg>
              <span class="nav-text">Finans</span>
              <svg class="nav-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
              </svg>
            </a>
            <div class="nav-submenu">
              <a href="../finance/dashboard.html" class="nav-link"><span class="nav-text">Finansal Özet</span></a>
              <a href="../finance/policies.html" class="nav-link"><span class="nav-text">Poliçe Bazlı</span></a>
              <a href="../finance/collections.html" class="nav-link"><span class="nav-text">Tahsilat Takibi</span></a>
              <a href="../finance/reports.html" class="nav-link"><span class="nav-text">Raporlar</span></a>
            </div>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Sistem</div>
          <div class="nav-item has-submenu">
            <a href="#" class="nav-link">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
              </svg>
              <span class="nav-text">Ayarlar</span>
              <svg class="nav-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
              </svg>
            </a>
            <div class="nav-submenu">
              <a href="../settings/permissions.html" class="nav-link"><span class="nav-text">Yetki Yönetimi</span></a>
              <a href="../settings/agency-codes.html" class="nav-link"><span class="nav-text">Acente Kodları</span></a>
              <a href="../settings/report-settings.html" class="nav-link"><span class="nav-text">Rapor Ayarları</span></a>
            </div>
          </div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="sidebar-toggle" onclick="document.getElementById('sidebar').classList.toggle('collapsed')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="11,17 6,12 11,7"/>
            <polyline points="18,17 13,12 18,7"/>
          </svg>
          <span class="nav-text">Daralt</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <nav class="navbar">
        <div class="navbar-left">
          <div class="navbar-breadcrumb">
            <span class="breadcrumb-item">Yönetim</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Çalışan Listesi</span>
          </div>
        </div>
        <div class="navbar-right">
          <button class="navbar-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 01-3.46 0"/>
            </svg>
            <span class="badge">3</span>
          </button>
          <div class="navbar-divider"></div>
          <div class="navbar-user">
            <div class="navbar-avatar">AY</div>
            <div class="navbar-user-info">
              <div class="navbar-user-name">Ahmet Yılmaz</div>
              <div class="navbar-user-role">Ana Yönetici</div>
            </div>
          </div>
        </div>
      </nav>

      <!-- Page Wrapper -->
      <div class="page-wrapper">
        <div class="page-content">
        <div class="page-header">
          <div>
            <h1 class="page-title">Çalışan Listesi</h1>
            <p class="page-subtitle">Ekibinizdeki tüm çalışanları yönetin ve takip edin.</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Dışa Aktar
            </button>
            <button class="btn btn-primary" onclick="openAddEmployeeModal()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Yeni Çalışan
            </button>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card stat-cyan">
            <div class="stat-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                <path d="M16 3.13a4 4 0 010 7.75"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statTotal">-</div>
              <div class="stat-label">Toplam Çalışan</div>
            </div>
          </div>

          <div class="stat-card stat-emerald">
            <div class="stat-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                <polyline points="22,4 12,14.01 9,11.01"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statActive">-</div>
              <div class="stat-label">Aktif Çalışan</div>
            </div>
          </div>

          <div class="stat-card stat-amber">
            <div class="stat-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12,6 12,12 16,14"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statInactive">-</div>
              <div class="stat-label">Pasif Çalışan</div>
            </div>
          </div>

          <div class="stat-card stat-violet">
            <div class="stat-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statPerformance">-</div>
              <div class="stat-label">Ort. Performans</div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="card" style="margin-bottom: 1.5rem;">
          <div class="card-body">
            <div class="filters-row">
              <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" class="form-input search-input" placeholder="Çalışan ara (isim, e-posta, telefon)...">
              </div>
              <select class="form-select filter-select" id="durumFilter">
                <option value="">Tüm Durumlar</option>
                <option value="active">Aktif</option>
                <option value="inactive">Pasif</option>
              </select>
              <select class="form-select filter-select" id="yetkiFilter">
                <option value="">Tüm Yetkiler</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Employee Table -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Çalışanlar</h3>
            <div class="card-actions">
              <span class="text-muted">8 çalışan listeleniyor</span>
            </div>
          </div>
          <div class="card-body" style="padding: 0;">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Çalışan</th>
                    <th>E-posta</th>
                    <th>Telefon</th>
                    <th>Yetki</th>
                    <th>Durum</th>
                    <th>Poliçe</th>
                    <th>Performans</th>
                    <th>Kayıt Tarihi</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="employeeTableBody">
                  <!-- Veriler JavaScript ile yüklenecek -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Floating Action Box for Permission Changes -->
  <div class="floating-action-box" id="floatingActionBox">
    <div class="fab-header">
      <div class="fab-count">
        <span id="fabCount">0</span>
        <small>değişiklik yapıldı</small>
      </div>
      <button class="fab-close" onclick="cancelAllChanges()" title="İptal Et">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="fab-stats">
      <div class="fab-stat">
        <span class="fab-stat-value" id="fabChangesList"></span>
        <span class="fab-stat-label">Değiştirilecek Yetkiler</span>
      </div>
    </div>
    <div class="fab-actions">
      <button class="fab-btn fab-btn-primary" onclick="applyAllChanges()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        Değişiklikleri Uygula
      </button>
      <button class="fab-btn fab-btn-outline" onclick="cancelAllChanges()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
          <path d="M3 3v5h5"/>
        </svg>
        İptal Et
      </button>
    </div>
  </div>

  <!-- Add Employee Modal -->
  <div class="modal-backdrop" id="addEmployeeModal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Yeni Çalışan Ekle</h3>
        <button class="modal-close" onclick="closeAddEmployeeModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="addEmployeeForm">
          <div class="form-grid-2">
            <div class="form-group">
              <label class="form-label">Ad Soyad</label>
              <input type="text" class="form-input" placeholder="Çalışan adı soyadı" required>
            </div>
            <div class="form-group">
              <label class="form-label">E-posta</label>
              <input type="email" class="form-input" placeholder="ornek@ihsanai.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Telefon</label>
              <input type="tel" class="form-input" placeholder="0532 123 4567">
            </div>
            <div class="form-group">
              <label class="form-label">Yetki</label>
              <select class="form-select" required>
                <option value="">Seçiniz</option>
                <option value="admin">Yönetici</option>
                <option value="agent">Acente</option>
                <option value="intern">Stajyer</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Notlar</label>
            <textarea class="form-textarea" placeholder="Çalışan hakkında ek notlar..." rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddEmployeeModal()">İptal</button>
        <button class="btn btn-primary">Çalışan Ekle</button>
      </div>
    </div>
  </div>

  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/app.js"></script>
  <script>
    // Global değişkenler
    let yetkilerCache = null;
    let kullanicilarCache = [];
    let pendingPermissionChanges = {};

    // Sayfa yüklendiğinde önce yetkileri sonra çalışanları getir
    document.addEventListener('DOMContentLoaded', async function() {
      await loadYetkiler(); // Önce yetkiler yüklensin
      await loadKullanicilar(); // Sonra çalışanlar
    });

    // Kullanıcı bilgisinden FirmaId al
    function getCurrentFirmaId() {
      const user = APP_CONFIG.AUTH.getUser();
      return user?.firmaId || null;
    }

    // Yetkileri API'den yükle (filtre ve dropdown için)
    async function loadYetkiler() {
      const firmaId = getCurrentFirmaId();
      const select = document.getElementById('yetkiFilter');

      try {
        const yetkiler = await apiGet('permissions', firmaId ? { firmaId } : {});
        yetkilerCache = yetkiler; // Cache'e kaydet

        // Filtre dropdown'ı doldur
        yetkiler.forEach(y => {
          const option = document.createElement('option');
          option.value = y.id;
          option.textContent = y.yetkiAdi;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Yetkiler yüklenirken hata:', error);
      }
    }

    // Kullanıcıları API'den yükle
    async function loadKullanicilar() {
      const tbody = document.getElementById('employeeTableBody');
      const firmaId = getCurrentFirmaId();

      if (!firmaId) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Firma bilgisi bulunamadı. Lütfen giriş yapın.</td></tr>';
        return;
      }

      tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Yükleniyor...</td></tr>';

      try {
        const kullanicilar = await apiGet('kullanicilar', { firmaId: firmaId });
        kullanicilarCache = kullanicilar; // Cache'e kaydet
        renderKullanicilar(kullanicilar);
        updateStats(kullanicilar);
      } catch (error) {
        console.error('Kullanıcılar yüklenirken hata:', error);
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Veriler yüklenirken hata oluştu.</td></tr>';
      }
    }

    // Kullanıcıları tabloya render et
    function renderKullanicilar(kullanicilar) {
      const tbody = document.getElementById('employeeTableBody');
      const countEl = document.querySelector('.card-actions .text-muted');

      if (!kullanicilar || kullanicilar.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Henüz çalışan bulunmuyor.</td></tr>';
        if (countEl) countEl.textContent = '0 çalışan listeleniyor';
        return;
      }

      if (countEl) countEl.textContent = `${kullanicilar.length} çalışan listeleniyor`;

      // Yetki dropdown seçeneklerini oluştur
      const yetkiOptions = yetkilerCache ? yetkilerCache.map(y =>
        `<option value="${y.id}">${y.yetkiAdi}</option>`
      ).join('') : '<option value="">Yükleniyor...</option>';

      tbody.innerHTML = kullanicilar.map(k => {
        const isActive = k.onay === 1;
        const initials = getInitials(k.adi, k.soyadi);
        const avatarColor = getAvatarColor(k.id);
        const durumBadge = isActive
          ? '<span class="badge badge-success">Aktif</span>'
          : '<span class="badge badge-secondary">Pasif</span>';
        const kayitTarihi = formatDate(k.kayitTarihi);
        const telefon = formatPhone(k.gsmNo);
        const rowClass = isActive ? '' : 'row-inactive';
        const avatarStyle = isActive
          ? `avatar avatar-md ${avatarColor}`
          : 'avatar avatar-md" style="background: var(--bg-elevated); color: var(--text-muted);';

        // Ana yönetici için dropdown gösterme
        const isAnaYonetici = k.anaYoneticimi === 0;
        const yetkiCell = isAnaYonetici
          ? '<span class="badge badge-danger">Ana Yönetici</span>'
          : (isActive
            ? `<select class="permission-select" data-employee-id="${k.id}" data-original="${k.muhasebeYetkiId || ''}" onchange="onPermissionChange(${k.id}, this.value, '${(k.adi || '').replace(/'/g, "\\'")} ${(k.soyadi || '').replace(/'/g, "\\'")}')">
                <option value="">Yetki Seçiniz</option>
                ${yetkiOptions}
              </select>`
            : '<span class="badge badge-secondary">-</span>');

        return `
          <tr class="${rowClass}" data-employee-id="${k.id}">
            <td>
              <div class="flex items-center gap-3">
                <div class="${avatarStyle}">${initials}</div>
                <div>
                  <div class="font-semibold ${isActive ? '' : 'text-muted'}">${k.adi || ''} ${k.soyadi || ''}</div>
                  <div class="text-muted text-sm">${getRolText(k.anaYoneticimi, k.yetkiAdi)}</div>
                </div>
              </div>
            </td>
            <td class="${isActive ? '' : 'text-muted'}">${k.email || '-'}</td>
            <td class="font-mono ${isActive ? '' : 'text-muted'}">${telefon}</td>
            <td>${yetkiCell}</td>
            <td>${durumBadge}</td>
            <td class="font-semibold font-mono ${isActive ? '' : 'text-muted'}">-</td>
            <td><span class="text-muted">-</span></td>
            <td class="text-muted">${kayitTarihi}</td>
            <td>
              <div class="action-buttons">
                ${isActive ? `
                  <button class="btn-icon" title="Karta Git" onclick="goToEmployeeCard(${k.id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                    </svg>
                  </button>
                ` : `
                  <button class="btn-icon" title="Aktif Yap" onclick="activateKullanici(${k.id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                  </button>
                `}
              </div>
            </td>
          </tr>
        `;
      }).join('');

      // Dropdown'lardaki mevcut yetkileri seç
      kullanicilar.forEach(k => {
        if (k.muhasebeYetkiId) {
          const select = document.querySelector(`select[data-employee-id="${k.id}"]`);
          if (select) {
            select.value = k.muhasebeYetkiId;
          }
        }
      });
    }


    // İstatistikleri güncelle
    function updateStats(kullanicilar) {
      const total = kullanicilar.length;
      const active = kullanicilar.filter(k => k.onay === 1).length;
      const inactive = total - active;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statActive').textContent = active;
      document.getElementById('statInactive').textContent = inactive;
      document.getElementById('statPerformance').textContent = '-';
    }

    // Yardımcı fonksiyonlar
    function getInitials(adi, soyadi) {
      const a = (adi || '').charAt(0).toUpperCase();
      const s = (soyadi || '').charAt(0).toUpperCase();
      return a + s || '??';
    }

    function getAvatarColor(id) {
      const colors = ['avatar-emerald', 'avatar-cyan', 'avatar-violet', 'avatar-amber', 'avatar-rose'];
      return colors[id % colors.length];
    }

    function getRolBadge(anaYoneticimi, yetkiAdi) {
      // AnaYoneticimi = 0 ise Ana Yönetici
      if (anaYoneticimi === 0) {
        return '<span class="badge badge-danger">Ana Yönetici</span>';
      }
      // Yetki adı varsa onu göster
      if (yetkiAdi) {
        return `<span class="badge badge-info">${yetkiAdi}</span>`;
      }
      return '<span class="badge badge-secondary">Tanımsız</span>';
    }

    function getRolText(anaYoneticimi, yetkiAdi) {
      if (anaYoneticimi === 0) return 'Ana Yönetici';
      return yetkiAdi || 'Çalışan';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('tr-TR');
    }

    function formatPhone(phone) {
      if (!phone) return '-';
      return phone.replace(/(\d{4})(\d{3})(\d{4})/, '$1 $2 $3');
    }

    // Yetki değişiklik takip sistemi

    // Yetki değişikliği olduğunda
    function onPermissionChange(employeeId, newPermissionId, employeeName) {
      newPermissionId = newPermissionId ? parseInt(newPermissionId) : null;
      const employee = kullanicilarCache.find(k => k.id === employeeId);

      if (!employee) return;

      const originalPermissionId = employee.muhasebeYetkiId || null;

      // Eğer aynı yetkiye geri döndüyse, bekleyen değişikliği kaldır
      if (originalPermissionId === newPermissionId) {
        delete pendingPermissionChanges[employeeId];
      } else {
        // Yeni değişikliği kaydet
        const newPermission = yetkilerCache ? yetkilerCache.find(y => y.id === newPermissionId) : null;
        pendingPermissionChanges[employeeId] = {
          employeeId,
          employeeName,
          oldPermissionId: originalPermissionId,
          newPermissionId,
          newPermissionName: newPermission?.yetkiAdi || 'Yetki Seçilmedi'
        };
      }

      // Select stilini güncelle
      const select = document.querySelector(`select[data-employee-id="${employeeId}"]`);
      if (select) {
        select.classList.toggle('changed', !!pendingPermissionChanges[employeeId]);
      }

      // Floating box'ı güncelle
      updateFloatingActionBox();
    }

    // Floating action box'ı güncelle
    function updateFloatingActionBox() {
      const floatingBox = document.getElementById('floatingActionBox');
      const changeCount = Object.keys(pendingPermissionChanges).length;

      if (changeCount > 0) {
        floatingBox.classList.add('active');
        document.getElementById('fabCount').textContent = changeCount;

        // Değişiklik listesini oluştur
        const changesList = Object.values(pendingPermissionChanges)
          .map(c => `${c.employeeName} → ${c.newPermissionName}`)
          .join('<br>');

        document.getElementById('fabChangesList').innerHTML = changesList;
      } else {
        floatingBox.classList.remove('active');
      }
    }

    // Tüm değişiklikleri uygula
    async function applyAllChanges() {
      const changes = Object.values(pendingPermissionChanges);

      if (changes.length === 0) return;

      if (!confirm(`${changes.length} çalışanın yetkisi değiştirilecek. Onaylıyor musunuz?`)) return;

      try {
        // Her değişiklik için API çağrısı yap
        for (const change of changes) {
          if (change.newPermissionId) {
            await apiPut(`kullanicilar/${change.employeeId}/permission`, {
              yetkiId: change.newPermissionId
            });
          }
        }

        // Başarılı mesajı göster
        showToast(`${changes.length} çalışanın yetkisi başarıyla güncellendi`, 'success');

        // Temizle ve yenile
        pendingPermissionChanges = {};
        updateFloatingActionBox();

        // Verileri yeniden yükle
        await loadKullanicilar();
      } catch (error) {
        console.error('Permission update error:', error);
        showToast('Yetkiler güncellenirken hata oluştu: ' + error.message, 'error');
      }
    }

    // Tüm değişiklikleri iptal et
    function cancelAllChanges() {
      if (Object.keys(pendingPermissionChanges).length === 0) return;

      // Dropdown'ları orijinal değerlerine döndür
      Object.keys(pendingPermissionChanges).forEach(employeeId => {
        const select = document.querySelector(`select[data-employee-id="${employeeId}"]`);
        if (select) {
          const originalValue = select.dataset.original || '';
          select.value = originalValue;
          select.classList.remove('changed');
        }
      });

      pendingPermissionChanges = {};
      updateFloatingActionBox();
      showToast('Değişiklikler iptal edildi', 'info');
    }

    // Çalışan kartına git
    function goToEmployeeCard(id) {
      window.location.href = `detail.html?id=${id}`;
    }

    function activateKullanici(id) {
      console.log('Aktif yap:', id);
      // TODO: Kullanıcıyı aktif yap
    }

    function openAddEmployeeModal() {
      document.getElementById('addEmployeeModal').style.display = 'flex';
    }

    function closeAddEmployeeModal() {
      document.getElementById('addEmployeeModal').style.display = 'none';
    }
  </script>
</body>
</html>
