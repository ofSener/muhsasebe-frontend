<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Çalışan Performans - IHSAN AI</title>
  <link rel="stylesheet" href="../../assets/css/main.css">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
  <div class="gradient-mesh"></div>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar"></aside>

    <!-- Main Content -->
    <main class="main-content">
      <nav class="navbar">
        <div class="navbar-left">
          <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Menü">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </button>
          <div class="navbar-breadcrumb">
            <span class="breadcrumb-item">Yönetim</span>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Performans</span>
          </div>
        </div>
        <div class="navbar-right">
          <button class="navbar-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 01-3.46 0"/>
            </svg>
            <span class="badge">3</span>
          </button>
          <div class="navbar-divider"></div>
          <div class="navbar-user">
            <div class="navbar-avatar"></div>
            <div class="navbar-user-info">
              <div class="navbar-user-name">Yükleniyor...</div>
              <div class="navbar-user-role"></div>
            </div>
          </div>
        </div>
      </nav>

      <!-- Page Wrapper -->
      <div class="page-wrapper">
        <div class="page-content">
        <div class="page-header">
          <div>
            <h1 class="page-title">Performans Analizi</h1>
            <p class="page-subtitle">Çalışan performanslarını analiz edin ve karşılaştırın.</p>
          </div>
          <div class="page-actions">
            <select class="form-select" style="width: auto;">
              <option value="thisMonth">Bu Ay</option>
              <option value="lastMonth">Geçen Ay</option>
              <option value="thisQuarter">Bu Çeyrek</option>
              <option value="thisYear">Bu Yıl</option>
            </select>
            <button class="btn btn-secondary">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Rapor İndir
            </button>
          </div>
        </div>

        <!-- Top Performer Cards -->
        <div class="stats-grid" id="top-performers-container" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 1.5rem;">
          <!-- Skeleton Loading -->
          <div class="stat-card skeleton-card">
            <div class="stat-icon skeleton" style="width: 48px; height: 48px;"></div>
            <div class="stat-content">
              <div class="skeleton" style="width: 50px; height: 14px; margin-bottom: 8px;"></div>
              <div class="skeleton" style="width: 120px; height: 20px; margin-bottom: 8px;"></div>
              <div class="skeleton" style="width: 140px; height: 12px;"></div>
            </div>
          </div>
          <div class="stat-card skeleton-card">
            <div class="stat-icon skeleton" style="width: 48px; height: 48px;"></div>
            <div class="stat-content">
              <div class="skeleton" style="width: 50px; height: 14px; margin-bottom: 8px;"></div>
              <div class="skeleton" style="width: 120px; height: 20px; margin-bottom: 8px;"></div>
              <div class="skeleton" style="width: 140px; height: 12px;"></div>
            </div>
          </div>
          <div class="stat-card skeleton-card">
            <div class="stat-icon skeleton" style="width: 48px; height: 48px;"></div>
            <div class="stat-content">
              <div class="skeleton" style="width: 50px; height: 14px; margin-bottom: 8px;"></div>
              <div class="skeleton" style="width: 120px; height: 20px; margin-bottom: 8px;"></div>
              <div class="skeleton" style="width: 140px; height: 12px;"></div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="grid-2" style="margin-bottom: 1.5rem;">
          <!-- Bar Chart - Poliçe Sayısı -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Aylık Poliçe Üretimi</h3>
              <select class="form-select" style="width: auto; font-size: 0.8rem; padding: 0.4rem 0.6rem;">
                <option>Bu Ay vs Geçen Ay</option>
                <option>Bu Çeyrek</option>
              </select>
            </div>
            <div class="card-body">
              <div id="employee-bar-chart" style="height: 300px;"></div>
            </div>
          </div>

          <!-- Donut Chart - Tip Dağılımı -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Poliçe Tipi Dağılımı</h3>
              <select class="form-select" id="employeeSelect" style="width: auto; font-size: 0.8rem; padding: 0.4rem 0.6rem;">
                <option value="">Tüm Çalışanlar</option>
              </select>
            </div>
            <div class="card-body">
              <div id="policy-type-pie" style="height: 300px;"></div>
            </div>
          </div>
        </div>

        <!-- Trend Chart -->
        <div class="card" style="margin-bottom: 1.5rem;">
          <div class="card-header">
            <h3 class="card-title">Prim Üretimi Trendi</h3>
            <div class="flex gap-4">
              <label class="flex items-center gap-2" style="font-size: 0.85rem; cursor: pointer;">
                <input type="checkbox" checked style="accent-color: #10b981;">
                <span style="color: #10b981;">Brüt Prim</span>
              </label>
              <label class="flex items-center gap-2" style="font-size: 0.85rem; cursor: pointer;">
                <input type="checkbox" checked style="accent-color: #00d4ff;">
                <span style="color: #00d4ff;">Komisyon</span>
              </label>
            </div>
          </div>
          <div class="card-body">
            <div id="premium-trend" style="height: 320px;"></div>
          </div>
        </div>

        <!-- Performance Table -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Performans Karşılaştırması</h3>
            <div class="card-actions">
              <span class="text-muted" id="employee-count">Yükleniyor...</span>
            </div>
          </div>
          <div class="card-body" style="padding: 0;">
            <div class="table-container">
              <table class="data-table mobile-cards">
                <thead>
                  <tr>
                    <th>Çalışan</th>
                    <th>Poliçe</th>
                    <th>Prim</th>
                    <th>Komisyon</th>
                    <th>Ort. Prim</th>
                    <th>Hedef %</th>
                    <th>Sıralama</th>
                  </tr>
                </thead>
                <tbody id="performance-table-body">
                  <!-- Loading Skeleton -->
                  <tr class="skeleton-row">
                    <td><div class="skeleton" style="width: 150px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 40px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 80px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 70px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 60px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 120px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 40px; height: 20px;"></div></td>
                  </tr>
                  <tr class="skeleton-row">
                    <td><div class="skeleton" style="width: 150px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 40px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 80px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 70px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 60px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 120px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 40px; height: 20px;"></div></td>
                  </tr>
                  <tr class="skeleton-row">
                    <td><div class="skeleton" style="width: 150px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 40px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 80px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 70px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 60px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 120px; height: 20px;"></div></td>
                    <td><div class="skeleton" style="width: 40px; height: 20px;"></div></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/js/app.js"></script>
  <script src="../../assets/js/charts.js"></script>
  <style>
    /* Skeleton Loading Animation */
    .skeleton {
      background: linear-gradient(90deg, rgba(148, 163, 184, 0.1) 25%, rgba(148, 163, 184, 0.2) 50%, rgba(148, 163, 184, 0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 4px;
    }
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-card { opacity: 0.7; }
  </style>
  <script>
    // Chart instances (for updates)
    let barChart = null;
    let donutChart = null;
    let lineChart = null;

    // Madalya renkleri
    const medalStyles = [
      { bg: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)', color: '#000', icon: true },
      { bg: 'linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%)', color: '#000', icon: false },
      { bg: 'linear-gradient(135deg, #cd7f32 0%, #a0522d 100%)', color: '#fff', icon: false }
    ];

    // Avatar renkleri
    const avatarColors = ['emerald', 'cyan', 'violet', 'amber', 'rose', 'indigo', 'teal', 'pink'];

    // Kullanıcı bilgisinden firma ID'sini al
    function getCurrentFirmaId() {
      const user = APP_CONFIG.AUTH.getUser();
      return user?.firmaId || 1;
    }

    // Compact currency formatter for chart labels (K/M suffixes)
    function formatCurrencyShort(value) {
      if (!value || value === 0) return '₺0';

      if (value >= 1000000) {
        return '₺' + (value / 1000000).toFixed(1) + 'M';
      } else if (value >= 1000) {
        return '₺' + (value / 1000).toFixed(0) + 'K';
      }
      return '₺' + value.toFixed(0);
    }

    // Calculate date range based on period
    function getDateRange(period) {
      const now = new Date();
      let startDate, endDate;

      switch(period) {
        case 'thisMonth':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          break;
        case 'lastMonth':
          startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          endDate = new Date(now.getFullYear(), now.getMonth(), 0);
          break;
        case 'thisQuarter':
          const quarter = Math.floor(now.getMonth() / 3);
          startDate = new Date(now.getFullYear(), quarter * 3, 1);
          endDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
          break;
        case 'thisYear':
          startDate = new Date(now.getFullYear(), 0, 1);
          endDate = new Date(now.getFullYear(), 11, 31);
          break;
        default:
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      }

      // Format as YYYY-MM-DD for API
      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      return {
        startDate: formatDate(startDate),
        endDate: formatDate(endDate)
      };
    }

    // İsimden baş harfleri al
    function getInitials(name) {
      if (!name) return '??';
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    // Top Performers Kartlarını Render Et
    function renderTopPerformers(performers) {
      const container = document.getElementById('top-performers-container');
      if (!container || !performers || performers.length === 0) {
        container.innerHTML = '<div class="text-muted" style="grid-column: 1/-1; text-align: center; padding: 2rem;">Veri bulunamadı</div>';
        return;
      }

      const cardStyles = [
        { bg: 'linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%)', border: 'rgba(251, 191, 36, 0.3)', iconBg: 'rgba(251, 191, 36, 0.2)', iconColor: '#fbbf24' },
        { bg: 'linear-gradient(135deg, rgba(209, 213, 219, 0.15) 0%, rgba(156, 163, 175, 0.05) 100%)', border: 'rgba(156, 163, 175, 0.3)', iconBg: 'rgba(156, 163, 175, 0.2)', iconColor: '#9ca3af' },
        { bg: 'linear-gradient(135deg, rgba(205, 127, 50, 0.15) 0%, rgba(160, 82, 45, 0.05) 100%)', border: 'rgba(205, 127, 50, 0.3)', iconBg: 'rgba(205, 127, 50, 0.2)', iconColor: '#cd7f32' }
      ];

      container.innerHTML = performers.slice(0, 3).map((p, i) => {
        const style = cardStyles[i] || cardStyles[2];
        return `
          <div class="stat-card" style="background: ${style.bg}; border-color: ${style.border};">
            <div class="stat-icon" style="background: ${style.iconBg}; color: ${style.iconColor};">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">${i + 1}. Sıra</div>
              <div class="stat-value" style="font-size: 1.25rem;">${p.adSoyad || 'İsimsiz'}</div>
              <div class="text-muted" style="font-size: 0.8rem;">${p.policeSayisi || 0} Poliçe • ${formatCurrency(p.toplamBrutPrim || 0)} Prim</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Performans Tablosunu Render Et
    function renderPerformanceTable(performers) {
      const tbody = document.getElementById('performance-table-body');
      const countEl = document.getElementById('employee-count');

      if (!tbody) return;

      if (!performers || performers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted" style="padding: 2rem;">Veri bulunamadı</td></tr>';
        if (countEl) countEl.textContent = '0 çalışan';
        return;
      }

      if (countEl) countEl.textContent = `${performers.length} çalışan`;

      // En yüksek poliçe sayısını hedef olarak al (%100)
      const maxPolice = Math.max(...performers.map(p => p.policeSayisi || 0));

      tbody.innerHTML = performers.map((p, i) => {
        const initials = getInitials(p.adSoyad);
        const avatarColor = avatarColors[i % avatarColors.length];
        const avgPrim = p.policeSayisi > 0 ? Math.round((p.toplamBrutPrim || 0) / p.policeSayisi) : 0;
        const hedefYuzde = maxPolice > 0 ? Math.round((p.policeSayisi / maxPolice) * 100) : 0;

        // Progress bar rengi
        let progressClass = '';
        let textClass = '';
        if (hedefYuzde >= 90) { progressClass = 'emerald'; textClass = 'text-success'; }
        else if (hedefYuzde >= 70) { progressClass = 'cyan'; textClass = ''; }
        else if (hedefYuzde >= 50) { progressClass = 'amber'; textClass = 'text-warning'; }
        else { progressClass = 'rose'; textClass = 'text-danger'; }

        // Sıralama badge
        let rankBadge = '';
        if (i < 3) {
          const medal = medalStyles[i];
          const starIcon = medal.icon ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg>' : '';
          rankBadge = `<span class="badge" style="background: ${medal.bg}; color: ${medal.color};">${starIcon}${i + 1}.</span>`;
        } else {
          rankBadge = `<span class="badge badge-secondary">${i + 1}.</span>`;
        }

        return `
          <tr>
            <td>
              <div class="flex items-center gap-3">
                <div class="avatar avatar-sm avatar-${avatarColor}">${initials}</div>
                <span class="font-semibold">${p.adSoyad || 'İsimsiz'}</span>
              </div>
            </td>
            <td class="font-semibold font-mono">${p.policeSayisi || 0}</td>
            <td class="font-semibold font-mono">${formatCurrency(p.toplamBrutPrim || 0)}</td>
            <td class="font-semibold text-success font-mono">${formatCurrency(p.toplamKomisyon || 0)}</td>
            <td class="font-mono">${formatCurrency(avgPrim)}</td>
            <td>
              <div class="flex items-center gap-2">
                <div class="progress" style="width: 100px;">
                  <div class="progress-bar ${progressClass}" style="width: ${hedefYuzde}%"></div>
                </div>
                <span class="${textClass} font-semibold font-mono">${hedefYuzde}%</span>
              </div>
            </td>
            <td>${rankBadge}</td>
          </tr>
        `;
      }).join('');
    }

    // Çalışan filtre dropdown'ını güncelle
    function updateEmployeeSelect(performers) {
      const select = document.getElementById('employeeSelect');
      if (!select || !performers) return;

      select.innerHTML = '<option value="">Tüm Çalışanlar</option>' +
        performers.slice(0, 10).map(p => `<option value="${p.uyeId}">${p.adSoyad}</option>`).join('');
    }

    // Trend chart legend'ını güncelle
    function updateTrendLegend(performers) {
      const legendContainer = document.querySelector('.card-header .flex.gap-4');
      if (!legendContainer) return;

      // Sabit legend - Brüt Prim ve Komisyon
      const colors = [chartColors.success, chartColors.primary];
      const labels = ['Brüt Prim', 'Komisyon'];

      legendContainer.innerHTML = labels.map((label, i) => `
        <label class="flex items-center gap-2" style="font-size: 0.85rem; cursor: pointer;">
          <input type="checkbox" checked style="accent-color: ${colors[i]};">
          <span style="color: ${colors[i]};">${label}</span>
        </label>
      `).join('');
    }

    // API'den verileri yükle
    async function loadPerformanceData(dateRange = null) {
      const firmaId = getCurrentFirmaId();

      try {
        console.log('Loading performance data for firmaId:', firmaId, 'dateRange:', dateRange);

        // Build API parameters with optional date range
        const topPerformersParams = { firmaId, limit: 20, mode: 0 };
        const bransParams = { firmaId, mode: 0 };

        if (dateRange) {
          topPerformersParams.startDate = dateRange.startDate;
          topPerformersParams.endDate = dateRange.endDate;
          bransParams.startDate = dateRange.startDate;
          bransParams.endDate = dateRange.endDate;
        }

        // Paralel API çağrıları with proper parameters
        const [topPerformers, bransData, trendData] = await Promise.all([
          apiGet('dashboard/top-performers', topPerformersParams).catch(e => { console.error('Top performers error:', e); return { performers: [] }; }),
          apiGet('dashboard/brans-dagilim', bransParams).catch(e => { console.error('Brans error:', e); return { dagilim: [] }; }),
          apiGet('dashboard/aylik-trend', { firmaId, months: 12 }).catch(e => { console.error('Trend error:', e); return { trend: [] }; })
        ]);

        console.log('API Responses:', { topPerformers, bransData, trendData });

        // Flexible response parsing - handle both array and object responses
        const performers = Array.isArray(topPerformers)
          ? topPerformers
          : (topPerformers.performers || topPerformers.data || []);

        // 1. Top Performers kartlarını render et
        renderTopPerformers(performers);

        // 2. Performans tablosunu render et
        renderPerformanceTable(performers);

        // 3. Çalışan dropdown'ını güncelle
        updateEmployeeSelect(performers);

        // 4. Bar Chart - Çalışan bazlı poliçe üretimi (Enhanced)
        if (barChart) barChart.destroy();
        if (performers.length > 0) {
          const chartConfig = {
            series: [{
              name: 'Poliçe Sayısı',
              data: performers.slice(0, 6).map(p => p.policeSayisi || 0)
            }],
            chart: {
              type: 'bar',
              height: 300,
              toolbar: { show: false },
              fontFamily: 'Inter, system-ui, sans-serif'
            },
            plotOptions: {
              bar: {
                horizontal: false,
                columnWidth: '60%',
                borderRadius: 4,
                dataLabels: {
                  position: 'top'
                }
              }
            },
            dataLabels: {
              enabled: true,
              offsetY: -20,
              style: {
                fontSize: '12px',
                colors: ['#64748b']
              }
            },
            colors: ['#00d4ff'],
            xaxis: {
              categories: performers.slice(0, 6).map(p => {
                const name = p.adSoyad || 'N/A';
                const parts = name.split(' ');
                // Show first name + first letter of last name
                return parts.length > 1 ? `${parts[0]} ${parts[1][0]}.` : parts[0];
              }),
              labels: {
                style: {
                  fontSize: '11px',
                  fontWeight: 500
                }
              }
            },
            yaxis: {
              title: {
                text: 'Poliçe Sayısı',
                style: {
                  fontSize: '12px',
                  fontWeight: 600
                }
              },
              labels: {
                formatter: (val) => val.toFixed(0)
              }
            },
            tooltip: {
              custom: function({seriesIndex, dataPointIndex, w}) {
                const performer = performers[dataPointIndex];
                return `
                  <div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 200px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #1e293b;">
                      ${performer.adSoyad || 'N/A'}
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                      <span style="color: #64748b;">Poliçe:</span>
                      <span style="font-weight: 600;">${performer.policeSayisi || 0}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                      <span style="color: #64748b;">Prim:</span>
                      <span style="font-weight: 600;">${formatCurrency(performer.toplamBrutPrim || 0)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                      <span style="color: #64748b;">Komisyon:</span>
                      <span style="font-weight: 600; color: #10b981;">${formatCurrency(performer.toplamKomisyon || 0)}</span>
                    </div>
                  </div>
                `;
              }
            },
            grid: {
              borderColor: '#e2e8f0',
              strokeDashArray: 4
            }
          };

          barChart = new ApexCharts(document.querySelector('#employee-bar-chart'), chartConfig);
          barChart.render();
        }

        // 5. Donut Chart - Branş dağılımı (Enhanced)
        if (donutChart) donutChart.destroy();
        const bransItems = bransData.dagilim || [];
        console.log('Brans items:', bransItems);
        if (bransItems.length > 0) {
          const chartConfig = {
            series: bransItems.map(b => b.policeSayisi || 0),
            chart: {
              type: 'donut',
              height: 300,
              fontFamily: 'Inter, system-ui, sans-serif'
            },
            labels: bransItems.map(b => b.bransAdi || 'Diğer'),
            colors: ['#00d4ff', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'],
            legend: {
              position: 'bottom',
              fontSize: '11px'
            },
            plotOptions: {
              pie: {
                donut: {
                  size: '70%',
                  labels: {
                    show: true,
                    name: {
                      show: true,
                      fontSize: '14px',
                      fontWeight: 600
                    },
                    value: {
                      show: true,
                      fontSize: '20px',
                      fontWeight: 700,
                      formatter: (val) => val
                    },
                    total: {
                      show: true,
                      label: 'Toplam',
                      fontSize: '12px',
                      fontWeight: 600,
                      formatter: function (w) {
                        return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                      }
                    }
                  }
                }
              }
            },
            tooltip: {
              y: {
                formatter: function(val, opts) {
                  const brans = bransItems[opts.seriesIndex];
                  return `${val} poliçe - ${formatCurrency(brans.toplamBrutPrim || 0)}`;
                }
              }
            },
            responsive: [{
              breakpoint: 480,
              options: {
                chart: {
                  width: 280
                },
                legend: {
                  position: 'bottom',
                  fontSize: '10px'
                }
              }
            }]
          };

          donutChart = new ApexCharts(document.querySelector('#policy-type-pie'), chartConfig);
          donutChart.render();
        }

        // 6. Line Chart - Aylık trend (Enhanced)
        if (lineChart) lineChart.destroy();
        const trendItems = trendData.trend || [];
        console.log('Trend items:', trendItems);
        if (trendItems.length > 0) {
          const chartConfig = {
            series: [
              {
                name: 'Brüt Prim',
                data: trendItems.map(t => t.brutPrim || 0)
              },
              {
                name: 'Komisyon',
                data: trendItems.map(t => t.komisyon || 0)
              }
            ],
            chart: {
              type: 'line',
              height: 320,
              toolbar: { show: true },
              fontFamily: 'Inter, system-ui, sans-serif',
              zoom: { enabled: true }
            },
            colors: ['#10b981', '#00d4ff'],
            stroke: {
              curve: 'smooth',
              width: 3
            },
            dataLabels: {
              enabled: false
            },
            xaxis: {
              categories: trendItems.map(t => t.ay || ''),
              labels: {
                style: {
                  fontSize: '11px'
                }
              }
            },
            yaxis: {
              labels: {
                formatter: (val) => formatCurrencyShort(val),
                style: {
                  fontSize: '11px'
                }
              }
            },
            tooltip: {
              shared: true,
              intersect: false,
              y: {
                formatter: (val) => formatCurrency(val)
              }
            },
            legend: {
              position: 'top',
              horizontalAlign: 'right',
              fontSize: '12px',
              markers: {
                width: 10,
                height: 10,
                radius: 2
              }
            },
            grid: {
              borderColor: '#e2e8f0',
              strokeDashArray: 4,
              xaxis: {
                lines: { show: false }
              }
            }
          };

          lineChart = new ApexCharts(document.querySelector('#premium-trend'), chartConfig);
          lineChart.render();
        }

        console.log('Performance data loaded successfully');

      } catch (error) {
        console.error('Performance data load error:', error);
        showToast('Veriler yüklenirken hata oluştu', 'error');
      }
    }

    // Sayfa yüklendiğinde
    document.addEventListener('DOMContentLoaded', function() {
      loadPerformanceData();

      // Date range filter event listener
      const dateRangeSelect = document.querySelector('.page-actions select.form-select');
      if (dateRangeSelect) {
        dateRangeSelect.addEventListener('change', function(e) {
          const period = e.target.value;
          const dateRange = getDateRange(period);
          console.log('Date range changed:', period, dateRange);

          // Show loading state
          const skeletons = document.querySelectorAll('.skeleton-card, .skeleton-row');
          skeletons.forEach(s => s.style.display = '');

          // Reload data with new date range
          loadPerformanceData(dateRange);
        });
      }
    });
  </script>
  <script src="../../components/sidebar.js"></script>
</body>
</html>
